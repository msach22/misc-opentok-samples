/*
  OpenTok JavaScript Library @version@
 http://www.tokbox.com/

 Copyright (c) 2014 TokBox, Inc.

 Date: @build_time@
  Common JS Helpers on OpenTok 0.2.0 24638ec master
 http://www.tokbox.com/

 Copyright (c) 2014 TokBox, Inc.

 Date: May 07 11:08:58 2014

*/
(function(d){d.OT||(d.OT={});OT.properties={version:"@version@",build:"@build_revision@",debug:"@chef_start@ @debug @chef_end@",websiteURL:"@chef_start@ @website_url @chef_end@",cdnURL:"@chef_start@ @cdn_url @chef_end@",loggingURL:"@chef_start@ @logging_url @chef_end@",apiURL:"@chef_start@ @api_url @chef_end@",messagingProtocol:"wss",messagingPort:443,supportSSL:"@chef_start@ @support_ssl @chef_end@",cdnURLSSL:"@chef_start@ @ssl_widget_url @chef_end@",loggingURLSSL:"@chef_start@ @logging_url_ssl @chef_end@",
apiURLSSL:"@chef_start@ @api_url_ssl @chef_end@",minimumVersion:{firefox:parseFloat("@minimum_firefox_version@"),chrome:parseFloat("@minimum_chrome_version@")}}})(window);
!function(d,a){var g=function(a){return document.getElementById(a)},f=d.OTHelpers;d.OTHelpers=g;g.keys=Object.keys||function(a){var b=[],c=Object.prototype.hasOwnProperty,e;for(e in a)c.call(a,e)&&b.push(e);return b};var c=Array.prototype.forEach||function(a,b){for(var c=0,e=this.length||0;c<e;++c)c in this&&a.call(b,this[c],c)};g.forEach=function(a,b,e){return c.call(a,b,e)};var b=Array.prototype.map||function(a,b){var e=[];c.call(this,function(c,h){e.push(a.call(b,c,h))});return e};g.map=function(a,
c){return b.call(a,c)};var e=Array.prototype.filter||function(a,b){var e=[];c.call(this,function(c,h){a.call(b,c,h)&&e.push(c)});return e};g.filter=function(a,b,c){return e.call(a,b,c)};var k=Array.prototype.some||function(a,b){for(var c=!1,e=0,h=this.length||0;e<h;++e)if(e in this&&a.call(b,this[e],e)){c=!0;break}return c};g.some=function(a,b,c){return k.call(a,b,c)};var h=Array.prototype.indexOf||function(a,b){var c;c=b?b:0;var e;if(!this)throw new TypeError;e=this.length;if(0===e||c>=e)return-1;
for(0>c&&(c=e-Math.abs(c));c<e;c++)if(this[c]===a)return c;return-1};g.arrayIndexOf=function(a,b,c){return h.call(a,b,c)};var l=Function.prototype.bind||function(){var a=Array.prototype.slice.call(arguments),b=a.shift(),c=this;return function(){return c.apply(b,a.concat(Array.prototype.slice.call(arguments)))}};g.bind=function(){var a=Array.prototype.slice.call(arguments),b=a.shift();return l.apply(b,a)};var n=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};g.trim=function(a){return n.call(a)};
g.noConflict=function(){g.noConflict=function(){return g};d.OTHelpers=f;return g};g.isNone=function(b){return b===a||null===b};g.isObject=function(a){return a===Object(a)};g.isFunction=function(a){return!!a&&(-1!==a.toString().indexOf("()")||"[object Function]"===Object.prototype.toString.call(a))};g.isArray=g.isFunction(Array.isArray)&&Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};g.isEmpty=function(b){if(null===b||b===a)return!0;if(g.isArray(b)||"string"===
typeof b)return 0===b.length;for(var c in b)if(b.hasOwnProperty(c))return!1;return!0};g.extend=function(){var a=Array.prototype.slice.call(arguments),b=a.shift();g.forEach(a,function(a){for(var c in a)b[c]=a[c]});return b};g.defaults=function(){var a=Array.prototype.slice.call(arguments),b=a.shift();g.forEach(a,function(a){for(var c in a)void 0===b[c]&&(b[c]=a[c])});return b};g.clone=function(a){return!g.isObject(a)?a:g.isArray(a)?a.slice():g.extend({},a)};g.noop=function(){};g.supportsWebSockets=
function(){return"WebSocket"in d};g.now=function(){var a=d.performance||{},b,c=a.now||a.mozNow||a.msNow||a.oNow||a.webkitNow;return c?(c=g.bind(c,a),b=a.timing.navigationStart,function(){return b+c()}):function(){return(new Date).getTime()}}();var m=function(){var a=d.navigator.userAgent.toLowerCase(),b=d.navigator.appName,c,e="unknown",h=-1;if(-1<a.indexOf("opera")||-1<a.indexOf("opr"))e="Opera",null!==/opr\/([0-9]{1,}[\.0-9]{0,})/.exec(a)&&(h=parseFloat(RegExp.$1));else if(-1<a.indexOf("firefox"))e=
"Firefox",null!==/firefox\/([0-9]{1,}[\.0-9]{0,})/.exec(a)&&(h=parseFloat(RegExp.$1));else if("Microsoft Internet Explorer"===b)e="IE",null!==/msie ([0-9]{1,}[\.0-9]{0,})/.exec(a)&&(h=parseFloat(RegExp.$1));else if("Netscape"===b&&-1<a.indexOf("trident"))e="IE",null!==/trident\/.*rv:([0-9]{1,}[\.0-9]{0,})/.exec(a)&&(h=parseFloat(RegExp.$1));else if(-1<a.indexOf("chrome"))e="Chrome",null!==/chrome\/([0-9]{1,}[\.0-9]{0,})/.exec(a)&&(h=parseFloat(RegExp.$1));else if((c=d.navigator.vendor)&&-1<c.toLowerCase().indexOf("apple"))e=
"Safari",null!==/version\/([0-9]{1,}[\.0-9]{0,})/.exec(a)&&(h=parseFloat(RegExp.$1));return{browser:e,version:h,iframeNeedsLoad:0>a.indexOf("webkit")}}();g.browser=function(){return m.browser};g.browserVersion=function(){return m};g.canDefineProperty=!0;try{Object.defineProperty({},"x",{})}catch(q){g.canDefineProperty=!1}g.defineGetters=function(a,b,c){var e={};void 0===c&&(c=!1);for(var h in b)e[h]={get:b[h],enumerable:c};g.defineProperties(a,e)};var r=function(a,b,c){return b&&!c?function(){return b.call(a)}:
b&&c?function(e){void 0!==e&&c.call(a,e);return b.call(a)}:function(b){void 0!==b&&c.call(a,b)}};g.defineProperties=function(a,b){for(var c in b)a[c]=r(a,b[c].get,b[c].set)};Object.create||(Object.create=function(a){function b(){}if(1<arguments.length)throw Error("Object.create implementation only accepts the first parameter.");b.prototype=a;return new b});g.setCookie=function(a,b){try{localStorage.setItem(a,b)}catch(c){var e=new Date;e.setTime(e.getTime()+31536E6);e="; expires\x3d"+e.toGMTString();
document.cookie=a+"\x3d"+b+e+"; path\x3d/"}};g.getCookie=function(a){var b;try{return b=localStorage.getItem("opentok_client_id")}catch(c){a+="\x3d";for(var e=document.cookie.split(";"),h=0;h<e.length;h++){for(var k=e[h];" "===k.charAt(0);)k=k.substring(1,k.length);0===k.indexOf(a)&&(b=k.substring(a.length,k.length))}if(b)return b}return null};g.invert=function(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[a[c]]=c);return b};var s={escape:{"\x26":"\x26amp;","\x3c":"\x26lt;","\x3e":"\x26gt;",'"':"\x26quot;",
"'":"\x26#x27;","/":"\x26#x2F;"}};s.unescape=g.invert(s.escape);var p={escape:RegExp("["+g.keys(s.escape).join("")+"]","g"),unescape:RegExp("("+g.keys(s.unescape).join("|")+")","g")};g.forEach(["escape","unescape"],function(b){g[b]=function(c){return null===c||c===a?"":(""+c).replace(p[b],function(a){return s[b][a]})}});g.templateSettings={evaluate:/<%%([\s\S]+?)%>/g,interpolate:/<%%=([\s\S]+?)%>/g,escape:/<%%-([\s\S]+?)%>/g};var t=/(.)^/,v={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028",
"\u2029":"u2029"},u=/\\|'|\r|\n|\t|\u2028|\u2029/g;g.template=function(a,b,c){var e;c=g.defaults({},c,g.templateSettings);var h=RegExp([(c.escape||t).source,(c.interpolate||t).source,(c.evaluate||t).source].join("|")+"|$","g"),k=0,l="__p+\x3d'";a.replace(h,function(b,c,e,h,f){l+=a.slice(k,f).replace(u,function(a){return"\\"+v[a]});c&&(l+="'+\n((__t\x3d("+c+"))\x3d\x3dnull?'':OTHelpers.escape(__t))+\n'");e&&(l+="'+\n((__t\x3d("+e+"))\x3d\x3dnull?'':__t)+\n'");h&&(l+="';\n"+h+"\n__p+\x3d'");k=f+b.length;
return b});l+="';\n";c.variable||(l="with(obj||{}){\n"+l+"}\n");l="var __t,__p\x3d'',__j\x3dArray.prototype.join,print\x3dfunction(){__p+\x3d__j.call(arguments,'');};\n"+l+"return __p;\n";try{e=new Function(c.variable||"obj",l)}catch(f){throw f.source=l,f;}if(b)return e(b);b=function(a){return e.call(this,a)};b.source="function("+(c.variable||"obj")+"){\n"+l+"}";return b}}(window);
(function(d,a,g){a.statable=function(f,c,b,e,k){var h,l=f.currentState=b;f.is=function(){return-1!==a.arrayIndexOf(arguments,l)};f.isNot=function(){return-1===a.arrayIndexOf(arguments,l)};return function(b){l!==b&&(-1===a.arrayIndexOf(c,b)?k&&a.isFunction(k)&&k("invalidState",b):(f.previousState=h=l,f.currentState=l=b,e&&a.isFunction(e)&&e(b,h)))}}})(window,window.OTHelpers);
(function(d,a,g){function f(a,b){var c=b||0,e=n;return e[a[c++]]+e[a[c++]]+e[a[c++]]+e[a[c++]]+"-"+e[a[c++]]+e[a[c++]]+"-"+e[a[c++]]+e[a[c++]]+"-"+e[a[c++]]+e[a[c++]]+"-"+e[a[c++]]+e[a[c++]]+e[a[c++]]+e[a[c++]]+e[a[c++]]+e[a[c++]]}function c(a,b,c){c=b&&c||0;"string"==typeof a&&(b="binary"==a?new l(16):null,a=null);a=a||{};a=a.random||(a.rng||h)();a[6]=a[6]&15|64;a[8]=a[8]&63|128;if(b)for(var e=0;16>e;e++)b[c+e]=a[e];return b||f(a)}var b,e=Array(16);g=function(){for(var a,b=0,b=0;16>b;b++)0===(b&
3)&&(a=4294967296*Math.random()),e[b]=a>>>((b&3)<<3)&255;return e};if(d.crypto&&crypto.getRandomValues){var k=new Uint32Array(4);b=function(){crypto.getRandomValues(k);for(var a=0;16>a;a++)e[a]=k[a>>2]>>>8*(a&3)&255;return e}}var h=b||g,l="function"==typeof Buffer?Buffer:Array,n=[],m={};for(d=0;256>d;d++)n[d]=(d+256).toString(16).substr(1),m[n[d]]=d;c.v4=c;c.parse=function(a,b,c){var e=b&&c||0,h=0;b=b||[];for(a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){16>h&&(b[e+h++]=m[a])});16>h;)b[e+h++]=
0;return b};c.unparse=f;c.BufferClass=l;c.mathRNG=g;c.whatwgRNG=b;a.uuid=c})(window,window.OTHelpers);
(function(d,a,g){a.useLogHelpers=function(f){function c(a,c,e){return function(){if(f.shouldLog(c)){var h=d.console,m=g(arguments);if(h&&h[a])if(h[a].apply||n)h[a].apply||(h[a]=Function.prototype.bind.call(h[a],h)),h[a].apply(h,m);else h[a](m);else if(e){e.apply(f,m);return}if(h=g(arguments))h=k(h),2>=h.length||l.push([a,b(),h])}}}function b(){var a=new Date;return a.toLocaleTimeString()+a.getMilliseconds()}function e(a){try{return JSON.stringify(a)}catch(b){return a.toString()}}function k(b){var c=
[];if("undefined"!==typeof b)if(null===b)c.push("NULL");else if(a.isArray(b))for(var h=0;h<b.length;++h)c.push(e(b[h]));else if(a.isObject(b))for(h in b){var k;a.isFunction(b[h])?b.hasOwnProperty(h)&&(k="function "+h+"()"):k=e(b[h]);c.push(h+": "+k)}else if(a.isFunction(b))try{c.push(b.toString())}catch(l){c.push("function()")}else c.push(b.toString());return c.join(", ")}f.DEBUG=5;f.LOG=4;f.INFO=3;f.WARN=2;f.ERROR=1;f.NONE=0;var h=f.NONE,l=[],n=!0;try{Function.prototype.bind.call(d.console.log,d.console)}catch(m){n=
!1}var g=function(a){return a};"IE"===a.browser()&&(g=function(a){return[k(Array.prototype.slice.apply(a))]});f.log=c("log",f.LOG);f.debug=c("debug",f.DEBUG,f.log);f.info=c("info",f.INFO,f.log);f.warn=c("warn",f.WARN,f.log);f.error=c("error",f.ERROR,f.log);f.setLogLevel=function(a){h="number"===typeof a?a:0;f.debug("TB.setLogLevel("+h+")");return h};f.getLogs=function(){return l};f.shouldLog=function(a){return h>=a}};a.useLogHelpers(a);a.setLogLevel(a.ERROR)})(window,window.OTHelpers);
(function(d,a,g){a.castToBoolean=function(a,c){return a===g?c:"true"===a||!0===a};a.roundFloat=function(a,c){return Number(a.toFixed(c))}})(window,window.OTHelpers);
(function(d,a,g){var f=[],c="OTHelpers."+a.uuid.v4()+".zero-timeout";g=function(b){b.data===c&&(a.isFunction(b.stopPropagation)&&b.stopPropagation(),b.cancelBubble=!0,0<f.length&&(b=f.shift(),b.shift().apply(null,b)))};d.addEventListener?d.addEventListener("message",g,!0):d.attachEvent&&d.attachEvent("onmessage",g);a.callAsync=function(){f.push(Array.prototype.slice.call(arguments));d.postMessage(c,"*")};a.createAsyncHandler=function(b){return function(){var c=Array.prototype.slice.call(arguments);
a.callAsync(function(){b.apply(null,c)})}}})(window,window.OTHelpers);
(function(d,a,g){a.eventing=function(f,c){function b(b,c,e){var h=k[b];if(h&&0!==h.length){var l=h.length;a.forEach(h,function(h){function f(a){return a.context===h.context&&a.handler===h.handler}a.callAsync(function(){try{k[b]&&a.some(k[b],f)&&(h.closure||h.handler).apply(h.context||null,c)}finally{l--,0===l&&e&&e.apply(null,c.slice())}})})}}function e(b,c){var e=k[b];e&&0!==e.length&&a.forEach(e,function(a){(a.closure||a.handler).apply(a.context||null,c)})}var k={},h=!0===c?e:b,l=function(b,c){k[b]&&
(c?k[b]=a.filter(k[b],function(a){return a.context!==c}):delete k[b])},d=a.bind(function(b,c,e,h){var l={handler:c};e&&(l.context=e);h&&(l.closure=h);a.forEach(b,function(a){k[a]||(k[a]=[]);k[a].push(l)})},f),m=function(b,c,e){function h(a){return!(a.handler===c&&a.context===e)}a.forEach(b,a.bind(function(b){k[b]&&(k[b]=a.filter(k[b],h),0===k[b].length&&delete k[b])},f))};f.dispatchEvent=function(b,c){if(!b.type)throw a.error("OTHelpers.Eventing.dispatchEvent: Event has no type"),a.error(b),Error("OTHelpers.Eventing.dispatchEvent: Event has no type");
b.target||(b.target=this);if(!k[b.type]||0===k[b.type].length){var e=[b];c&&c.apply(null,e.slice())}else return h(b.type,[b],c),this};f.trigger=function(a){if(k[a]&&0!==k[a].length){var b=Array.prototype.slice.call(arguments);b.shift();h(a,b);return this}};f.on=function(a,b,c){if("string"===typeof a&&b)d(a.split(" "),b,c);else for(var e in a)a.hasOwnProperty(e)&&d([e],a[e],b);return this};f.off=function(b,c,e){if("string"===typeof b)c&&a.isFunction(c)?m(b.split(" "),c,e):a.forEach(b.split(" "),function(a){l(a,
c)},this);else if(b)for(var h in b)b.hasOwnProperty(h)&&m([h],b[h],c);else k={};return this};f.once=function(b,c,e){var h=b.split(" ");b=a.bind(function(){var a=c.apply(e||null,arguments);m(h,c,e);return a},this);d(h,c,e,b);return this};f.addEventListener=function(b,c,e){a.warn("The addEventListener() method is deprecated. Use on() or once() instead.");d([b],c,e)};f.removeEventListener=function(b,c,e){a.warn("The removeEventListener() method is deprecated. Use off() instead.");m([b],c,e)};return f};
a.eventing.Event=function(){return function(f,c){this.type=f;this.cancelable=c!==g?c:!0;var b=!1;this.preventDefault=function(){this.cancelable?b=!0:a.warn("Event.preventDefault :: Trying to preventDefault on an Event that isn't cancelable")};this.isDefaultPrevented=function(){return b}}}})(window,window.OTHelpers);
(function(d,a,g){function f(a){for(var b in a)if(a.hasOwnProperty(b))return!0;return!1}a.isElementNode=function(a){return a&&"object"===typeof a&&1==a.nodeType};a.supportsClassList=function(){var c=typeof("undefined"!==document)&&"classList"in document.createElement("a");a.supportsClassList=function(){return c};return c};a.removeElement=function(a){a&&a.parentNode&&a.parentNode.removeChild(a)};a.removeElementById=function(c){this.removeElement(a(c))};a.removeElementsByType=function(a,b){if(a)for(var e=
a.getElementsByTagName(b);e.length;)a.removeChild(e[0])};a.emptyElement=function(a){for(;a.firstChild;)a.removeChild(a.firstChild);return a};a.createElement=function(c,b,e,k){var h=(k||document).createElement(c);if(b)for(var l in b)if("object"===typeof b[l]){h[l]||(h[l]={});c=b[l];for(var f in c)h[l][f]=c[f]}else"className"===l?h.className=b[l]:h.setAttribute(l,b[l]);b=function(a){"string"===typeof a?h.innerHTML+=a:h.appendChild(a)};a.isArray(e)?a.forEach(e,b):e&&b(e);return h};a.createButton=function(c,
b,e){c=a.createElement("button",b,c);if(e){for(var k in e)if(e.hasOwnProperty(k))a.on(c,k,e[k]);c._boundEvents=e}return c};a.on=function(a,b,e){if(a.addEventListener)a.addEventListener(b,e,!1);else if(a.attachEvent)a.attachEvent("on"+b,e);else{var k=a["on"+b];a["on"+b]=function(){e.apply(this,arguments);k&&k.apply(this,arguments)}}return a};a.off=function(a,b,e){a.removeEventListener?a.removeEventListener(b,e,!1):a.detachEvent&&a.detachEvent("on"+b,e)};a.isDisplayNone=function(c){return(0===c.offsetWidth||
0===c.offsetHeight)&&"none"===a.css(c,"display")?!0:c.parentNode&&c.parentNode.style?a.isDisplayNone(c.parentNode):!1};a.findElementWithDisplayNone=function(c){return(0===c.offsetWidth||0===c.offsetHeight)&&"none"===a.css(c,"display")?c:c.parentNode&&c.parentNode.style?a.findElementWithDisplayNone(c.parentNode):null};a.observeStyleChanges=function(c,b,e){var k={},h=function(b){switch(b){case "width":return a.width(c);case "height":return a.height(c);default:return a.css(c)}};a.forEach(b,function(a){k[a]=
h(a)});var l=new MutationObserver(function(l){var d={};a.forEach(l,function(e){if("style"===e.attributeName){var l=a.isDisplayNone(c);a.forEach(b,function(a){if(!l||!("width"==a||"height"==a)){var b=h(a);b!==k[a]&&(d[a]=[k[a],b],k[a]=b)}})}});f(d)&&a.callAsync(function(){e.call(null,d)})});l.observe(c,{attributes:!0,attributeFilter:["style"],childList:!1,characterData:!1,subtree:!1});return l};a.observeNodeOrChildNodeRemoval=function(c,b){var e=new MutationObserver(function(c){var e=[];a.forEach(c,
function(a){a.removedNodes.length&&(e=e.concat(Array.prototype.slice.call(a.removedNodes)))});e.length&&a.callAsync(function(){b(e)})});e.observe(c,{attributes:!1,childList:!0,characterData:!1,subtree:!0});return e}})(window,window.OTHelpers);
(function(d,a,g){a.Modal=function(f){a.eventing(this,!0);var c=arguments[arguments.length-1];if(!a.isFunction(c))throw Error("OTHelpers.Modal2 must be given a callback");2>arguments.length&&(f={});var b=document.createElement("iframe");b.id=f.id||a.uuid();b.style.position="absolute";b.style.position="fixed";b.style.height="100%";b.style.width="100%";b.style.top="0px";b.style.left="0px";b.style.right="0px";b.style.bottom="0px";b.style.zIndex=1E3;b.style.border="0";try{b.style.backgroundColor="rgba(0,0,0,0.2)"}catch(e){b.style.backgroundColor=
"transparent",b.setAttribute("allowTransparency","true")}b.scrolling="no";b.setAttribute("scrolling","no");var k=function(){var a=b.contentDocument||b.contentWindow.document;a.body.style.backgroundColor="transparent";a.body.style.border="none";c(b.contentWindow,a)};document.body.appendChild(b);if(a.browserVersion().iframeNeedsLoad)a.on(b,"load",k);else setTimeout(k);this.close=function(){a.removeElement(b);this.trigger("closed");b=null;return this}}})(window,window.OTHelpers);
(function(d,a,g){function f(a,b,c,l){var d=b[c];b=parseFloat(d);d=d.split(/\d/)[0];l=null!=l?l:/%|em/.test(d)&&a.parentElement?f(a.parentElement,a.parentElement.currentStyle,"fontSize",null):16;a="fontSize"===c?l:/width/i.test(c)?a.clientWidth:a.clientHeight;return"em"===d?b*l:"in"===d?96*b:"pt"===d?96*b/72:"%"===d?b/100*a:b}function c(a,b){var c="border"===b?"Width":"",l=b+"Top"+c,d=b+"Right"+c,f=b+"Bottom"+c,c=b+"Left"+c;a[b]=(a[l]===a[d]===a[f]===a[c]?[a[l]]:a[l]===a[f]&&a[c]===a[d]?[a[l],a[d]]:
a[c]===a[d]?[a[l],a[d],a[f]]:[a[l],a[d],a[f],a[c]]).join(" ")}function b(a){var b=a.currentStyle,h=f(a,b,"fontSize",null),l;for(l in b)/width|height|margin.|padding.|border.+W/.test(l)&&"auto"!==this[l]?this[l]=f(a,b,l,h)+"px":"styleFloat"===l?this["float"]=b[l]:this[l]=b[l];c(this,"margin");c(this,"padding");c(this,"border");this.fontSize=h+"px";return this}b.prototype={constructor:b,getPropertyPriority:function(){},getPropertyValue:function(a){return this[a]||""},item:function(){},removeProperty:function(){},
setProperty:function(){},getPropertyCSSValue:function(){}};a.getComputedStyle=function(a){return a&&a.ownerDocument&&a.ownerDocument.defaultView&&a.ownerDocument.defaultView.getComputedStyle?a.ownerDocument.defaultView.getComputedStyle(a):new b(a)}})(window,window.OTHelpers);
(function(d,a,g){a.addClass=function(c,b){if(1===c.nodeType){var e=a.trim(b).split(/\s+/),d,h;if(a.supportsClassList()){d=0;for(h=e.length;d<h;++d)c.classList.add(e[d])}else{if(!c.className&&1===e.length)c.className=b;else{var l=" "+c.className+" ";d=0;for(h=e.length;d<h;++d)~l.indexOf(" "+e[d]+" ")||(l+=e[d]+" ");c.className=a.trim(l)}return this}}};a.removeClass=function(c,b){if(b&&1===c.nodeType){var e=a.trim(b).split(/\s+/),d,h;if(a.supportsClassList()){d=0;for(h=e.length;d<h;++d)c.classList.remove(e[d])}else{var l=
(" "+c.className+" ").replace(/[\s+]/," ");d=0;for(h=e.length;d<h;++d)l=l.replace(" "+e[d]+" "," ");c.className=a.trim(l);return this}}};var f=function(c){return 0<c.offsetHeight?c.offsetHeight+"px":a.css(c,"height")};a.width=function(c,b){return b?(a.css(c,"width",b),this):a.isDisplayNone(c)?a.makeVisibleAndYield(c,function(){return 0<c.offsetWidth?c.offsetWidth+"px":a.css(c,"width")}):0<c.offsetWidth?c.offsetWidth+"px":a.css(c,"width")};a.height=function(c,b){return b?(a.css(c,"height",b),this):
a.isDisplayNone(c)?a.makeVisibleAndYield(c,function(){return f(c)}):f(c)};a.centerElement=function(c,b,e){b||(b=parseInt(a.width(c),10));e||(e=parseInt(a.height(c),10));a.css(c,"margin",-0.5*e+"px 0 0 "+(-0.5*b+"px"));a.addClass(c,"OT_centered")}})(window,window.OTHelpers);
(function(d,a,g){var f={},c={};a.show=function(b){var e=b.style.display;if(""===e||"none"===e)b.style.display=f[b]||"",delete f[b];if("none"===a.getComputedStyle(b).getPropertyValue("display")){f[b]="none";e=b.style;if(c[b.ownerDocument]&&c[b.ownerDocument][b.nodeName])b=c[b.ownerDocument][b.nodeName];else{c[b.ownerDocument]||(c[b.ownerDocument]={});var d=b.ownerDocument.createElement(b.nodeName);b.ownerDocument.body.appendChild(d);b=c[b.ownerDocument][b.nodeName]=a.css(d,"display");a.removeElement(d)}e.display=
b}return this};a.hide=function(a){if("none"!==a.style.display)return f[a]=a.style.display,a.style.display="none",this};a.css=function(b,c,d){if("string"!==typeof c){b=b.style;for(var h in c)b[h]=c[h];return this}if(d!==g)return b.style[c]=d,this;c=c.replace(/([A-Z]|^ms)/g,"-$1").toLowerCase();h=a.getComputedStyle(b).getPropertyValue(c);""===h&&(h=b.style[c]);return h};a.applyCSS=function(b,c,d){var h={},l;for(l in c)c.hasOwnProperty(l)&&(h[l]=b.style[l],a.css(b,l,c[l]));d=d();for(l in c)c.hasOwnProperty(l)&&
a.css(b,l,h[l]||"");return d};a.makeVisibleAndYield=function(b,c){var d=a.findElementWithDisplayNone(b);if(d)return a.applyCSS(d,{display:"block",visibility:"hidden"},c)}})(window,window.OTHelpers);
(function(d,a,g){function f(a){if("string"===typeof a)return a;var b=[],e;for(e in a)b.push(encodeURIComponent(e)+"\x3d"+encodeURIComponent(a[e]));return b.join("\x26").replace(/\+/g,"%20")}a.getJSON=function(c,b,e){b=b||{};var d=function(a,b){if(a)e(a,b&&b.target&&b.target.responseText);else{var c;try{c=JSON.parse(b.target.responseText)}catch(h){e(h,b&&b.target&&b.target.responseText);return}e(null,c,b)}};if(b.xdomainrequest)a.xdomainRequest(c,{method:"GET"},d);else{var h=a.extend({Accept:"application/json"},
b.headers||{});a.get(c,a.extend(b||{},{headers:h}),d)}};a.xdomainRequest=function(a,b,e){function d(a,b){h.onload=h.onerror=h.ontimeout=function(){};h=void 0;e(a,b)}var h=new XDomainRequest,l=(b||{}).method;l?(l=l.toUpperCase(),"GET"===l||"POST"===l?(h.onload=function(){d(null,{target:{responseText:h.responseText,headers:{"content-type":h.contentType}}})},h.onerror=function(){d(Error("XDomainRequest of "+a+" failed"))},h.ontimeout=function(){d(Error("XDomainRequest of "+a+" timed out"))},h.open(l,
a),h.send(b.body&&f(b.body))):e(Error("HTTP method can only be "))):e(Error("No HTTP method specified in options"))};a.request=function(a,b,e){var d=new XMLHttpRequest,h=b||{};if(h.method){e&&(d.addEventListener("load",function(a){var b=a.target.status;200<=b&&300>b||304===b?e(null,a):e(a)},!1),d.addEventListener("error",e,!1));d.open(b.method,a,!0);h.headers||(h.headers={});for(var l in h.headers)d.setRequestHeader(l,h.headers[l]);d.send(b.body&&f(b.body))}else e(Error("No HTTP method specified in options"))};
a.get=function(c,b,e){b=a.extend(b||{},{method:"GET"});a.request(c,b,e)};a.post=function(c,b,e){b=a.extend(b||{},{method:"POST"});b.xdomainrequest?a.xdomainRequest(c,b,e):a.request(c,b,e)}})(window,window.OTHelpers);
!function(){OT.Dialogs={};var d=function(a,c,b){a=a.head||a.getElementsByTagName("head")[0];var e=OT.$.createElement("link",{type:"text/css",media:"screen",rel:"stylesheet",href:c});a.appendChild(e);OT.$.on(e,"error",function(a){OT.error("Could not load CSS for dialog",c,a&&a.message||a)});OT.$.on(e,"load",b)},a=function(a,c,b){c=["//fonts.googleapis.com/css?family\x3dDidact+Gothic",OT.properties.cssURL].concat(c);var e=c.length;OT.$.forEach(c,function(c){d(a,c,function(){0>=--e&&b()})})},g=function(a,
c,b){a=OT.$.createElement(b||"div",{"class":a},c,this);a.on=OT.$.bind(OT.$.on,OT.$,a);return a};OT.Dialogs.AllowDeny={};OT.Dialogs.AllowDeny.Chrome={};OT.Dialogs.AllowDeny.Firefox={};OT.Dialogs.AllowDeny.Chrome.initialPrompt=function(){var d=new OT.$.Modal(function(c,b){var e=g.bind(b),k,h;k=e("OT_closeButton","\x26times;").on("click",function(){d.close()});h=e("OT_root OT_dialog OT_dialog-allow-deny-chrome-first",[k,e("OT_dialog-messages",[e("OT_dialog-messages-main","Allow camera and mic access"),
e("OT_dialog-messages-minor","Click the Allow button in the upper-right corner of your browser to enable real-time communication."),e("OT_dialog-allow-highlight-chrome")])]);a(b,[],function(){b.body.appendChild(h)})});return d};OT.Dialogs.AllowDeny.Chrome.previouslyDenied=function(d){var c=new OT.$.Modal(function(b,e){var k=g.bind(e),h,l;h=k("OT_closeButton","\x26times;").on("click",function(){c.close()});l=k("OT_root OT_dialog OT_dialog-allow-deny-chrome-pre-denied",[h,k("OT_dialog-messages",[k("OT_dialog-messages-main",
"Allow camera and mic access"),k("OT_dialog-messages-minor",["To interact with this app, follow these 3 steps:",k("OT_dialog-3steps",[k("OT_dialog-3steps-step",[k("OT_dialog-3steps-step-num","1"),"Find this icon in the URL bar and click it",k("OT_dialog-allow-camera-icon")]),k("OT_dialog-3steps-seperator"),k("OT_dialog-3steps-step",[k("OT_dialog-3steps-step-num","2"),'Select "Ask if '+d+' wants to access your camera and mic" and then click Done.']),k("OT_dialog-3steps-seperator"),k("OT_dialog-3steps-step",
[k("OT_dialog-3steps-step-num","3"),"Refresh your browser."])])])])]);a(e,[],function(){e.body.appendChild(l)})});return c};OT.Dialogs.AllowDeny.Chrome.deniedNow=function(){return new OT.$.Modal(function(d,c){var b=g.bind(c),e;e=b("OT_root OT_dialog-blackout",b("OT_dialog OT_dialog-allow-deny-chrome-now-denied",[b("OT_dialog-messages",[b("OT_dialog-messages-main ",b("OT_dialog-allow-camera-icon")),b("OT_dialog-messages-minor","Find \x26 click this icon to allow camera and mic access.")])]));a(c,[],
function(){c.body.appendChild(e)})})};OT.Dialogs.AllowDeny.Firefox.maybeDenied=function(){var d=new OT.$.Modal(function(c,b){var e=g.bind(b),k,h;k=e("OT_closeButton","\x26times;").on("click",function(){d.close()});h=e("OT_root OT_dialog OT_dialog-allow-deny-firefox-maybe-denied",[k,e("OT_dialog-messages",[e("OT_dialog-messages-main","Please allow camera \x26 mic access"),e("OT_dialog-messages-minor",["To interact with this app, follow these 3 steps:",e("OT_dialog-3steps",[e("OT_dialog-3steps-step",
[e("OT_dialog-3steps-step-num","1"),"Reload the page, or click the camera icon in the browser URL bar."]),e("OT_dialog-3steps-seperator"),e("OT_dialog-3steps-step",[e("OT_dialog-3steps-step-num","2"),"In the menu, select your camera \x26 mic."]),e("OT_dialog-3steps-seperator"),e("OT_dialog-3steps-step",[e("OT_dialog-3steps-step-num","3"),'Click "Share Selected Devices."'])])])])]);a(b,[],function(){b.body.appendChild(h)})});return d};OT.Dialogs.AllowDeny.Firefox.denied=function(){var d=new OT.$.Modal(function(c,
b){var e=g.bind(b),k,h;h=g.bind(b,"OT_dialog-button OT_dialog-button-large")("Reload").on("click",function(){d.trigger("refresh")});k=e("OT_root OT_dialog-blackout",e("OT_dialog OT_dialog-allow-deny-firefox-denied",[e("OT_dialog-messages",[e("OT_dialog-messages-minor","Access to camera and microphone has been denied. Click the button to reload page.")]),e("OT_dialog-single-button",h)]));a(b,[],function(){b.body.appendChild(k)})});return d}}();
!function(d){d.OT||(d.OT={});OT.$=OTHelpers.noConflict();OT.$.eventing(OT);OT.$.defineGetters=function(a,c,b){var e={};void 0===b&&(b=!1);for(var d in c)c.hasOwnProperty(d)&&(e[d]={get:c[d],enumerable:b});Object.defineProperties(a,e)};OT.Modal=OT.$.Modal;OT.$.useLogHelpers(OT);var a=!1,g=OT.setLogLevel;OT.setLogLevel=function(d){OT.$.setLogLevel(d);d=g.call(OT,d);OT.shouldLog(OT.DEBUG)&&!a&&(OT.debug("OpenTok JavaScript library "+OT.properties.version),OT.debug("Release notes: "+OT.properties.websiteURL+
"/opentok/webrtc/docs/js/release-notes.html"),OT.debug("Known issues: "+OT.properties.websiteURL+"/opentok/webrtc/docs/js/release-notes.html#knownIssues"),a=!0);OT.debug("OT.setLogLevel("+d+")");return d};OT.setLogLevel(OT.properties.debug?OT.DEBUG:OT.ERROR)}(window);
!function(d){d.OT||(d.OT={});if(!OT.properties)throw Error("OT.properties does not exist, please ensure that you include a valid properties file.");var a=OT,g=OT.properties,f=OT.$.clone(g);f.debug="true"===g.debug||!0===g.debug;f.supportSSL="true"===g.supportSSL||!0===g.supportSSL;f.supportSSL&&(0<=d.location.protocol.indexOf("https")||0<=d.location.protocol.indexOf("chrome-extension"))?(f.assetURL=f.cdnURLSSL+"/webrtc/"+f.version,f.loggingURL=f.loggingURLSSL):f.assetURL=f.cdnURL+"/webrtc/"+f.version;
f.configURL=f.assetURL+"/js/dynamic_config.min.js";f.cssURL=f.assetURL+"/css/ot.min.css";a.properties=f}(window);
!function(){OT.Config=function(){var d=!1,a={},g={},f,c=document.head||document.getElementsByTagName("head")[0],b,e=function(){b&&(clearTimeout(b),b=null);f&&(f.onload=f.onreadystatechange=null,c&&f.parentNode&&c.removeChild(f),f=void 0)},k=function(){if(!f.readyState||/loaded|complete/.test(f.readyState))b&&(clearTimeout(b),b=null),d||h._onLoadTimeout()},h;h={loadTimeout:4E3,load:function(a){if(!a)throw Error("You must pass a valid configUrl to Config.load");d=!1;setTimeout(function(){f=document.createElement("script");
f.async="async";f.src=a;f.onload=f.onreadystatechange=k.bind(this);c.appendChild(f)},1);b=setTimeout(function(){h._onLoadTimeout()},this.loadTimeout)},_onLoadTimeout:function(){e();OT.warn("TB DynamicConfig failed to load in "+h.loadTimeout+" ms");this.trigger("dynamicConfigLoadFailed")},isLoaded:function(){return d},reset:function(){e();d=!1;a={};g={}},replaceWith:function(b){e();b||(b={});a=b.global||{};g=b.partners||{};d||(d=!0);this.trigger("dynamicConfigChanged")},get:function(b,c,e){b=e&&g[e]&&
g[e][b]?g[e][b]:a[b];return b?b[c]:null}};OT.$.eventing(h);return h}()}(window);
!function(){function d(a,b,c,e,d){b=b?parseInt(b,10):parseInt(OT.$.width(a.parentNode),10);c=c?parseInt(c,10):parseInt(OT.$.height(a.parentNode),10);if(!(0===b||0===c))if(e||(e=g),c=(b+0)/c,b={width:"100%",height:"100%",left:0,top:0},c>e?(e=100*(c/e),b.height=e+"%",b.top="-"+(e-100)/2+"%"):c<e&&(e=100*(e/c),b.width=e+"%",b.left="-"+(e-100)/2+"%"),OT.$.css(a,b),e=a.querySelector("video"))d?(d=a.offsetWidth,a=a.offsetHeight,b=d-a,b={width:a+"px",height:d+"px",marginTop:-(b/2)+"px",marginLeft:b/2+"px"},
OT.$.css(e,b)):OT.$.css(e,{width:"",height:"",marginTop:"",marginLeft:""})}function a(a,d,k){d=parseInt(d,10);k=parseInt(k,10);d<b||k<e?OT.$.addClass(a,"OT_micro"):OT.$.removeClass(a,"OT_micro");d<f||k<c?OT.$.addClass(a,"OT_mini"):OT.$.removeClass(a,"OT_mini")}var g=4/3,f=128,c=128,b=64,e=64,k=function(a,b){var c,e;a&&a.nodeName?(c=a,(!c.getAttribute("id")||0===c.getAttribute("id").length)&&c.setAttribute("id","OT_"+OT.$.uuid()),e=c.getAttribute("id")):(c=OT.$(a),e=a||"OT_"+OT.$.uuid());c?null==b||
"replace"===b?OT.$.emptyElement(c):(e=document.createElement("div"),e.id="OT_"+OT.$.uuid(),"append"===b?(c.appendChild(e),c=e):"before"===b?(c.parentNode.insertBefore(e,c),c=e):"after"===b&&(c.parentNode.insertBefore(e,c.nextSibling),c=e)):(c=OT.$.createElement("div",{id:e}),c.style.backgroundColor="#000000",document.body.appendChild(c));return c};OT.WidgetView=function(b,c){var e=k(b,c&&c.insertMode),f=document.createElement("div"),g,r,s,p,t,v,u=!0;c&&(t=c.width,v=c.height,t&&"number"===typeof t&&
(t+="px"),v&&"number"===typeof v&&(v+="px"),e.style.width=t?t:"264px",e.style.height=v?v:"198px",e.style.overflow="hidden",a(e,t||"264px",v||"198px"),(void 0===c.mirror||c.mirror)&&OT.$.addClass(e,"OT_mirrored"));c.classNames&&OT.$.addClass(e,c.classNames);OT.$.addClass(e,"OT_loading");OT.$.addClass(f,"OT_video-container");f.style.width=e.style.width;f.style.height=e.style.height;e.appendChild(f);d(f,e.offsetWidth,e.offsetHeight);t=document.createElement("div");OT.$.addClass(t,"OT_video-loading");
f.appendChild(t);p=document.createElement("div");OT.$.addClass(p,"OT_video-poster");f.appendChild(p);g=OT.$.observeStyleChanges(e,["width","height"],function(b){var c=b.width?b.width[1]:e.offsetWidth;b=b.height?b.height[1]:e.offsetHeight;a(e,c,b);d(f,c,b,r?r.aspectRatio:null)});s=OT.$.observeNodeOrChildNodeRemoval(e,function(a){r&&(a.some(function(a){return a===f||"VIDEO"===a.nodeName})&&(r.destroy(),r=null),f&&(OT.$.removeElement(f),f=null),g&&(g.disconnect(),g=null),s&&(s.disconnect(),s=null))});
this.destroy=function(){g&&(g.disconnect(),g=null);s&&(s.disconnect(),s=null);r&&(r.destroy(),r=null);e&&(OT.$.removeElement(e),e=null)};Object.defineProperties(this,{showPoster:{get:function(){return!OT.$.isDisplayNone(p)},set:function(a){a?OT.$.show(p):OT.$.hide(p)}},poster:{get:function(){return OT.$.css(p,"backgroundImage")},set:function(a){OT.$.css(p,"backgroundImage","url("+a+")")}},loading:{get:function(){return u},set:function(a){(u=a)?OT.$.addClass(e,"OT_loading"):OT.$.removeClass(e,"OT_loading")}},
video:{get:function(){return r},set:function(a){r&&r.destroy();a.appendTo(f);r=a;r.on({orientationChanged:function(){d(f,e.offsetWidth,e.offsetHeight,r.aspectRatio,r.isRotated)}});if(r)if(a=function(){d(f,e.offsetWidth,e.offsetHeight,r?r.aspectRatio:null,r?r.isRotated:null)},isNaN(r.aspectRatio))r.on("streamBound",a);else a()}},domElement:{get:function(){return e}},domId:{get:function(){return e.getAttribute("id")}}});this.addError=function(a,b,c){e.innerHTML="\x3cp\x3e"+a+(b?' \x3cspan class\x3d"ot-help-message"\x3e'+
b+"\x3c/span\x3e":"")+"\x3c/p\x3e";OT.$.addClass(e,c||"OT_subscriber_error");e.querySelector("p").offsetHeight>e.offsetHeight&&(e.querySelector("span").style.display="none")}}}(window);
!function(d){var a,g,f,c,b,e,k;a=function(){if(navigator.getUserMedia)return navigator.getUserMedia.bind(navigator);if(navigator.mozGetUserMedia)return navigator.mozGetUserMedia.bind(navigator);if(navigator.webkitGetUserMedia)return navigator.webkitGetUserMedia.bind(navigator)}();navigator.webkitGetUserMedia?(webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks}),webkitMediaStream.prototype.getAudioTracks||(webkitMediaStream.prototype.getAudioTracks=
function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams}),webkitRTCPeerConnection.prototype.getRemoteStreams||(webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):navigator.mozGetUserMedia&&(MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=
function(){return[]}));g={PERMISSION_DENIED:"PermissionDeniedError",NOT_SUPPORTED_ERROR:"NotSupportedError",MANDATORY_UNSATISFIED_ERROR:" ConstraintNotSatisfiedError",NO_DEVICES_FOUND:"NoDevicesFoundError",HARDWARE_UNAVAILABLE:"HardwareUnavailableError"};f={1:"PermissionDeniedError"};c={PermissionDeniedError:"End-user denied permission to hardware devices",NotSupportedError:"A constraint specified is not supported by the browser.",ConstraintNotSatisfiedError:"It's not possible to satisfy one or more constraints passed into the getUserMedia function",
OverconstrainedError:"Due to changes in the environment, one or more mandatory constraints can no longer be satisfied.",NoDevicesFoundError:"No voice or video input devices are available on this machine.",HardwareUnavailableError:"The selected voice or video devices are unavailable. Verify that the chosen devices are not in use by another application."};b=function(a,b){var e=b[a],d=c[e];d||(d=null,e=a);return{name:e,message:d}};e=function(a){var e;OT.$.isObject(a)&&a.name?e={name:a.name,message:a.message||
c[a.name],constraintName:a.constraintName}:OT.$.isObject(a)?(e=b(a.code,f),a.message&&(e.message=a.message),a.constraintName&&(e.constraintName=a.constraintName)):e=a&&g.hasOwnProperty(a)?b(a,g):{message:"Unknown Error while getting user media"};return e};k=function(a){if(!a||!OT.$.isObject(a))return!0;for(var b in a)if(a.hasOwnProperty(b)&&a[b])return!1;return!0};OT.$.supportsWebRTC=function(){var a=!1,b=OT.$.browserVersion(),c=(OT.properties.minimumVersion||{})[b.browser.toLowerCase()];if(c&&c>
b.version)OT.debug("Support for",b.browser,"is disabled because we require",c,"but this is",b.version),a=!1;else if(navigator.webkitGetUserMedia)a="function"===typeof webkitRTCPeerConnection&&!!webkitRTCPeerConnection.prototype.addStream;else if(navigator.mozGetUserMedia&&"function"===typeof mozRTCPeerConnection&&20<b.version)try{new mozRTCPeerConnection,a=!0}catch(e){a=!1}OT.$.supportsWebRTC=function(){return a};return a};OT.$.supportedCryptoScheme=function(){if(!OT.$.supportsWebRTC())return"NONE";
var a=d.navigator.userAgent.toLowerCase().match(/chrome\/([0-9\.]+)/i);return a&&25>parseFloat(a[1],10)?"SDES_SRTP":"DTLS_SRTP"};OT.$.supportsBundle=function(){return OT.$.supportsWebRTC()&&"Chrome"===OT.$.browser()};OT.$.supportsRtcpMux=function(){return OT.$.supportsWebRTC()&&"Chrome"===OT.$.browser()};OT.$.getUserMedia=function(b,f,g,m,q,r,s){var p=a;OT.$.isFunction(s)&&(p=s);if(k(b))OT.error("Couldn't get UserMedia: All constraints were false"),g.call(null,{name:"NO_VALID_CONSTRAINTS",message:"Video and Audio was disabled, you need to enabled at least one"});
else{var t=null,v=!1;s=function(){t=null;v=!0;m&&m()};var u=function(a){t&&clearTimeout(t);v&&q&&q();f.call(null,a)},C=function(a){t&&clearTimeout(t);v&&q&&q();var b=e(a);"PermissionDeniedError"===b.name?(a=d.MediaStreamTrack,null!=a&&OT.$.isFunction(a.getSources)?d.MediaStreamTrack.getSources(function(a){0<a.length?r.call(null,b):g.call(null,{name:"NoDevicesFoundError",message:c.NoDevicesFoundError})}):r.call(null,b)):g.call(null,b)};try{p(b,u,C)}catch(w){OT.error("Couldn't get UserMedia: "+w.toString());
C();return}t=-1===location.protocol.indexOf("https")?setTimeout(s,100):setTimeout(s,500)}};OT.$.createPeerConnection=function(a,b){return new (d.webkitRTCPeerConnection||d.mozRTCPeerConnection)(a,b)}}(window);
!function(d){function a(a,b){var c=document.createElement("video");c.setAttribute("autoplay","");c.innerHTML=a;if(b){!0===b.muted&&(delete b.muted,c.muted="true");for(var d in b)b.hasOwnProperty(d)&&c.setAttribute(d,b[d])}return c}function g(a){return c[parseInt(a,10)]||"An unknown error occurred."}function f(a,b,c,f){var n,m,q,r,s;navigator.mozGetUserMedia||0<b.getVideoTracks().length&&b.getVideoTracks()[0].enabled?(n=function(){clearTimeout(s);a.removeEventListener("loadedmetadata",m,!1);a.removeEventListener("error",
q,!1);b.onended=null},m=function(){n();c()},q=function(a){n();f("There was an unexpected problem with the Video Stream: "+g(a.target.error.code))},r=function(){n();f("Stream ended while trying to bind it to a video element.")},s=setTimeout(function(){0===a.currentTime?f("The video stream failed to connect. Please notify the site owner if this continues to happen."):(OT.warn("Never got the loadedmetadata event but currentTime \x3e 0"),c())}.bind(this),3E4),a.addEventListener("loadedmetadata",m,!1),
a.addEventListener("error",q,!1),b.onended=r):c();void 0!==a.srcObject?a.srcObject=b:void 0!==a.mozSrcObject?a.mozSrcObject=b:a.src=d.URL.createObjectURL(b);a.play()}var c={},b;b={"0":"rotate(0deg)",270:"rotate(90deg)",90:"rotate(-90deg)",180:"rotate(180deg)"};OT.VideoOrientation={ROTATED_NORMAL:0,ROTATED_LEFT:270,ROTATED_RIGHT:90,ROTATED_UPSIDE_DOWN:180};OT.VideoElement=function(b){var c,h,l,n=!1,m=!1,q,r,s,p;b=OT.$.defaults(b||{},{fallbackText:"Sorry, Web RTC is not available in your browser"});
OT.$.eventing(this);q=function(a){a="There was an unexpected problem with the Video Stream: "+g(a.target.error.code);this.trigger("error",null,a,this,"VideoElement")}.bind(this);r=function(){n=!0;h.addEventListener("error",q,!1);this.trigger("streamBound",this)}.bind(this);s=function(a){this.trigger("loadError",OT.ExceptionCodes.P2P_CONNECTION_FAILED,a,this,"VideoElement")}.bind(this);p=function(){m||(OT.warn("Video element paused, auto-resuming. If you intended to do this, use publishVideo(false) or subscribeToVideo(false) instead."),
m=!0);h.play()};h=a(b.fallbackText,b.attributes);h.addEventListener("pause",p);Object.defineProperties(this,{stream:{get:function(){return c}},domElement:{get:function(){return h}},parentElement:{get:function(){return l}},isBoundToStream:{get:function(){return n}},poster:{get:function(){return h.getAttribute("poster")},set:function(a){h.setAttribute("poster",a)}}});this.appendTo=function(a){l=a;l.appendChild(h);return this};this.bindToStream=function(a){n=!1;c=a;f(h,c,r,s);return this};this.unbindStream=
function(){if(!c)return this;h&&(navigator.mozGetUserMedia?h.mozSrcObject=null:d.URL.revokeObjectURL(h.src));c=null;return this};this.setAudioVolume=function(a){h&&(h.volume=OT.$.roundFloat(a/100,2))};this.getAudioVolume=function(){return h?parseInt(100*h.volume,10):50};this.whenTimeIncrements=function(a,b){if(h){var c,e;e=function(){!c||c>=h.currentTime?c=h.currentTime:(h.removeEventListener("timeupdate",e,!1),a.call(b,this))}.bind(this);h.addEventListener("timeupdate",e,!1)}};this.destroy=function(){this.off();
this.unbindStream();h&&(h.removeEventListener("pause",p),OT.$.removeElement(h),h=null);l=null}};OT.$.canDefineProperty&&Object.defineProperties(OT.VideoElement.prototype,{imgData:{get:function(){var a,b;a=OT.$.createElement("canvas",{width:this.domElement.videoWidth,height:this.domElement.videoHeight,style:{display:"none"}});document.body.appendChild(a);try{a.getContext("2d").drawImage(this.domElement,0,0,a.width,a.height)}catch(c){return OT.warn("Cannot get image data yet"),null}b=a.toDataURL("image/png");
OT.$.removeElement(a);return b.replace("data:image/png;base64,","").trim()}},videoWidth:{get:function(){return this.domElement["video"+(this.isRotated?"Height":"Width")]}},videoHeight:{get:function(){return this.domElement["video"+(this.isRotated?"Width":"Height")]}},aspectRatio:{get:function(){return(this.videoWidth+0)/this.videoHeight}},isRotated:{get:function(){return this._orientation&&(270===this._orientation.videoOrientation||90===this._orientation.videoOrientation)}},orientation:{get:function(){return this._orientation},
set:function(a){var c=b[a.videoOrientation]||b.ROTATED_NORMAL;this._orientation=a;switch(OT.$.browser()){case "Chrome":case "Safari":this.domElement.style.webkitTransform=c;break;case "IE":this.domElement.style.msTransform=c;break;default:this.domElement.style.transform=c}this.trigger("orientationChanged")}}});d.MediaError&&(c[d.MediaError.MEDIA_ERR_ABORTED]="The fetching process for the media resource was aborted by the user agent at the user's request.",c[d.MediaError.MEDIA_ERR_NETWORK]="A network error of some description caused the user agent to stop fetching the media resource, after the resource was established to be usable.",
c[d.MediaError.MEDIA_ERR_DECODE]="An error of some description occurred while decoding the media resource, after the resource was established to be  usable.",c[d.MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED]="The media resource indicated by the src attribute was not suitable.")}(window);
!function(d){var a=[],g=!1;OT.Analytics=function(){var f=OT.properties.loggingURL+"/logging/ClientEvent",c=OT.properties.loggingURL+"/logging/ClientQos",b={},e,k=function(a,b,e){OT.$.post(b?c:f,{body:a,headers:{"Content-Type":"application/x-www-form-urlencoded"}},e)},h=function(){if(!g&&0<a.length){g=!0;var b=a[0],c=function(){a.shift();g=!1;h()};b&&k(b.data,b.isQos,function(a){if(a)OT.debug("Failed to send ClientEvent, moving on to the next item.");else b.onComplete();setTimeout(c,50)})}};e={payloadType:"payload_type",
partnerId:"partner_id",streamId:"stream_id",sessionId:"session_id",connectionId:"connection_id",widgetType:"widget_type",widgetId:"widget_id",avgAudioBitrate:"avg_audio_bitrate",avgVideoBitrate:"avg_video_bitrate",localCandidateType:"local_candidate_type",remoteCandidateType:"remote_candidate_type",transportType:"transport_type"};this.logError=function(a,c,e,d,h){h||(h={});e=h.partnerId;if(!0===OT.Config.get("exceptionLogging","enabled",e)){var f;e?(f=[e,c,a].join("_"),f=100>=(b[f]||0)):f=!1;if(!f){e=
[e,c,a].join("_");var g=this.escapePayload(OT.$.extend(d||{},{message:g,userAgent:navigator.userAgent}));b[e]="undefined"!==typeof b[e]?b[e]+1:1;return this.logEvent(OT.$.extend(h,{action:c+"."+a,payloadType:g[0],payload:g[1]}))}}};this.logEvent=function(b){var c=b.partnerId;b||(b={});b=OT.$.extend({variation:"",guid:this.getClientGuid(),widget_id:"",session_id:"",connection_id:"",stream_id:"",partner_id:c,source:d.location.href,section:"",build:""},b);for(var f in e)e.hasOwnProperty(f)&&b[f]&&(b[e[f]]=
b[f],delete b[f]);a.push({data:b,onComplete:function(){},isQos:!1});h()};this.logQOS=function(b){var c=b.partnerId;b||(b={});b=OT.$.extend({guid:this.getClientGuid(),widget_id:"",session_id:"",connection_id:"",stream_id:"",partner_id:c,source:d.location.href,build:"",duration:0},b);for(var f in e)e.hasOwnProperty(f)&&b[f]&&(b[e[f]]=b[f],delete b[f]);a.push({data:b,onComplete:function(){},isQos:!0});h()};this.escapePayload=function(a){var b=[],c=[],e;for(e in a)a.hasOwnProperty(e)&&(null!==a[e]&&void 0!==
a[e])&&(b.push(a[e]?a[e].toString().replace("|","\\|"):""),c.push(e.toString().replace("|","\\|")));return[c.join("|"),b.join("|")]};this.getClientGuid=function(){var a=OT.$.getCookie("opentok_client_id");a||(a=OT.$.uuid(),OT.$.setCookie("opentok_client_id",a));this.getClientGuid=function(){return a};return a}}}(window);
!function(d){"file:"===location.protocol&&alert("You cannot test a page using WebRTC through the file system due to browser permissions. You must run it over a web server.");d.OT||(d.OT={});!d.URL&&d.webkitURL&&(d.URL=d.webkitURL);var a,g=document.location.hash;OT.initSession=function(a,c){null==c&&(c=a,a=null);var b=OT.sessions.get(c);b||(b=new OT.Session(a,c),OT.sessions.add(b));return b};OT.initPublisher=function(a,c,b,e){OT.debug("OT.initPublisher("+a+")");if(null!=a&&!("object"===typeof a&&a.nodeType===
Node.ELEMENT_NODE||"string"===typeof a&&document.getElementById(a))&&"function"!==typeof a)a=c,c=b,b=e;"function"===typeof a&&(b=a,a=c=void 0);"function"===typeof c&&(b=c,c=void 0);var d=new OT.Publisher;OT.publishers.add(d);var h=function(a){a?OT.dispatchError(a.code,a.message,b,d.session):b&&OT.$.isFunction(b)&&b.apply(null,arguments)},g=function(a){d.off("publishComplete",n);h(a)},n=function(a){d.off("initSuccess",g);a&&h(a)};d.once("initSuccess",g);d.once("publishComplete",n);d.publish(a,c);return d};
OT.checkSystemRequirements=function(){OT.debug("OT.checkSystemRequirements()");var a=OT.$.supportsWebSockets()&&OT.$.supportsWebRTC()?this.HAS_REQUIREMENTS:this.NOT_HAS_REQUIREMENTS;OT.checkSystemRequirements=function(){OT.debug("OT.checkSystemRequirements()");return a};return a};OT.upgradeSystemRequirements=function(){OT.onLoad(function(){document.body.appendChild(function(){var a=document.createElement("iframe");a.id="_upgradeFlash";a.style.position="absolute";a.style.position="fixed";a.style.height=
"100%";a.style.width="100%";a.style.top="0px";a.style.left="0px";a.style.right="0px";a.style.bottom="0px";a.style.zIndex=1E3;try{a.style.backgroundColor="rgba(0,0,0,0.2)"}catch(c){a.style.backgroundColor="transparent",a.setAttribute("allowTransparency","true")}a.setAttribute("frameBorder","0");a.frameBorder="0";a.scrolling="no";a.setAttribute("scrolling","no");var b=OT.$.browserVersion(),b=OT.properties.minimumVersion[b.browser.toLowerCase()];a.src=OT.properties.assetURL+"/html/upgrade.html#"+encodeURIComponent(b?
"true":"false")+","+encodeURIComponent(JSON.stringify(OT.properties.minimumVersion))+"|"+encodeURIComponent(document.location.href);return a}());a&&clearInterval(a);a=setInterval(function(){var a=document.location.hash,c=/^#?\d+&/;a!==g&&c.test(a)&&(g=a,"close_window"===a.replace(c,"")&&(document.body.removeChild(document.getElementById("_upgradeFlash")),document.location.hash=""))},100)})};OT.reportIssue=function(){OT.warn("ToDo: haven't yet implemented OT.reportIssue")};OT.components={};OT.sessions=
{};OT.rtc={};OT.APIKEY=function(){var a=document.getElementsByTagName("script"),a=a[a.length-1],a=a.getAttribute("src")||a.src;return(a=a.match(/[\?\&]apikey=([^&]+)/i))?a[1]:""}();OT.HAS_REQUIREMENTS=1;OT.NOT_HAS_REQUIREMENTS=0;d.OT||(d.OT=OT);d.TB||(d.TB=OT)}(window);
!function(){OT.Collection=function(d){var a=[],g={},f=d||"id";OT.$.eventing(this,!0);var c=function(a){this.trigger("update",a);this.trigger("update:"+a.target.id,a)}.bind(this),b=function(a){this.remove(a.target,a.reason)}.bind(this);this.reset=function(){a.forEach(function(a){a.off("updated",c,this);a.off("destroyed",b,this)},this);a=[];g={}};this.destroy=function(){a.forEach(function(a){a&&"function"===typeof a.destroy&&a.destroy(void 0,!0)});this.reset();this.off()};this.get=function(b){return b&&
void 0!==g[b]?a[g[b]]:void 0};this.has=function(a){return a&&void 0!==g[a]};this.toString=function(){return a.toString()};this.where=function(b,c){return OT.$.isFunction(b)?a.filter(b,c):a.filter(function(a){for(var c in b)if(b.hasOwnProperty(c)&&a[c]!==b[c])return!1;return!0})};this.find=function(b,c){var d;d=OT.$.isFunction(b)?b:function(a){for(var c in b)if(b.hasOwnProperty(c)&&a[c]!==b[c])return!1;return!0};d=d.bind(c);for(var f=0;f<a.length;++f)if(!0===d(a[f]))return a[f];return null};this.add=
function(e){var d=e[f];if(this.has(d))return OT.warn("Model "+d+" is already in the collection",a),this;g[d]=a.push(e)-1;e.on("updated",c,this);e.on("destroyed",b,this);this.trigger("add",e);this.trigger("add:"+d,e);return this};this.remove=function(e,d){var h=e[f];a.splice(g[h],1);for(var l=g[h];l<a.length;++l)g[a[l][f]]=l;delete g[h];e.off("updated",c,this);e.off("destroyed",b,this);this.trigger("remove",e,d);this.trigger("remove:"+h,e,d);return this};this._triggerAddEvents=function(){this.where.apply(this,
arguments).forEach(function(a){this.trigger("add",a);this.trigger("add:"+a[f],a)},this)};OT.$.defineGetters(this,{length:function(){return a.length}})}}(this);
!function(){OT.Event=OT.$.eventing.Event();OT.Event.names={ACTIVE:"active",INACTIVE:"inactive",UNKNOWN:"unknown",PER_SESSION:"perSession",PER_STREAM:"perStream",EXCEPTION:"exception",ISSUE_REPORTED:"issueReported",SESSION_CONNECTED:"sessionConnected",SESSION_DISCONNECTED:"sessionDisconnected",STREAM_CREATED:"streamCreated",STREAM_DESTROYED:"streamDestroyed",CONNECTION_CREATED:"connectionCreated",CONNECTION_DESTROYED:"connectionDestroyed",SIGNAL:"signal",STREAM_PROPERTY_CHANGED:"streamPropertyChanged",
MICROPHONE_LEVEL_CHANGED:"microphoneLevelChanged",RESIZE:"resize",SETTINGS_BUTTON_CLICK:"settingsButtonClick",DEVICE_INACTIVE:"deviceInactive",INVALID_DEVICE_NAME:"invalidDeviceName",ACCESS_ALLOWED:"accessAllowed",ACCESS_DENIED:"accessDenied",ACCESS_DIALOG_OPENED:"accessDialogOpened",ACCESS_DIALOG_CLOSED:"accessDialogClosed",ECHO_CANCELLATION_MODE_CHANGED:"echoCancellationModeChanged",PUBLISHER_DESTROYED:"destroyed",SUBSCRIBER_DESTROYED:"destroyed",DEVICES_DETECTED:"devicesDetected",DEVICES_SELECTED:"devicesSelected",
CLOSE_BUTTON_CLICK:"closeButtonClick",MICLEVEL:"microphoneActivityLevel",MICGAINCHANGED:"microphoneGainChanged",ENV_LOADED:"envLoaded"};OT.ExceptionCodes={JS_EXCEPTION:2E3,AUTHENTICATION_ERROR:1004,INVALID_SESSION_ID:1005,CONNECT_FAILED:1006,CONNECT_REJECTED:1007,CONNECTION_TIMEOUT:1008,NOT_CONNECTED:1010,P2P_CONNECTION_FAILED:1013,API_RESPONSE_FAILURE:1014,UNABLE_TO_PUBLISH:1500,UNABLE_TO_SUBSCRIBE:1501,UNABLE_TO_FORCE_DISCONNECT:1520,UNABLE_TO_FORCE_UNPUBLISH:1530};OT.ExceptionEvent=function(a,
c,d,h,f,g){OT.Event.call(this,a);this.message=c;this.title=d;this.code=h;this.component=f;this.target=g};OT.IssueReportedEvent=function(a,c){OT.Event.call(this,a);this.issueId=c};OT.EnvLoadedEvent=function(a){OT.Event.call(this,a)};var d=!1;OT.ConnectionEvent=function(a,c,f){OT.Event.call(this,a,!1);OT.$.canDefineProperty?Object.defineProperty(this,"connections",{get:function(){d||(OT.warn("OT.ConnectionEvent connections property is deprecated, use connection instead."),d=!0);return[c]}}):this.connections=
[c];this.connection=c;this.reason=f};var a=!1;OT.StreamEvent=function(b,c,d,h){OT.Event.call(this,b,h);OT.$.canDefineProperty?Object.defineProperty(this,"streams",{get:function(){a||(OT.warn("OT.StreamEvent streams property is deprecated, use stream instead."),a=!0);return[c]}}):this.streams=[c];this.stream=c;this.reason=d};var g=!1,f=!1,c=!1;OT.SessionConnectEvent=function(a){OT.Event.call(this,a,!1);OT.$.canDefineProperty?Object.defineProperties(this,{connections:{get:function(){g||(OT.warn("OT.SessionConnectedEvent no longer includes connections. Listen for connectionCreated events instead."),
g=!0);return[]}},streams:{get:function(){OT.warn("OT.SessionConnectedEvent no longer includes streams. Listen for streamCreated events instead.");g=!0;return[]}},archives:{get:function(){f||(OT.warn("OT.SessionConnectedEvent no longer includes archives. Listen for archiveStarted events instead."),f=!0);return[]}},groups:{get:function(){c||(OT.error("OT.SessionConnectedEvent no longer includes groups. There is no equivelant in OpenTok v2.2"),c=!0);return[]}}}):(this.connections=[],this.streams=[],
this.archives=[],this.groups=[])};OT.SessionDisconnectEvent=function(a,c,d){OT.Event.call(this,a,d);this.reason=c};OT.StreamPropertyChangedEvent=function(a,c,d,h,f){OT.Event.call(this,a,!1);this.type=a;this.stream=c;this.changedProperty=d;this.oldValue=h;this.newValue=f};OT.ArchiveEvent=function(a,c){OT.Event.call(this,a,!1);this.type=a;this.id=c.id;this.name=c.name;this.status=c.status;this.archive=c};OT.ArchiveUpdatedEvent=function(a,c,d,h){OT.Event.call(this,"updated",!1);this.target=a;this.changedProperty=
c;this.oldValue=d;this.newValue=h};OT.SignalEvent=function(a,c,d){OT.Event.call(this,a?"signal:"+a:OT.Event.names.SIGNAL,!1);this.data=c;this.from=d};OT.StreamUpdatedEvent=function(a,c,d,h){OT.Event.call(this,"updated",!1);this.target=a;this.changedProperty=c;this.oldValue=d;this.newValue=h};OT.DestroyedEvent=function(a,c,d){OT.Event.call(this,a,!1);this.target=c;this.reason=d}}(window);
(function(d){function a(a,b,c){return b<=a&&a<=c}function g(a,b){return Math.floor(a/b)}function f(a){var b=0;this.get=function(){return b>=a.length?-1:Number(a[b])};this.offset=function(c){b+=c;if(0>b)throw Error("Seeking past start of the buffer");if(b>a.length)throw Error("Seeking past EOF");};this.match=function(c){if(c.length>b+a.length)return!1;var d;for(d=0;d<c.length;d+=1)if(Number(a[b+d])!==c[d])return!1;return!0}}function c(a){var b=0;this.emit=function(c){var d=-1,e;for(e=0;e<arguments.length;++e)d=
Number(arguments[e]),a[b++]=d;return d}}function b(b){var c=0,d=function(b){for(var c=[],d=0,e=b.length;d<b.length;){var h=b.charCodeAt(d);if(a(h,55296,57343))if(a(h,56320,57343))c.push(65533);else if(d===e-1)c.push(65533);else{var f=b.charCodeAt(d+1);a(f,56320,57343)?(h&=1023,f&=1023,d+=1,c.push(65536+(h<<10)+f)):c.push(65533)}else c.push(h);d+=1}return c}(b);this.offset=function(a){c+=a;if(0>c)throw Error("Seeking past start of the buffer");if(c>d.length)throw Error("Seeking past EOF");};this.get=
function(){return c>=d.length?-1:d[c]}}function e(){var a="";this.string=function(){return a};this.emit=function(b){65535>=b?a+=String.fromCharCode(b):(b-=65536,a+=String.fromCharCode(55296+(b>>10&1023)),a+=String.fromCharCode(56320+(b&1023)))}}function k(a){this.name="EncodingError";this.message=a;this.code=0}function h(a,b){if(a)throw new k("Decoder error");return b||65533}function l(a){throw new k("The code point "+a+" could not be encoded.");}function n(a){a=String(a).trim().toLowerCase();return Object.prototype.hasOwnProperty.call(O,
a)?O[a]:null}function m(a,b){return(b||[])[a]||null}function q(a,b){var c=b.indexOf(a);return-1===c?null:c}function r(b){var c=b.fatal,d=0,e=0,f=0,g=0;this.decode=function(b){var k=b.get();if(-1===k)return 0!==e?h(c):-1;b.offset(1);if(0===e){if(a(k,0,127))return k;if(a(k,194,223))e=1,g=128,d=k-192;else if(a(k,224,239))e=2,g=2048,d=k-224;else if(a(k,240,244))e=3,g=65536,d=k-240;else return h(c);d*=Math.pow(64,e);return null}if(!a(k,128,191))return g=f=e=d=0,b.offset(-1),h(c);f+=1;d+=(k-128)*Math.pow(64,
e-f);if(f!==e)return null;b=d;k=g;g=f=e=d=0;return a(b,k,1114111)&&!a(b,55296,57343)?b:h(c)}}function s(b){this.encode=function(b,c){var d=c.get();if(-1===d)return-1;c.offset(1);if(a(d,55296,57343))return l(d);if(a(d,0,127))return b.emit(d);var e,h;a(d,128,2047)?(e=1,h=192):a(d,2048,65535)?(e=2,h=224):a(d,65536,1114111)&&(e=3,h=240);for(h=b.emit(g(d,Math.pow(64,e))+h);0<e;)h=g(d,Math.pow(64,e-1)),h=b.emit(128+h%64),e-=1;return h}}function p(b,c){var d=c.fatal;this.decode=function(c){var e=c.get();
if(-1===e)return-1;c.offset(1);if(a(e,0,127))return e;c=b[e-128];return null===c?h(d):c}}function t(b,c){this.encode=function(c,d){var e=d.get();if(-1===e)return-1;d.offset(1);if(a(e,0,127))return c.emit(e);var h=q(e,b);null===h&&l(e);return c.emit(h+128)}}function v(b,c){var d=c.fatal,e=0,f=0,g=0;this.decode=function(c){var k=c.get();if(-1===k&&0===e&&0===f&&0===g)return-1;if(-1===k&&(0!==e||0!==f||0!==g))g=f=e=0,h(d);c.offset(1);var l;if(0!==g){l=null;if(a(k,48,57))if(k=10*(126*(10*(e-129)+(f-48))+
(g-129))+k-48,39419<k&&189E3>k||1237575<k)l=null;else{var n=0;l=0;var M=B.gb18030,N;for(N=0;N<M.length;++N){var p=M[N];if(p[0]<=k)n=p[0],l=p[1];else break}l=l+k-n}g=f=e=0;return null===l?(c.offset(-3),h(d)):l}if(0!==f){if(a(k,129,254))return g=k,null;c.offset(-2);f=e=0;return h(d)}if(0!==e){if(a(k,48,57)&&b)return f=k,null;l=e;n=null;e=0;M=127>k?64:65;if(a(k,64,126)||a(k,128,254))n=190*(l-129)+(k-M);l=null===n?null:m(n,B.gbk);null===n&&c.offset(-1);return null===l?h(d):l}return a(k,0,127)?k:128===
k?8364:a(k,129,254)?(e=k,null):h(d)}}function u(b,c){this.encode=function(c,d){var e=d.get();if(-1===e)return-1;d.offset(1);if(a(e,0,127))return c.emit(e);var h=q(e,B.gbk);if(null!==h)return e=g(h,190)+129,h%=190,c.emit(e,h+(63>h?64:65));if(null===h&&!b)return l(e);var f=h=0,k=B.gb18030,m;for(m=0;m<k.length;++m){var n=k[m];if(n[1]<=e)h=n[1],f=n[0];else break}h=f+e-h;e=g(g(g(h,10),126),10);h-=12600*e;f=g(g(h,10),126);h-=1260*f;k=g(h,10);return c.emit(e+129,f+48,k+129,h-10*k+48)}}function C(b){var c=
b.fatal,d=!1,e=0;this.decode=function(b){var f=b.get();if(-1===f&&0===e)return-1;if(-1===f&&0!==e)return e=0,h(c);b.offset(1);if(126===e){e=0;if(123===f)return d=!0,null;if(125===f)return d=!1,null;if(126===f)return 126;if(10===f)return null;b.offset(-1);return h(c)}if(0!==e){b=e;e=0;var g=null;a(f,33,126)&&(g=m(190*(b-1)+(f+63),B.gbk));10===f&&(d=!1);return null===g?h(c):g}if(126===f)return e=126,null;if(d){if(a(f,32,127))return e=f,null;10===f&&(d=!1);return h(c)}return a(f,0,127)?f:h(c)}}function w(b){var c=
!1;this.encode=function(b,d){var e=d.get();if(-1===e)return-1;d.offset(1);if(a(e,0,127)&&c)return d.offset(-1),c=!1,b.emit(126,125);if(126===e)return b.emit(126,126);if(a(e,0,127))return b.emit(e);if(!c)return d.offset(-1),c=!0,b.emit(126,123);var h=q(e,B.gbk);if(null===h)return l(e);var f=g(h,190)+1,h=h%190-63;return!a(f,33,126)||!a(h,33,126)?l(e):b.emit(f,h)}}function x(b){var c=b.fatal,e=0,d=null;this.decode=function(b){if(null!==d)return b=d,d=null,b;var f=b.get();if(-1===f&&0===e)return-1;if(-1===
f&&0!==e)return e=0,h(c);b.offset(1);if(0!==e){var g=e,k=null;e=0;var l=127>f?64:98;if(a(f,64,126)||a(f,161,254))k=157*(g-129)+(f-l);if(1133===k)return d=772,202;if(1135===k)return d=780,202;if(1164===k)return d=772,234;if(1166===k)return d=780,234;f=null===k?null:m(k,B.big5);null===k&&b.offset(-1);return null===f?h(c):f}return a(f,0,127)?f:a(f,129,254)?(e=f,null):h(c)}}function F(b){this.encode=function(b,c){var e=c.get();if(-1===e)return-1;c.offset(1);if(a(e,0,127))return b.emit(e);var d=q(e,B.big5);
if(null===d)return l(e);e=g(d,157)+129;d%=157;return b.emit(e,d+(63>d?64:98))}}function z(b){var c=b.fatal,e=0,d=0;this.decode=function(b){var f=b.get();if(-1===f){if(0===e&&0===d)return-1;d=e=0;return h(c)}b.offset(1);var g,k;return 0!==d?(g=d,d=0,k=null,a(g,161,254)&&a(f,161,254)&&(k=m(94*(g-161)+f-161,B.jis0212)),a(f,161,254)||b.offset(-1),null===k?h(c):k):142===e&&a(f,161,223)?(e=0,65377+f-161):143===e&&a(f,161,254)?(e=0,d=f,null):0!==e?(g=e,e=0,k=null,a(g,161,254)&&a(f,161,254)&&(k=m(94*(g-161)+
f-161,B.jis0208)),a(f,161,254)||b.offset(-1),null===k?h(c):k):a(f,0,127)?f:142===f||143===f||a(f,161,254)?(e=f,null):h(c)}}function G(b){this.encode=function(b,c){var e=c.get();if(-1===e)return-1;c.offset(1);if(a(e,0,127))return b.emit(e);if(165===e)return b.emit(92);if(8254===e)return b.emit(126);if(a(e,65377,65439))return b.emit(142,e-65377+161);var d=q(e,B.jis0208);if(null===d)return l(e);e=g(d,94)+161;return b.emit(e,d%94+161)}}function L(b){var c=b.fatal,e=0,d=!1,f=0;this.decode=function(b){var g=
b.get();-1!==g&&b.offset(1);switch(e){default:case 0:return 27===g?(e=1,null):a(g,0,127)?g:-1===g?-1:h(c);case 1:if(36===g||40===g)return f=g,e=2,null;-1!==g&&b.offset(-1);e=0;return h(c);case 2:var k=f;f=0;if(36===k&&(64===g||66===g))return d=!1,e=4,null;if(36===k&&40===g)return e=3,null;if(40===k&&(66===g||74===g))return e=0,null;if(40===k&&73===g)return e=6,null;-1===g?b.offset(-1):b.offset(-2);e=0;return h(c);case 3:if(68===g)return d=!0,e=4,null;-1===g?b.offset(-2):b.offset(-3);e=0;return h(c);
case 4:if(10===g)return e=0,h(c,10);if(27===g)return e=1,null;if(-1===g)return-1;f=g;e=5;return null;case 5:e=4;if(-1===g)return h(c);b=null;k=94*(f-33)+g-33;a(f,33,126)&&a(g,33,126)&&(b=!1===d?m(k,B.jis0208):m(k,B.jis0212));return null===b?h(c):b;case 6:return 27===g?(e=1,null):a(g,33,95)?65377+g-33:-1===g?-1:h(c)}}}function K(b){var c=0;this.encode=function(b,e){var d=e.get();if(-1===d)return-1;e.offset(1);if((a(d,0,127)||165===d||8254===d)&&0!==c)return e.offset(-1),c=0,b.emit(27,40,66);if(a(d,
0,127))return b.emit(d);if(165===d)return b.emit(92);if(8254===d)return b.emit(126);if(a(d,65377,65439)&&2!==c)return e.offset(-1),c=2,b.emit(27,40,73);if(a(d,65377,65439))return b.emit(d-65377-33);if(1!==c)return e.offset(-1),c=1,b.emit(27,36,66);var h=q(d,B.jis0208);if(null===h)return l(d);d=g(h,94)+33;return b.emit(d,h%94+33)}}function H(b){var c=b.fatal,e=0;this.decode=function(b){var d=b.get();if(-1===d&&0===e)return-1;if(-1===d&&0!==e)return e=0,h(c);b.offset(1);if(0!==e){var f=e;e=0;if(a(d,
64,126)||a(d,128,252))return b=m(188*(f-(160>f?129:193))+d-(127>d?64:65),B.jis0208),null===b?h(c):b;b.offset(-1);return h(c)}return a(d,0,128)?d:a(d,161,223)?65377+d-161:a(d,129,159)||a(d,224,252)?(e=d,null):h(c)}}function D(b){this.encode=function(b,c){var e=c.get();if(-1===e)return-1;c.offset(1);if(a(e,0,128))return b.emit(e);if(165===e)return b.emit(92);if(8254===e)return b.emit(126);if(a(e,65377,65439))return b.emit(e-65377+161);var d=q(e,B.jis0208);if(null===d)return l(e);e=g(d,188);d%=188;return b.emit(e+
(31>e?129:193),d+(63>d?64:65))}}function A(b){var c=b.fatal,e=0;this.decode=function(b){var d=b.get();if(-1===d&&0===e)return-1;if(-1===d&&0!==e)return e=0,h(c);b.offset(1);if(0!==e){var f=e,g=null;e=0;if(a(f,129,198)){var k=178*(f-129);a(d,65,90)?g=k+d-65:a(d,97,122)?g=k+26+d-97:a(d,129,254)&&(g=k+26+26+d-129)}a(f,199,253)&&a(d,161,254)&&(g=12460+94*(f-199)+(d-161));d=null===g?null:m(g,B["euc-kr"]);null===g&&b.offset(-1);return null===d?h(c):d}return a(d,0,127)?d:a(d,129,253)?(e=d,null):h(c)}}function I(b){this.encode=
function(b,c){var e=c.get();if(-1===e)return-1;c.offset(1);if(a(e,0,127))return b.emit(e);var d=q(e,B["euc-kr"]);if(null===d)return l(e);if(12460>d)return e=g(d,178)+129,d%=178,b.emit(e,d+(26>d?65:52>d?71:77));d-=12460;e=g(d,94)+199;return b.emit(e,d%94+161)}}function J(b){var c=b.fatal,e=0,d=0;this.decode=function(b){var f=b.get();-1!==f&&b.offset(1);switch(e){default:case 0:return 14===f?(e=4,null):15===f?null:27===f?(e=1,null):a(f,0,127)?f:-1===f?-1:h(c);case 1:if(36===f)return e=2,null;-1!==f&&
b.offset(-1);e=0;return h(c);case 2:if(41===f)return e=3,null;-1===f?b.offset(-1):b.offset(-2);e=0;return h(c);case 3:if(67===f)return e=0,null;-1===f?b.offset(-2):b.offset(-3);e=0;return h(c);case 4:if(10===f)return e=0,h(c,10);if(14===f)return null;if(15===f)return e=0,null;if(-1===f)return-1;d=f;e=5;return null;case 5:e=4;if(-1===f)return h(c);b=null;a(d,33,70)&&a(f,33,126)?b=m(178*(d-1)+52+f-1,B["euc-kr"]):a(d,71,126)&&a(f,33,126)&&(b=m(12460+94*(d-71)+(f-33),B["euc-kr"]));return null!==b?b:h(c)}}}
function E(b){var c=!1,e=0;this.encode=function(b,d){var f=d.get();if(-1===f)return-1;c||(c=!0,b.emit(27,36,41,67));d.offset(1);if(a(f,0,127)&&0!==e)return d.offset(-1),e=0,b.emit(15);if(a(f,0,127))return b.emit(f);if(1!==e)return d.offset(-1),e=1,b.emit(14);var h=q(f,B["euc-kr"]);if(null===h)return l(f);var k;if(12460>h)return k=g(h,178)+1,h=h%178-26-26+1,!a(k,33,70)||!a(h,33,126)?l(f):b.emit(k,h);h-=12460;k=g(h,94)+71;h=h%94+33;return!a(k,71,126)||!a(h,33,126)?l(f):b.emit(k,h)}}function M(b,c){var e=
c.fatal,d=null,f=null;this.decode=function(c){var g=c.get();if(-1===g&&null===d&&null===f)return-1;if(-1===g&&(null!==d||null!==f))return h(e);c.offset(1);if(null===d)return d=g,null;g=b?(d<<8)+g:(g<<8)+d;d=null;if(null!==f){var k=f;f=null;if(a(g,56320,57343))return 65536+1024*(k-55296)+(g-56320);c.offset(-2);return h(e)}return a(g,55296,56319)?(f=g,null):a(g,56320,57343)?h(e):g}}function P(b,c){this.encode=function(c,e){function d(a){var e=a>>8;a&=255;return b?c.emit(e,a):c.emit(a,e)}var f=e.get();
if(-1===f)return-1;e.offset(1);a(f,55296,57343)&&l(f);if(65535>=f)return d(f);var h=g(f-65536,1024)+55296,f=(f-65536)%1024+56320;d(h);return d(f)}}function N(a,b){if(!this||this===d)return new N(a,b);a=a?String(a):"utf-8";b=Object(b);this._encoding=n(a);if(null===this._encoding||"utf-8"!==this._encoding.name&&"utf-16"!==this._encoding.name&&"utf-16be"!==this._encoding.name)throw new TypeError("Unknown encoding: "+a);this._streaming=!1;this._encoder=null;this._options={fatal:Boolean(b.fatal)};Object.defineProperty?
Object.defineProperty(this,"encoding",{get:function(){return this._encoding.name}}):this.encoding=this._encoding.name;return this}function Q(a,b){if(!this||this===d)return new Q(a,b);a=a?String(a):"utf-8";b=Object(b);this._encoding=n(a);if(null===this._encoding)throw new TypeError("Unknown encoding: "+a);this._streaming=!1;this._decoder=null;this._options={fatal:Boolean(b.fatal)};Object.defineProperty?Object.defineProperty(this,"encoding",{get:function(){return this._encoding.name}}):this.encoding=
this._encoding.name;return this}if(!(void 0!==d.TextEncoder&&void 0!==d.TextDecoder)){k.prototype=Error.prototype;var y={},O={};[{encodings:[{labels:["unicode-1-1-utf-8","utf-8","utf8"],name:"utf-8"}],heading:"The Encoding"},{encodings:[{labels:["cp864","ibm864"],name:"ibm864"},{labels:["cp866","ibm866"],name:"ibm866"},{labels:"csisolatin2 iso-8859-2 iso-ir-101 iso8859-2 iso_8859-2 l2 latin2".split(" "),name:"iso-8859-2"},{labels:"csisolatin3 iso-8859-3 iso_8859-3 iso-ir-109 l3 latin3".split(" "),
name:"iso-8859-3"},{labels:"csisolatin4 iso-8859-4 iso_8859-4 iso-ir-110 l4 latin4".split(" "),name:"iso-8859-4"},{labels:["csisolatincyrillic","cyrillic","iso-8859-5","iso_8859-5","iso-ir-144"],name:"iso-8859-5"},{labels:"arabic csisolatinarabic ecma-114 iso-8859-6 iso_8859-6 iso-ir-127".split(" "),name:"iso-8859-6"},{labels:"csisolatingreek ecma-118 elot_928 greek greek8 iso-8859-7 iso_8859-7 iso-ir-126".split(" "),name:"iso-8859-7"},{labels:"csisolatinhebrew hebrew iso-8859-8 iso-8859-8-i iso-ir-138 iso_8859-8 visual".split(" "),
name:"iso-8859-8"},{labels:"csisolatin6 iso-8859-10 iso-ir-157 iso8859-10 l6 latin6".split(" "),name:"iso-8859-10"},{labels:["iso-8859-13"],name:"iso-8859-13"},{labels:["iso-8859-14","iso8859-14"],name:"iso-8859-14"},{labels:["iso-8859-15","iso_8859-15"],name:"iso-8859-15"},{labels:["iso-8859-16"],name:"iso-8859-16"},{labels:["koi8-r","koi8_r"],name:"koi8-r"},{labels:["koi8-u"],name:"koi8-u"},{labels:["csmacintosh","mac","macintosh","x-mac-roman"],name:"macintosh"},{labels:["iso-8859-11","tis-620",
"windows-874"],name:"windows-874"},{labels:["windows-1250","x-cp1250"],name:"windows-1250"},{labels:["windows-1251","x-cp1251"],name:"windows-1251"},{labels:"ascii ansi_x3.4-1968 csisolatin1 iso-8859-1 iso8859-1 iso_8859-1 l1 latin1 us-ascii windows-1252".split(" "),name:"windows-1252"},{labels:["cp1253","windows-1253"],name:"windows-1253"},{labels:"csisolatin5 iso-8859-9 iso-ir-148 l5 latin5 windows-1254".split(" "),name:"windows-1254"},{labels:["cp1255","windows-1255"],name:"windows-1255"},{labels:["cp1256",
"windows-1256"],name:"windows-1256"},{labels:["windows-1257"],name:"windows-1257"},{labels:["cp1258","windows-1258"],name:"windows-1258"},{labels:["x-mac-cyrillic","x-mac-ukrainian"],name:"x-mac-cyrillic"}],heading:"Legacy single-byte encodings"},{encodings:[{labels:"chinese csgb2312 csiso58gb231280 gb2312 gbk gb_2312 gb_2312-80 iso-ir-58 x-gbk".split(" "),name:"gbk"},{labels:["gb18030"],name:"gb18030"},{labels:["hz-gb-2312"],name:"hz-gb-2312"}],heading:"Legacy multi-byte Chinese (simplified) encodings"},
{encodings:[{labels:["big5","big5-hkscs","cn-big5","csbig5","x-x-big5"],name:"big5"}],heading:"Legacy multi-byte Chinese (traditional) encodings"},{encodings:[{labels:["cseucpkdfmtjapanese","euc-jp","x-euc-jp"],name:"euc-jp"},{labels:["csiso2022jp","iso-2022-jp"],name:"iso-2022-jp"},{labels:"csshiftjis ms_kanji shift-jis shift_jis sjis windows-31j x-sjis".split(" "),name:"shift_jis"}],heading:"Legacy multi-byte Japanese encodings"},{encodings:[{labels:"cseuckr csksc56011987 euc-kr iso-ir-149 korean ks_c_5601-1987 ks_c_5601-1989 ksc5601 ksc_5601 windows-949".split(" "),
name:"euc-kr"},{labels:["csiso2022kr","iso-2022-kr"],name:"iso-2022-kr"}],heading:"Legacy multi-byte Korean encodings"},{encodings:[{labels:["utf-16","utf-16le"],name:"utf-16"},{labels:["utf-16be"],name:"utf-16be"}],heading:"Legacy utf-16 encodings"}].forEach(function(a){a.encodings.forEach(function(a){y[a.name]=a;a.labels.forEach(function(b){O[b]=a})})});var B=d["encoding-indexes"]||{};y["utf-8"].getEncoder=function(a){return new s(a)};y["utf-8"].getDecoder=function(a){return new r(a)};(function(){"ibm864 ibm866 iso-8859-2 iso-8859-3 iso-8859-4 iso-8859-5 iso-8859-6 iso-8859-7 iso-8859-8 iso-8859-10 iso-8859-13 iso-8859-14 iso-8859-15 iso-8859-16 koi8-r koi8-u macintosh windows-874 windows-1250 windows-1251 windows-1252 windows-1253 windows-1254 windows-1255 windows-1256 windows-1257 windows-1258 x-mac-cyrillic".split(" ").forEach(function(a){var b=
y[a],c=B[a];b.getDecoder=function(a){return new p(c,a)};b.getEncoder=function(a){return new t(c,a)}})})();y.gbk.getEncoder=function(a){return new u(!1,a)};y.gbk.getDecoder=function(a){return new v(!1,a)};y.gb18030.getEncoder=function(a){return new u(!0,a)};y.gb18030.getDecoder=function(a){return new v(!0,a)};y["hz-gb-2312"].getEncoder=function(a){return new w(a)};y["hz-gb-2312"].getDecoder=function(a){return new C(a)};y.big5.getEncoder=function(a){return new F(a)};y.big5.getDecoder=function(a){return new x(a)};
y["euc-jp"].getEncoder=function(a){return new G(a)};y["euc-jp"].getDecoder=function(a){return new z(a)};y["iso-2022-jp"].getEncoder=function(a){return new K(a)};y["iso-2022-jp"].getDecoder=function(a){return new L(a)};y.shift_jis.getEncoder=function(a){return new D(a)};y.shift_jis.getDecoder=function(a){return new H(a)};y["euc-kr"].getEncoder=function(a){return new I(a)};y["euc-kr"].getDecoder=function(a){return new A(a)};y["iso-2022-kr"].getEncoder=function(a){return new E(a)};y["iso-2022-kr"].getDecoder=
function(a){return new J(a)};y["utf-16"].getEncoder=function(a){return new P(!1,a)};y["utf-16"].getDecoder=function(a){return new M(!1,a)};y["utf-16be"].getEncoder=function(a){return new P(!0,a)};y["utf-16be"].getDecoder=function(a){return new M(!0,a)};N.prototype={encode:function(a,e){a=a?String(a):"";e=Object(e);this._streaming||(this._encoder=this._encoding.getEncoder(this._options));this._streaming=Boolean(e.stream);for(var d=[],f=new c(d),h=new b(a);-1!==h.get();)this._encoder.encode(f,h);if(!this._streaming){var g;
do g=this._encoder.encode(f,h);while(-1!==g);this._encoder=null}return new Uint8Array(d)}};Q.prototype={decode:function(a,b){if(a&&!("buffer"in a&&"byteOffset"in a&&"byteLength"in a))throw new TypeError("Expected ArrayBufferView");a||(a=new Uint8Array(0));b=Object(b);this._streaming||(this._decoder=this._encoding.getDecoder(this._options));this._streaming=Boolean(b.stream);var c=new Uint8Array(a.buffer,a.byteOffset,a.byteLength),c=new f(c);if(!this._BOMseen){this._BOMseen=!0;var d=this._encoding.name;
c.match([255,254])&&"utf-16"===d?c.offset(2):c.match([254,255])&&"utf-16be"==d?c.offset(2):c.match([239,187,191])&&"utf-8"==d&&c.offset(3)}for(var d=new e,h;-1!==c.get();)h=this._decoder.decode(c),null!==h&&-1!==h&&d.emit(h);if(!this._streaming){do h=this._decoder.decode(c),null!==h&&-1!==h&&d.emit(h);while(-1!==h&&-1!=c.get());this._decoder=null}return d.string()}};d.TextEncoder=d.TextEncoder||N;d.TextDecoder=d.TextDecoder||Q}})(this);
!function(){OT.Rumor={MessageType:{SUBSCRIBE:0,UNSUBSCRIBE:1,MESSAGE:2,CONNECT:3,DISCONNECT:4,PING:7,PONG:8,STATUS:9}}}(this);
!function(){var d;d={1002:"The endpoint is terminating the connection due to a protocol error. (CLOSE_PROTOCOL_ERROR)",1003:"The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data). (CLOSE_UNSUPPORTED)",1004:"The endpoint is terminating the connection because a data frame was received that is too large. (CLOSE_TOO_LARGE)",1005:"Indicates that no status code was provided even though one was expected. (CLOSE_NO_STATUS)",
1006:"Used to indicate that a connection was closed abnormally (that is, with no close frame being sent) when a status code is expected. (CLOSE_ABNORMAL)",1007:"Indicates that an endpoint is terminating the connection because it has received data within a message that was not consistent with the type of the message (e.g., non-UTF-8 [RFC3629] data within a text message)",1008:"Indicates that an endpoint is terminating the connection because it has received a message that violates its policy.  This is a generic status code that can be returned when there is no other more suitable status code (e.g., 1003 or 1009) or if there is a need to hide specific details about the policy",
1009:"Indicates that an endpoint is terminating the connection because it has received a message that is too big for it to process",1011:"Indicates that a server is terminating the connection because it encountered an unexpected condition that prevented it from fulfilling the request",4001:"Connectivity loss was detected as it was too long since the socket received the last PONG message"};OT.Rumor.SocketError=function(a,d){this.code=a;this.message=d};OT.Rumor.Socket=function(a,g,f){var c,b,e,k,h,
l,n,m,q,r,s,p=OT.$.statable(this,["disconnected","error","connected","connecting","disconnecting"],"disconnected",function(a){switch(a){case "disconnected":case "error":if(c=null,h){var b;if(!r?0:44900<=OT.$.now()-r)b=Error(d[4001]),b.code=4001;h(b)}}}),t=function(a,b){if(null===b||!OT.$.isFunction(b))throw Error("The Rumor.Socket "+a+" callback must be a valid function or null");},v=function(a){OT.error("Rumor.Socket: "+a);a=new OT.Rumor.SocketError(null,a||"Unknown Socket Error");q&&clearTimeout(q);
p("error");"connecting"===this.previousState&&n&&(n(a,null),n=null);k&&k(a)}.bind(this),u=function K(a){c&&(void 0===a&&(a=0),m&&clearTimeout(m),0<c.bufferedAmount&&10>=a+1?m=setTimeout(K,100,a+1):(p("disconnecting"),m&&(clearTimeout(m),m=null),c.close()))},C=function H(){this.is("connected")&&((!r?0:44900<=OT.$.now()-r)?z({code:4001}):(c.send(OT.Rumor.Message.Ping().serialize()),s=setTimeout(H.bind(this),9E3)))}.bind(this),w=function(){q&&clearTimeout(q);this.isNot("connecting")?OT.debug("webSocketConnected reached in state other than connecting"):
(c.send(OT.Rumor.Message.Connect(b,g).serialize()),p("connected"),n&&(n(null,b),n=null),e&&e(b),setTimeout(function(){r=OT.$.now();C()},9E3))}.bind(this),x=function(){var a=c;v("Timed out while waiting for the Rumor socket to connect.");try{a.close()}catch(b){}},F=function(){},z=function(a){q&&clearTimeout(q);s&&clearTimeout(s);if(1E3!==a.code&&1001!==a.code){var b=a.reason||a.message;!b&&d.hasOwnProperty(a.code)&&(b=d[a.code]);v("Rumor Socket Disconnected: "+b)}this.isNot("error")&&p("disconnected")}.bind(this),
G=function(a){r=OT.$.now();l&&(a=OT.Rumor.Message.deserialize(a.data),a.type!==OT.Rumor.MessageType.PONG&&l(a))};this.publish=function(a,b,e){c.send(OT.Rumor.Message.Publish(a,b,e).serialize())};this.subscribe=function(a){c.send(OT.Rumor.Message.Subscribe(a).serialize())};this.unsubscribe=function(a){c.send(OT.Rumor.Message.Unsubscribe(a).serialize())};this.connect=function(e,d){if(this.is("connecting","connected"))d(new OT.Rumor.SocketError(null,"Rumor.Socket cannot connect when it is already connecting or connected."));
else{b=e;n=d;try{p("connecting"),c=new (f||WebSocket)(a),c.binaryType="arraybuffer",c.onopen=w,c.onclose=z,c.onerror=F,c.onmessage=G,q=setTimeout(x,OT.Rumor.Socket.CONNECT_TIMEOUT)}catch(h){OT.error(h),v("Could not connect to the Rumor socket, possibly because of a blocked port.")}}};this.disconnect=function(){q&&clearTimeout(q);s&&clearTimeout(s);c?3===c.readyState?this.isNot("error")&&p("disconnected"):(this.is("connected")&&c.send(OT.Rumor.Message.Disconnect().serialize()),u()):this.isNot("error")&&
p("disconnected")};Object.defineProperties(this,{id:{get:function(){return b}},onOpen:{set:function(a){t("onOpen",a);e=a},get:function(){return e}},onError:{set:function(a){t("onError",a);k=a},get:function(){return k}},onClose:{set:function(a){t("onClose",a);h=a},get:function(){return h}},onMessage:{set:function(a){t("onMessage",a);l=a},get:function(){return l}}})};OT.Rumor.Socket.CONNECT_TIMEOUT=15E3}(this);
!function(){OT.Rumor.Message=function(d,a,g,f){this.type=d;this.toAddress=a;this.headers=g;this.data=f;this.transactionId=this.headers["TRANSACTION-ID"];this.status=this.headers.STATUS;this.isError=!(this.status&&"2"===this.status[0])};OT.Rumor.Message.prototype.serialize=function(){var d=8,a=7,g=[],f=[],c=[],b,e,k;a++;for(e=0;e<this.toAddress.length;e++)g.push((new TextEncoder("utf-8")).encode(this.toAddress[e])),a+=2,a+=g[e].length;a++;e=0;for(b in this.headers)this.headers.hasOwnProperty(b)&&(f.push((new TextEncoder("utf-8")).encode(b)),
c.push((new TextEncoder("utf-8")).encode(this.headers[b])),a+=4,a+=f[e].length,a+=c[e].length,e++);b=(new TextEncoder("utf-8")).encode(this.data);var a=a+b.length,h=new ArrayBuffer(a),l=new Uint8Array(h,0,a),a=a-4;l[0]=(a&4278190080)>>>24;l[1]=(a&16711680)>>>16;l[2]=(a&65280)>>>8;l[3]=(a&255)>>>0;l[4]=0;l[5]=0;l[6]=this.type;l[7]=this.toAddress.length;for(e=0;e<g.length;e++){a=g[e];l[d++]=a.length>>8&255;l[d++]=a.length>>0&255;for(k=0;k<a.length;k++)l[d++]=a[k]}l[d++]=f.length;for(e=0;e<f.length;e++){a=
f[e];l[d++]=a.length>>8&255;l[d++]=a.length>>0&255;for(k=0;k<a.length;k++)l[d++]=a[k];a=c[e];l[d++]=a.length>>8&255;l[d++]=a.length>>0&255;for(k=0;k<a.length;k++)l[d++]=a[k]}for(e=0;e<b.length;e++)l[d++]=b[e];return h};OT.Rumor.Message.deserialize=function(d){if("undefined"!==typeof Buffer&&Buffer.isBuffer(d)){var a=d,g=new ArrayBuffer(a.length),f=new Uint8Array(g);for(d=0;d<a.length;++d)f[d]=a[d];d=g}var c=8,b=new Uint8Array(d),e,k,h,l,n,a=b[6],f=[];for(n=0;n<b[7];n++)l=b[c++]<<8,l+=b[c++],e=new Uint8Array(d,
c,l),f[n]=(new TextDecoder("utf-8")).decode(e),c+=l;k=b[c++];g={};for(n=0;n<k;n++)l=b[c++]<<8,l+=b[c++],e=new Uint8Array(d,c,l),h=(new TextDecoder("utf-8")).decode(e),c+=l,l=b[c++]<<8,l+=b[c++],e=new Uint8Array(d,c,l),e=(new TextDecoder("utf-8")).decode(e),g[h]=e,c+=l;d=new Uint8Array(d,c);d=(new TextDecoder("utf-8")).decode(d);return new OT.Rumor.Message(a,f,g,d)};OT.Rumor.Message.Connect=function(d,a){return new OT.Rumor.Message(OT.Rumor.MessageType.CONNECT,[],{uniqueId:d,notifyDisconnectAddress:a},
"")};OT.Rumor.Message.Disconnect=function(){return new OT.Rumor.Message(OT.Rumor.MessageType.DISCONNECT,[],[],"")};OT.Rumor.Message.Subscribe=function(d){return new OT.Rumor.Message(OT.Rumor.MessageType.SUBSCRIBE,d,[],"")};OT.Rumor.Message.Unsubscribe=function(d){return new OT.Rumor.Message(OT.Rumor.MessageType.UNSUBSCRIBE,d,[],"")};OT.Rumor.Message.Publish=function(d,a,g){return new OT.Rumor.Message(OT.Rumor.MessageType.MESSAGE,d,g||[],a)};OT.Rumor.Message.Ping=function(){return new OT.Rumor.Message(OT.Rumor.MessageType.PING,
[],[],"")}}(this);
!function(){OT.Raptor={Actions:{CONNECT:100,CREATE:101,UPDATE:102,DELETE:103,STATE:104,FORCE_DISCONNECT:105,FORCE_UNPUBLISH:106,SIGNAL:107,CREATE_ARCHIVE:108,CLOSE_ARCHIVE:109,START_RECORDING_SESSION:110,STOP_RECORDING_SESSION:111,START_RECORDING_STREAM:112,STOP_RECORDING_STREAM:113,LOAD_ARCHIVE:114,START_PLAYBACK:115,STOP_PLAYBACK:116,APPSTATE_PUT:117,APPSTATE_DELETE:118,OFFER:119,ANSWER:120,PRANSWER:121,CANDIDATE:122,SUBSCRIBE:123,UNSUBSCRIBE:124,QUERY:125,SDP_ANSWER:126,PONG:127,REGISTER:128,QUALITY_CHANGED:129},
Types:{RPC_REQUEST:100,RPC_RESPONSE:101,STREAM:102,ARCHIVE:103,CONNECTION:104,APPSTATE:105,CONNECTIONCOUNT:106,MODERATION:107,SIGNAL:108,SUBSCRIBER:110,JSEP:109}}}(this);
!function(){OT.Raptor.serializeMessage=function(d){return JSON.stringify(d)};OT.Raptor.deserializeMessage=function(d){if(0===d.length)return{};d=JSON.parse(d);var a=d.uri.substr(1).split("/");a.shift();""===a[a.length-1]&&a.pop();d.params={};for(var g=0,f=a.length;g<f-1;g+=2)d.params[a[g]]=a[g+1];d.resource=0===a.length%2?"channel"===a[a.length-2]&&6<a.length?a[a.length-4]+"_"+a[a.length-2]:a[a.length-2]:"channel"===a[a.length-1]&&5<a.length?a[a.length-3]+"_"+a[a.length-1]:a[a.length-1];d.signature=
d.resource+"#"+d.method;return d};OT.Raptor.unboxFromRumorMessage=function(d){var a=OT.Raptor.deserializeMessage(d.data);a.transactionId=d.transactionId;a.fromAddress=d.headers["X-TB-FROM-ADDRESS"];return a};OT.Raptor.Message={};OT.Raptor.Message.connections={};OT.Raptor.Message.connections.create=function(d,a,g){return OT.Raptor.serializeMessage({method:"create",uri:"/v2/partner/"+d+"/session/"+a+"/connection/"+g,content:{userAgent:navigator.userAgent}})};OT.Raptor.Message.connections.destroy=function(d,
a,g){return OT.Raptor.serializeMessage({method:"delete",uri:"/v2/partner/"+d+"/session/"+a+"/connection/"+g,content:{}})};OT.Raptor.Message.sessions={};OT.Raptor.Message.sessions.get=function(d,a){return OT.Raptor.serializeMessage({method:"read",uri:"/v2/partner/"+d+"/session/"+a,content:{}})};OT.Raptor.Message.streams={};OT.Raptor.Message.streams.get=function(d,a,g){return OT.Raptor.serializeMessage({method:"read",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g,content:{}})};OT.Raptor.Message.streams.create=
function(d,a,g,f,c,b,e,k,h,l,n,m){var q=[];void 0!==k&&q.push({id:"audio1",type:"audio",active:k});void 0!==h&&(c={id:"video1",type:"video",active:h,width:b,height:e,orientation:c},l&&(c.frameRate=l),q.push(c));f={id:g,name:f,channel:q};n&&(f.minBitrate=n);m&&(f.maxBitrate=m);return OT.Raptor.serializeMessage({method:"create",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g,content:f})};OT.Raptor.Message.streams.destroy=function(d,a,g){return OT.Raptor.serializeMessage({method:"delete",uri:"/v2/partner/"+
d+"/session/"+a+"/stream/"+g,content:{}})};OT.Raptor.Message.streams.offer=function(d,a,g,f){return OT.Raptor.serializeMessage({method:"offer",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g,content:{sdp:f}})};OT.Raptor.Message.streams.answer=function(d,a,g,f){return OT.Raptor.serializeMessage({method:"answer",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g,content:{sdp:f}})};OT.Raptor.Message.streams.candidate=function(d,a,g,f){return OT.Raptor.serializeMessage({method:"candidate",uri:"/v2/partner/"+
d+"/session/"+a+"/stream/"+g,content:f})};OT.Raptor.Message.streamChannels={};OT.Raptor.Message.streamChannels.update=function(d,a,g,f,c){return OT.Raptor.serializeMessage({method:"update",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g+"/channel/"+f,content:c})};OT.Raptor.Message.subscribers={};OT.Raptor.Message.subscribers.create=function(d,a,g,f,c,b){c={id:f,connection:c,keyManagementMethod:OT.$.supportedCryptoScheme(),bundleSupport:OT.$.supportsBundle(),rtcpMuxSupport:OT.$.supportsRtcpMux()};
b&&(c.channel=b);return OT.Raptor.serializeMessage({method:"create",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g+"/subscriber/"+f,content:c})};OT.Raptor.Message.subscribers.destroy=function(d,a,g,f){return OT.Raptor.serializeMessage({method:"delete",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g+"/subscriber/"+f,content:{}})};OT.Raptor.Message.subscribers.update=function(d,a,g,f,c){return OT.Raptor.serializeMessage({method:"update",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g+"/subscriber/"+
f,content:c})};OT.Raptor.Message.subscribers.candidate=function(d,a,g,f,c){return OT.Raptor.serializeMessage({method:"candidate",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g+"/subscriber/"+f,content:c})};OT.Raptor.Message.subscribers.offer=function(d,a,g,f,c){return OT.Raptor.serializeMessage({method:"offer",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g+"/subscriber/"+f,content:{sdp:c}})};OT.Raptor.Message.subscribers.answer=function(d,a,g,f,c){return OT.Raptor.serializeMessage({method:"answer",
uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g+"/subscriber/"+f,content:{sdp:c}})};OT.Raptor.Message.subscriberChannels={};OT.Raptor.Message.subscriberChannels.update=function(d,a,g,f,c,b){return OT.Raptor.serializeMessage({method:"update",uri:"/v2/partner/"+d+"/session/"+a+"/stream/"+g+"/subscriber/"+f+"/channel/"+c,content:b})};OT.Raptor.Message.signals={};OT.Raptor.Message.signals.create=function(d,a,g,f,c){var b={};void 0!==f&&(b.type=f);void 0!==c&&(b.data=c);return OT.Raptor.serializeMessage({method:"signal",
uri:"/v2/partner/"+d+"/session/"+a+(void 0!==g?"/connection/"+g:"")+"/signal/"+OT.$.uuid(),content:b})}}(this);
!function(){OT.Signal=function(d,a,g){a=function(a){var b=null;null===a||void 0===a?b={code:400,reason:"The signal type was null or undefined. Either set it to a String value or omit it"}:128<a.length?b={code:413,reason:"The signal type was too long, the maximum length of it is 128 characters"}:/^[a-zA-Z0-9\-\._~]+$/.exec(a)||(b={code:400,reason:"The signal type was invalid, it can only contain letters, numbers, '-', '_', and '~'."});return b};var f=function(a){var b=null;if(null===a||void 0===a)b=
{code:400,reason:"The signal data was null or undefined. Either set it to a String value or omit it"};else try{8192<JSON.stringify(a).length&&(b={code:413,reason:"The data field was too long, the maximum size of it is 8192 characters"})}catch(e){b={code:400,reason:"The data field was not valid JSON"}}return b};this.toRaptorMessage=function(){var a=this.to;a&&"string"!==typeof a&&(a=a.id);return OT.Raptor.Message.signals.create(OT.APIKEY,d,a,this.type,this.data)};this.toHash=function(){return g};this.error=
null;g&&(g.hasOwnProperty("data")&&(this.data=OT.$.clone(g.data),this.error=f(this.data)),g.hasOwnProperty("to")&&(this.to=g.to,this.error||(this.error=!this.to?{code:400,reason:"The signal type was null or an empty String. Either set it to a non-empty String value or omit it"}:!(this.to instanceof OT.Connection||this.to instanceof OT.Session)?{code:400,reason:"The To field was invalid"}:null)),g.hasOwnProperty("type")&&(this.error||(this.error=a(g.type)),this.type=g.type));this.valid=null===this.error}}(this);
!function(){function d(a,d){this.code=a;this.reason=d}OT.Raptor.Socket=function(a,g,f,c){var b,e,k,h,l,n=OT.$.statable(this,["disconnected","connecting","connected","error","disconnecting"],"disconnected"),m=function(a){a?n("error"):n("connected");l.apply(null,arguments)},q=function(a){var b=this.is("disconnecting")?"clientDisconnected":"networkDisconnected";a&&4001===a.code&&(b="networkTimedout");n("disconnected");h.onClose(b)}.bind(this),r=function(){};this.connect=function(a,c,d){if(this.is("disconnected",
"error")){n("connecting");b=c.sessionId;e=a;l=d;a=OT.$.uuid();var v="/v2/partner/"+OT.APIKEY+"/session/"+b;k=new OT.Rumor.Socket(g,f);k.onClose=q;k.onMessage=h.dispatch.bind(h);k.connect(a,function(a){a?(a.message="WebSocketConnection:"+a.code+":"+a.message,m(a)):(k.onError=r,OT.debug("Raptor Socket connected. Subscribing to "+v+" on "+g),k.subscribe([v]),a=OT.Raptor.Message.connections.create(OT.APIKEY,b,k.id),this.publish(a,{"X-TB-TOKEN-AUTH":e},function(a){a?(a.message="ConnectToSession:"+a.code+
":Received error response to connection create message.",m(a)):this.publish(OT.Raptor.Message.sessions.get(OT.APIKEY,b),function(a){a&&(a.message="GetSessionState:"+a.code+":Received error response to session read");m.apply(null,arguments)})}.bind(this)))}.bind(this))}else OT.warn("Cannot connect the Raptor Socket as it is currently connected. You should disconnect first.")};this.disconnect=function(){this.is("disconnected")||(n("disconnecting"),k.disconnect())};this.publish=function(a,b,c){if(k.isNot("connected"))OT.error("OT.Raptor.Socket: cannot publish until the socket is connected."+
a);else{var e=OT.$.uuid(),d={},g;b&&(OT.$.isFunction(b)?(d={},g=b):d=b);!g&&(c&&OT.$.isFunction(c))&&(g=c);g&&h.registerCallback(e,g);OT.debug("OT.Raptor.Socket Publish (ID:"+e+") ");OT.debug(a);k.publish([f],a,OT.$.extend(d,{"Content-Type":"application/x-raptor+v2","TRANSACTION-ID":e,"X-TB-FROM-ADDRESS":k.id}));return e}};this.streamCreate=function(a,c,e,d,h,f,g,k,l,m){var n=OT.$.uuid();a=OT.Raptor.Message.streams.create(OT.APIKEY,b,n,a,c,e,d,h,f,g,k,l);this.publish(a,function(a){m(a,n)})};this.streamDestroy=
function(a){this.publish(OT.Raptor.Message.streams.destroy(OT.APIKEY,b,a))};this.streamChannelUpdate=function(a,c,e){this.publish(OT.Raptor.Message.streamChannels.update(OT.APIKEY,b,a,c,e))};this.subscriberCreate=function(a,c,e,d){this.publish(OT.Raptor.Message.subscribers.create(OT.APIKEY,b,a,c,k.id,e),d)};this.subscriberDestroy=function(a,c){this.publish(OT.Raptor.Message.subscribers.destroy(OT.APIKEY,b,a,c))};this.subscriberUpdate=function(a,c,e){this.publish(OT.Raptor.Message.subscribers.update(OT.APIKEY,
b,a,c,e))};this.subscriberChannelUpdate=function(a,c,e,d){this.publish(OT.Raptor.Message.subscriberChannels.update(OT.APIKEY,b,a,c,e,d))};this.forceDisconnect=function(a,c){this.publish(OT.Raptor.Message.connections.destroy(OT.APIKEY,b,a),c)};this.forceUnpublish=function(a,c){this.publish(OT.Raptor.Message.streams.destroy(OT.APIKEY,b,a),c)};this.jsepCandidate=function(a,c){this.publish(OT.Raptor.Message.streams.candidate(OT.APIKEY,b,a,c))};this.jsepCandidateP2p=function(a,c,e){this.publish(OT.Raptor.Message.subscribers.candidate(OT.APIKEY,
b,a,c,e))};this.jsepOffer=function(a,c){this.publish(OT.Raptor.Message.streams.offer(OT.APIKEY,b,a,c))};this.jsepOfferP2p=function(a,c,e){this.publish(OT.Raptor.Message.subscribers.offer(OT.APIKEY,b,a,c,e))};this.jsepAnswer=function(a,c){this.publish(OT.Raptor.Message.streams.answer(OT.APIKEY,b,a,c))};this.jsepAnswerP2p=function(a,c,e){this.publish(OT.Raptor.Message.subscribers.answer(OT.APIKEY,b,a,c,e))};this.signal=function(a,c){var e=new OT.Signal(b,k.id,a||{});e.valid?this.publish(e.toRaptorMessage(),
function(a){var b;a&&(b=new d(a.code,a.message));c&&OT.$.isFunction(c)&&c(b,e.toHash())}):c&&OT.$.isFunction(c)&&c(new d(e.error.code,e.error.reason),e.toHash())};OT.$.defineGetters(this,{id:function(){return k&&k.id},sessionId:function(){return b},dispatcher:function(){return h}});null==c&&(c=new OT.Raptor.Dispatcher);h=c}}(this);
!function(){OT.Raptor.Dispatcher=function(){"undefined"!==typeof EventEmitter?EventEmitter.call(this):(OT.$.eventing(this,!0),this.emit=this.trigger);this.callbacks={}};"undefined"!==typeof EventEmitter&&util.inherits(OT.Raptor.Dispatcher,EventEmitter);OT.Raptor.Dispatcher.prototype.registerCallback=function(d,a){this.callbacks[d]=a};OT.Raptor.Dispatcher.prototype.triggerCallback=function(d){if(d){var a=this.callbacks[d];if(a&&OT.$.isFunction(a)){var g=Array.prototype.slice.call(arguments);g.shift();
a.apply(null,g)}delete this.callbacks[d]}};OT.Raptor.Dispatcher.prototype.onClose=function(d){this.emit("close",d)};OT.Raptor.Dispatcher.prototype.dispatch=function(d){if(d.type===OT.Rumor.MessageType.STATUS){OT.debug("OT.Raptor.dispatch: STATUS");OT.debug(d);var a;d.isError&&(a=new OT.Error(d.status));this.triggerCallback(d.transactionId,a,d)}else switch(d=OT.Raptor.unboxFromRumorMessage(d),OT.debug("OT.Raptor.dispatch "+d.signature),OT.debug(d),d.resource){case "session":this.dispatchSession(d);
break;case "connection":this.dispatchConnection(d);break;case "stream":this.dispatchStream(d);break;case "stream_channel":this.dispatchStreamChannel(d);break;case "subscriber":this.dispatchSubscriber(d);break;case "subscriber_channel":this.dispatchSubscriberChannel(d);break;case "signal":this.dispatchSignal(d);break;case "archive":this.dispatchArchive(d);break;default:OT.warn("OT.Raptor.dispatch: Type "+d.resource+" is not currently implemented")}};OT.Raptor.Dispatcher.prototype.dispatchSession=function(d){switch(d.method){case "read":this.emit("session#read",
d.content,d.transactionId);break;default:OT.warn("OT.Raptor.dispatch: "+d.signature+" is not currently implemented")}};OT.Raptor.Dispatcher.prototype.dispatchConnection=function(d){switch(d.method){case "created":this.emit("connection#created",d.content);break;case "deleted":this.emit("connection#deleted",d.params.connection,d.reason);break;default:OT.warn("OT.Raptor.dispatch: "+d.signature+" is not currently implemented")}};OT.Raptor.Dispatcher.prototype.dispatchStream=function(d){switch(d.method){case "created":this.emit("stream#created",
d.content,d.transactionId);break;case "deleted":this.emit("stream#deleted",d.params.stream,d.reason);break;case "updated":this.emit("stream#updated",d.params.stream,d.content);break;case "generateoffer":case "answer":case "pranswer":case "offer":case "candidate":this.dispatchJsep(d.method,d);break;default:OT.warn("OT.Raptor.dispatch: "+d.signature+" is not currently implemented")}};OT.Raptor.Dispatcher.prototype.dispatchStreamChannel=function(d){switch(d.method){case "updated":this.emit("streamChannel#updated",
d.params.stream,d.params.channel,d.content);break;default:OT.warn("OT.Raptor.dispatch: "+d.signature+" is not currently implemented")}};OT.Raptor.Dispatcher.prototype.dispatchJsep=function(d,a){this.emit("jsep#"+d,a.params.stream,a.fromAddress,a)};OT.Raptor.Dispatcher.prototype.dispatchSubscriberChannel=function(d){switch(d.method){case "updated":this.emit("subscriberChannel#updated",d.params.stream,d.params.channel,d.content);break;case "update":this.emit("subscriberChannel#update",d.params.subscriber,
d.params.stream,d.content);break;default:OT.warn("OT.Raptor.dispatch: "+d.signature+" is not currently implemented")}};OT.Raptor.Dispatcher.prototype.dispatchSubscriber=function(d){switch(d.method){case "created":this.emit("subscriber#created",d.params.stream,d.fromAddress,d.content.id);break;case "deleted":this.dispatchJsep("unsubscribe",d);this.emit("subscriber#deleted",d.params.stream,d.fromAddress);break;case "generateoffer":case "answer":case "pranswer":case "offer":case "candidate":this.dispatchJsep(d.method,
d);break;default:OT.warn("OT.Raptor.dispatch: "+d.signature+" is not currently implemented")}};OT.Raptor.Dispatcher.prototype.dispatchSignal=function(d){"signal"!==d.method?OT.warn("OT.Raptor.dispatch: "+d.signature+" is not currently implemented"):this.emit("signal",d.fromAddress,d.content.type,d.content.data)};OT.Raptor.Dispatcher.prototype.dispatchArchive=function(d){switch(d.method){case "create":this.emit("archive#create",d.content);break;case "updated":this.emit("archive#updated",d.params.archive,
d.content)}}}(this);
(function(d){function a(a,b){var e=a.channel.map(function(a){return new OT.StreamChannel(a)});return new OT.Stream(a.id,a.name,a.creationTime,b.connections.get(a.connection.id),b,e)}function g(c,b){if(!b.streams.has(c.id)){var e=a(c,b);b.streams.add(e);return e}}function f(a,b){if(!b.archives.has(a.id)){var e=new OT.Archive(a.id,a.name,a.status);b.archives.add(e);return e}}OT.publishers=new OT.Collection("guid");OT.subscribers=new OT.Collection("widgetId");OT.sessions=new OT.Collection;d.OT.SessionDispatcher=
function(a){var b=new OT.Raptor.Dispatcher;b.on("close",function(b){var e=a.connection;e&&(e.destroyedReason?OT.debug("OT.Raptor.Socket: Socket was closed but the connection had already been destroyed. Reason: "+e.destroyedReason):e.destroy(b))});b.on("session#read",function(e,d){var l={},n;l.streams=[];l.connections=[];l.archives=[];e.connection.forEach(function(b){n=OT.Connection.fromHash(b);l.connections.push(n);a.connections.add(n)});e.stream.forEach(function(b){l.streams.push(g(b,a))});(e.archive||
e.archives).forEach(function(b){l.archives.push(f(b,a))});a._.subscriberMap={};b.triggerCallback(d,null,l)});b.on("connection#created",function(b){b=OT.Connection.fromHash(b);a.connection&&b.id!==a.connection.id&&a.connections.add(b)});b.on("connection#deleted",function(b,e){b=a.connections.get(b);b.destroy(e)});b.on("stream#created",function(e,d){e=g(e,a);e.publisher&&(e.publisher.stream=e);b.triggerCallback(d,null,e)});b.on("stream#deleted",function(b,e){var d=a.streams.get(b);d?d.destroy(e):OT.error("OT.Raptor.dispatch: A stream does not exist with the id of "+
b+", for stream#deleted message!")});b.on("stream#updated",function(b,e){var d=a.streams.get(b);d?d._.update(e):OT.error("OT.Raptor.dispatch: A stream does not exist with the id of "+b+", for stream#updated message!")});b.on("streamChannel#updated",function(b,e,d){var f;!b||!(f=a.streams.get(b))?OT.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for streamChannel message!"):f._.updateChannel(e,d)});var e=function(a,b,c,e){var d,f;switch(a){case "offer":f=[];
(b=OT.subscribers.find({streamId:b}))&&f.push(b);break;case "answer":case "pranswer":case "generateoffer":case "unsubscribe":console.warn("generateoffer maybe?");f=OT.publishers.where({streamId:b});break;case "candidate":f=OT.publishers.where({streamId:b}).concat(OT.subscribers.where({streamId:b}));break;default:OT.warn("OT.Raptor.dispatch: jsep#"+a+" is not currently implemented");return}if(0!==f.length){d=f[0].session.connections.get(c);if(!d&&c.match(/^symphony\./))d=OT.Connection.fromHash({id:c,
creationTime:Date.now()}),f[0].session.connections.add(d);else if(!d){OT.warn("OT.Raptor.dispatch: Messsage comes from a connection ("+c+") that we do not know about. The message was ignored.");return}f.forEach(function(b){b.processMessage(a,d,e)})}};b.on("jsep#offer",e.bind(null,"offer"));b.on("jsep#answer",e.bind(null,"answer"));b.on("jsep#pranswer",e.bind(null,"pranswer"));b.on("jsep#generateoffer",e.bind(null,"generateoffer"));b.on("jsep#unsubscribe",e.bind(null,"unsubscribe"));b.on("jsep#candidate",
e.bind(null,"candidate"));b.on("subscriberChannel#updated",function(b,e,d){!b||!a.streams.has(b)?OT.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for subscriberChannel#updated message!"):a.streams.get(b)._.updateChannel(e,d)});b.on("subscriberChannel#update",function(b,e,d){!e||!a.streams.has(e)?OT.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for subscriberChannel#update message!"):OT.subscribers.has(b)?OT.subscribers.get(b).disableVideo(d.active):
OT.error("OT.Raptor.dispatch: Unable to determine subscriberId, or the subscriber does not exist, for subscriberChannel#update message!")});b.on("subscriber#created",function(b,e,d){(b=b?a.streams.get(b):null)?a._.subscriberMap[e+"_"+b.id]=d:OT.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for subscriber#created message!")});b.on("subscriber#deleted",function(b,e){var d=b?a.streams.get(b):null;d?delete a._.subscriberMap[e+"_"+d.id]:OT.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for subscriber#created message!")});
b.on("signal",function(b,e,d){a._.dispatchSignal(a.connections.get(b),e,d)});b.on("archive#create",function(b){f(b,a)});b.on("archive#updated",function(b,e){var d=a.archives.get(b);d?d._.update(e):OT.error("OT.Raptor.dispatch: An archive does not exist with the id of "+b+", for archive#updated message!")});return b}})(window);
!function(d){var a=new function(){var a=!1,f=!1,c=function(){f&&a&&OT.dispatchEvent(new OT.EnvLoadedEvent(OT.Event.names.ENV_LOADED))},b=function(){f=!0;OT.$.on(d,"unload",function(){OT.publishers.destroy();OT.subscribers.destroy();OT.sessions.destroy()});OT.Config.load(OT.properties.configURL);c()},e=function(){a=!0;OT.Config.off("dynamicConfigChanged",e);OT.Config.off("dynamicConfigLoadFailed",k);c()},k=function(){e()};OT.Config.on("dynamicConfigChanged",e);OT.Config.on("dynamicConfigLoadFailed",
k);"complete"===document.readyState||"interactive"===document.readyState&&document.body?b():document.addEventListener?document.addEventListener("DOMContentLoaded",b,!1):document.attachEvent&&document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&b()});this.onLoad=function(b){if(f&&a)b();else OT.on(OT.Event.names.ENV_LOADED,b)}};OT.onLoad=function(d,f){if(f)a.onLoad(d.bind(f));else a.onLoad(d)}}(window);
!function(){function d(d,c,b,e){var k=a[b];e=e?OT.$.clone(e):{};OT.error("OT.exception :: title: "+k+" ("+b+") msg: "+c);e.partnerId||(e.partnerId=OT.APIKEY);try{g||(g=new OT.Analytics),g.logError(b,"tb.exception",k,{details:c},e),OT.dispatchEvent(new OT.ExceptionEvent(OT.Event.names.EXCEPTION,c,k,b,d,d))}catch(h){OT.error("OT.exception :: Failed to dispatch exception - "+h.toString())}}OT.Error=function(a,c){this.code=a;this.message=c};var a={1004:"Authentication error",1005:"Invalid Session ID",
1006:"Connect Failed",1007:"Connect Rejected",1008:"Connect Time-out",1009:"Security Error",1010:"Not Connected",1011:"Invalid Parameter",1012:"Peer-to-peer Stream Play Failed",1013:"Connection Failed",1014:"API Response Failure",1500:"Unable to Publish",1520:"Unable to Force Disconnect",1530:"Unable to Force Unpublish",2E3:"Internal Error",2001:"Embed Failed",4E3:"WebSocket Connection Failed",4001:"WebSocket Network Disconnected"},g;OT.handleJsException=function(a,c,b){b=b||{};var e,g=b.session;
g?(e={sessionId:g.sessionId},g.connected&&(e.connectionId=g.connection.connectionId),b.target||(b.target=g)):b.sessionId&&(e={sessionId:b.sessionId},b.target||(b.target=null));d(b.target,a,c,e)};OT.exceptionHandler=function(a,c,b,e,g){var h;a&&((h=OT.components[a])||OT.warn("Could not find the component with component ID "+a));d(h,c,e,g)};OT.dispatchError=function(a,c,b,e){OT.error(a,c);b&&OT.$.isFunction(b)&&b.call(null,new OT.Error(a,c));OT.handleJsException(c,a,{session:e})}}(window);
!function(){OT.ConnectionCapabilities=function(d){d.supportsWebRTC=OT.$.castToBoolean(d.supportsWebRTC);this.supportsWebRTC=d.supportsWebRTC}}(window);
!function(){OT.Connection=function(d,a,g,f,c){var b;this.id=this.connectionId=d;this.creationTime=a?Number(a):null;this.data=g;this.capabilities=new OT.ConnectionCapabilities(f);this.permissions=new OT.Capabilities(c);this.quality=null;OT.$.eventing(this);this.destroy=function(a,c){b=a||"clientDisconnected";!0!==c&&this.dispatchEvent(new OT.DestroyedEvent("destroyed",this,b))}.bind(this);Object.defineProperties(this,{destroyed:{get:function(){return void 0!==b},enumerable:!0},destroyedReason:{get:function(){return b},
enumerable:!0}})};OT.Connection.fromHash=function(d){return new OT.Connection(d.id,d.creationTime,d.data,OT.$.extend(d.capablities||{},{supportsWebRTC:!0}),d.permissions||[])}}(window);
!function(){OT.StreamChannel=function(d){this.id=d.id;this.type=d.type;this.active=OT.$.castToBoolean(d.active);this.orientation=d.orientation||OT.VideoOrientation.ROTATED_NORMAL;d.frameRate&&(this.frameRate=parseFloat(d.frameRate,10));this.width=parseInt(d.width,10);this.height=parseInt(d.height,10);OT.$.eventing(this,!0);this.update=function(a){var d={},f={},c;for(c in a)if(a.hasOwnProperty(c)){var b=this[c];switch(c){case "active":this.active=OT.$.castToBoolean(a[c]);break;case "frameRate":this.frameRate=
parseFloat(a[c],10);break;case "width":case "height":this[c]=parseInt(a[c],10);d[c]=this[c];f[c]=b;break;case "orientation":this[c]=a[c];d[c]=this[c];f[c]=b;break;default:OT.warn("Tried to update unknown key "+c+" on "+this.type+" channel "+this.id);return}this.trigger("update",this,c,b,this[c])}Object.keys(d).length&&this.trigger("update",this,"videoDimensions",f,d);return!0}}}(window);
!function(){var d=["name","archiving"];OT.Stream=function(a,g,f,c,b,e){var k;this.id=this.streamId=a;this.name=g;this.creationTime=Number(f);this.connection=c;this.channel=e;this.publisherId=(this.publisher=OT.publishers.find({streamId:this.id}))?this.publisher.id:null;OT.$.eventing(this);a=function(a,b,c,e){switch(b){case "active":b="audio"===a.type?"hasAudio":"hasVideo";this[b]=e;break;case "orientation":case "width":case "height":this.videoDimensions={width:a.width,height:a.height,orientation:a.orientation};
return}this.dispatchEvent(new OT.StreamUpdatedEvent(this,b,c,e))}.bind(this);var h=function(){return this.publisher?this.publisher:OT.subscribers.find(function(a){return a.streamId===this.id&&a.session.id===b.id})}.bind(this);this.getChannelsOfType=function(a){return this.channel.filter(function(b){return b.type===a})};this.getChannel=function(a){for(var b=0;b<this.channel.length;++b)if(this.channel[b].id===a)return this.channel[b];return null};g=this.getChannelsOfType("audio")[0];f=this.getChannelsOfType("video")[0];
this.hasAudio=null!=g&&g.active;this.hasVideo=null!=f&&f.active;this.videoDimensions={};f&&(this.videoDimensions.width=f.width,this.videoDimensions.height=f.height,this.videoDimensions.orientation=f.orientation,f.on("update",a));if(g)g.on("update",a);this.setChannelActiveState=function(a,b,c){b={active:b};c&&(b.activeReason=c);l(a,b)};this.setRestrictFrameRate=function(a){l("video",{restrictFrameRate:a})};var l=function(a,c){var e;if(this.publisher)e=function(a){b._.streamChannelUpdate(this,a,c)};
else{var d=OT.subscribers.find(function(a){return a.streamId===this.id&&a.session.id===b.id},this);e=function(a){b._.subscriberChannelUpdate(this,d,a,c)}}this.getChannelsOfType(a).forEach(e.bind(this))}.bind(this);this.destroy=function(a,b){k=a||"clientDisconnected";!0!==b&&this.dispatchEvent(new OT.DestroyedEvent("destroyed",this,k))};Object.defineProperties(this,{destroyed:{get:function(){return void 0!==k},enumerable:!0},destroyedReason:{get:function(){return k},enumerable:!0},frameRate:{get:function(){return this.getChannelsOfType("video")[0].frameRate},
enumerable:!0}});this._={};this._.updateProperty=function(a,b){if(-1===d.indexOf(a))OT.warn('Unknown stream property "'+a+'" was modified to "'+b+'".');else{var c=this[a];switch(a){case "name":this[a]=b;break;case "archiving":var e=h();e&&e._.archivingStatus(b);this[a]=b}c=new OT.StreamUpdatedEvent(this,a,c,b);this.dispatchEvent(c)}}.bind(this);this._.update=function(a){for(var b in a)a.hasOwnProperty(b)&&this._.updateProperty(b,a[b])}.bind(this);this._.updateChannel=function(a,b){this.getChannel(a).update(b)}.bind(this)}}(window);
!function(){OT.Archive=function(d,a,g){this.id=d;this.name=a;this.status=g;this._={};OT.$.eventing(this);this._.update=function(a){for(var c in a)if(a.hasOwnProperty(c)){var b=this[c];this[c]=a[c];b=new OT.ArchiveUpdatedEvent(this,c,b,this[c]);this.dispatchEvent(b)}}.bind(this);this.destroy=function(){}}}(window);
!function(d){var a=d.mozRTCSessionDescription||d.RTCSessionDescription,g=d.mozRTCIceCandidate||d.RTCIceCandidate,f=d.AudioContext||d.webkitAudioContext,c=function(a){return function(b){b.candidate?a(OT.Raptor.Actions.CANDIDATE,b.candidate):OT.debug("IceCandidateForwarder: No more ICE candidates.")}},b=function(){var a=[],b=null;Object.defineProperty(this,"peerConnection",{set:function(a){b=a}});this.process=function(c){c=new g(c.content);b?b.addIceCandidate(c):a.push(c)};this.processPending=function(){for(;a.length;)b.addIceCandidate(a.shift())}},
e=function(a){var b=/a=rtpmap:(\d+) CN\/\d+/i,c=[],e,d;a=a.split("\r\n").filter(function(a,f){-1!==a.indexOf("m\x3daudio")&&(e=f);d=a.match(b);return null!==d?(c.push(d[1]),!1):!0});c.length&&e&&(a[e]=a[e].replace(RegExp(c.join("|"),"ig"),"").replace(/\s+/g," "));return a.join("\r\n")},k=function(a,b,c,d){var f,h;f=function(a,b){return function(c){OT.error(a);OT.error(c);d&&d(a,c,b)}};h=function(b){b.sdp=e(b.sdp);a.setLocalDescription(b,function(){c(b)},f("Error while setting LocalDescription","SetLocalDescription"))};
-1===b.sdp.indexOf("a\x3dcrypto")&&(b.sdp=b.sdp.replace(/^c=IN(.*)$/gmi,"c\x3dIN$1\r\na\x3dcrypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\\r\\n"));-1===b.sdp.indexOf("a\x3drtcp-fb")&&(b.sdp=b.sdp.replace(/^m=video(.*)$/gmi,"m\x3dvideo$1\r\na\x3drtcp-fb:* ccm fir\r\na\x3drtcp-fb:* nack "));a.setRemoteDescription(b,function(){a.createAnswer(h,f("Error while setting createAnswer","CreateAnswer"),null,!1)},f("Error while setting RemoteDescription","SetRemoteDescription"))},
h=function(a,b,c){var d,f;d={mandatory:{},optional:[]};f=function(a,b){return function(e){OT.error(a);OT.error(e);c&&c(a,e,b)}};navigator.mozGetUserMedia&&(d.mandatory.MozDontOfferDataChannel=!0);a.createOffer(function(c){c.sdp=e(c.sdp);a.setLocalDescription(c,function(){b(c)},f("Error while setting LocalDescription","SetLocalDescription"))},f("Error while creating Offer","CreateOffer"),d)};OT.PeerConnection=function(e){var g,m=new b,q,r,s="new",p=[],t,v=OT.$.now(),u=new f,C=0;OT.$.eventing(this);
e.iceServers||(e.iceServers=[]);var w=function(a){if(w._treeParametersVersion)g.getStats(null,a,function(a){console.error(a)});else try{g.getStats(a)}catch(b){if(b instanceof TypeError)w._treeParametersVersion=!0,w(a);else throw b;}},x=function(a){a=u.createMediaStreamSource(a);var b=u.createAnalyser(),c=new Uint8Array(b.frequencyBinCount);a.connect(b);var e=setInterval(function(){b.getByteTimeDomainData(c);for(var a=0,e=0;e<c.length;e++)a=Math.max(a,Math.abs(c[e]-127));C=a*OT.PeerConnection.AUDIO_OUTPUT_LEVEL_MAX_VALUE/
255},100);return{cancel:function(){d.clearInterval(e)}}},F=function(a,b){if(p.length)p[0](a,b)}.bind(this),z=function(){if(!g){try{OT.debug('Creating peer connection config "'+JSON.stringify(e)+'".'),g=OT.$.createPeerConnection(e,{optional:[{DtlsSrtpKeyAgreement:!0}]})}catch(a){return J("Failed to create PeerConnection, exception: "+a.message,"NewPeerConnection"),null}g.onicecandidate=c(F);g.onaddstream=K.bind(this);g.onremovestream=H.bind(this);void 0!==g.onsignalingstatechange?g.onsignalingstatechange=
L.bind(this):void 0!==g.onstatechange&&(g.onstatechange=L.bind(this));void 0!==g.oniceconnectionstatechange&&(g.oniceconnectionstatechange=function(a){"failed"===a.target.iceConnectionState&&setTimeout(function(){"failed"===a.target.iceConnectionState&&J("The stream was unable to connect due to a network error. Make sure your connection isn't blocked by a firewall.","ICEWorkflow")},5E3)})}return g}.bind(this),G=function(){m&&(m.peerConnection=null);null!==g&&(g=null,this.trigger("close"))},L=function(a){a=
"string"===typeof a?a:a.target&&a.target.signalingState?a.target.signalingState:a.target.readyState;OT.debug("PeerConnection.stateChange: "+a);if(a&&a.toLowerCase()!==s)switch(s=a.toLowerCase(),OT.debug("PeerConnection.stateChange: "+s),s){case "closed":G.call(this)}},K=function(a){this.trigger("streamAdded",a.stream)},H=function(a){this.trigger("streamRemoved",a.stream)},D=function(b){b=new a({type:"offer",sdp:b.content.sdp});z();k(g,b,function(a){m.peerConnection=g;m.processPending();F(OT.Raptor.Actions.ANSWER,
a)},function(a,b,c){J("PeerConnection.offerProcessor "+a+": "+b,c)})},A=function(b){b.content.sdp?(r=new a({type:"answer",sdp:b.content.sdp}),g.setRemoteDescription(r,function(){OT.debug("setRemoteDescription Success")},function(a){J("Error while setting RemoteDescription "+a,"SetRemoteDescription")}),m.peerConnection=g,m.processPending()):OT.error("PeerConnection.processMessage: Weird answer message, no SDP.")},I=function(){OT.debug("PeerConnection.processSubscribe: Sending offer to subscriber.");
z();h(g,function(a){q=a;F(OT.Raptor.Actions.OFFER,q)},function(a,b,c){J("PeerConnection.suscribeProcessor "+a+": "+b,c)})},J=function(a,b){OT.error(a);this.trigger("error",a,b)}.bind(this);this.addLocalStream=function(a){z();g.addStream(a)};this.disconnect=function(){m=null;if(g){var a=g.signalingState||g.readyState;a&&"closed"!==a.toLowerCase()&&g.close();G.call(this)}this.off()};this.processMessage=function(a,b){OT.debug("PeerConnection.processMessage: Received "+a+" from "+b.fromAddress);OT.debug(b);
switch(a){case "generateoffer":I.call(this,b);break;case "offer":D.call(this,b);break;case "answer":case "pranswer":A.call(this,b);break;case "candidate":m.process(b);break;default:OT.debug("PeerConnection.processMessage: Received an unexpected message of type "+a+" from "+b.fromAddress+": "+JSON.stringify(b))}return this};this.registerMessageDelegate=function(a){return p.push(a)};this.unregisterMessageDelegate=function(a){a=p.indexOf(a);-1!==a&&p.splice(a,1);return p.length};this.getAudioOutputLevel=
function(a){var b=this;w(function(c){if(b.getAudioOutputLevel._noAudioOutputLevelInStats)a(C);else{for(var e=!1,d=c.result?c.result():Object.keys(c).map(function(a){return c[a]}),f=0;f<d.length;f++){var h=d[f];if(h.local&&(h=parseFloat(h.local.stat("audioOutputLevel")),!isNaN(h))){a(h);e=!0;break}}e||(b.getAudioOutputLevel._noAudioOutputLevelInStats=!0,x(g.getRemoteStreams()[0]),b.getAudioOutputLevel(a))}})};this.getStats=function(a,b){var c={},e,f,h,k,l,m,p;!0===t?OT.warn("PeerConnection.getStats: Already getting the stats!"):
(t=!0,e=OT.$.now(),f=(e-a.timeStamp)/1E3,a.timeStamp=e,h=function(b){var c=a.videoBytesTransferred||0;return b.bytesSent||b.bytesReceived?(a.videoBytesTransferred=b.bytesSent||b.bytesReceived,Math.round(8*(a.videoBytesTransferred-c)/f)):b.stat("googFrameHeightSent")?(a.videoBytesTransferred=b.stat("bytesSent"),Math.round(8*(a.videoBytesTransferred-c)/f)):b.stat("googFrameHeightReceived")?(a.videoBytesTransferred=b.stat("bytesReceived"),Math.round(8*(a.videoBytesTransferred-c)/f)):NaN},k=function(b){var c=
a.audioBytesTransferred||0;return b.bytesSent||b.bytesReceived?(a.audioBytesTransferred=b.bytesSent||b.bytesReceived,Math.round(8*(a.audioBytesTransferred-c)/f)):b.stat("audioInputLevel")?(a.audioBytesTransferred=b.stat("bytesSent"),Math.round(8*(a.audioBytesTransferred-c)/f)):b.stat("audioOutputLevel")?(a.audioBytesTransferred=b.stat("bytesReceived"),Math.round(8*(a.audioBytesTransferred-c)/f)):NaN},l=function(a){return a.stat("googFrameRateSent")?a.stat("googFrameRateSent"):a.stat("googFrameRateReceived")?
a.stat("googFrameRateReceived"):null},m=function(a){if(a.result){a=a.result();for(var e=0;e<a.length;e++){var d=a[e];if(d.stat){"true"===d.stat("googActiveConnection")&&(c.localCandidateType=d.stat("googLocalCandidateType"),c.remoteCandidateType=d.stat("googRemoteCandidateType"),c.transportType=d.stat("googTransportType"));var f=h(d);isNaN(f)||(c.avgVideoBitrate=f);f=k(d);isNaN(f)||(c.avgAudioBitrate=f);d=l(d);null!=d&&(c.frameRate=d)}}}t=!1;b(c)},c.duration=Math.round(e-v),e=function(a){for(var e in a)if(a.hasOwnProperty(e)&&
("outboundrtp"===a[e].type||"inboundrtp"===a[e].type)){var d=a[e];-1!==d.id.indexOf("video")?(d=h(d),isNaN(d)||(c.avgVideoBitrate=d)):-1!==d.id.indexOf("audio")&&(d=k(d),isNaN(d)||(c.avgAudioBitrate=d))}t=!1;b(c)},p=function(){var a=d.navigator.userAgent.toLowerCase().match(/Firefox\/([0-9\.]+)/i),b=null!==a&&27<=parseFloat(a[1],10);p=function(){return b};return b},g&&g.getStats?p()?g.getStats(null,e,function(a){OT.warn("Error collecting stats",a);t=!1}):g.getStats(m):(t=!1,b(c)))};Object.defineProperty(this,
"remoteStreams",{get:function(){var a;if(g){if(g.getRemoteStreams)a=g.getRemoteStreams();else if(g.remoteStreams)a=g.remoteStreams;else throw Error("Invalid Peer Connection object implements no method for retrieving remote streams");a=Array.prototype.slice.call(a)}else a=[];return a}})};OT.PeerConnection.AUDIO_OUTPUT_LEVEL_MAX_VALUE=32767}(window);
!function(){var d={};OT.PeerConnections={add:function(a,g,f){a=a.id+"_"+g;(g=d[a])||(g=d[a]={count:0,pc:new OT.PeerConnection(f)});g.count+=1;return g.pc},remove:function(a,g){var f=a.id+"_"+g,c=d[f];c&&(c.count-=1,0===c.count&&(c.pc.disconnect(),delete d[f]))}}}(window);
!function(){OT.PublisherPeerConnection=function(d,a,g,f){var c,b=!1,e=a._.subscriberMap[d.id+"_"+g],k,h,l;k=function(){this.destroy();this.trigger("disconnected",this)};h=function(a,b){this.trigger("error",null,a,this,b);this.destroy()};l=function(c,d){if(!b&&(c===OT.Raptor.Actions.CANDIDATE||c===OT.Raptor.Actions.OFFER||c===OT.Raptor.Actions.ANSWER||c===OT.Raptor.Actions.PRANSWER))b=-1!==(c===OT.Raptor.Actions.CANDIDATE?d.candidate:d.sdp).indexOf("typ relay");switch(c){case OT.Raptor.Actions.ANSWER:case OT.Raptor.Actions.PRANSWER:a.sessionInfo.p2pEnabled?
a._.jsepAnswerP2p(g,e,d.sdp):a._.jsepAnswer(g,d.sdp);break;case OT.Raptor.Actions.OFFER:this.trigger("connected");a.sessionInfo.p2pEnabled?a._.jsepOfferP2p(g,e,d.sdp):a._.jsepOffer(g,d.sdp);break;case OT.Raptor.Actions.CANDIDATE:a.sessionInfo.p2pEnabled?a._.jsepCandidateP2p(g,e,d):a._.jsepCandidate(g,d)}}.bind(this);OT.$.eventing(this);this.destroy=function(){c&&OT.PeerConnections.remove(d,g);c.off();c=null};this.processMessage=function(a,b){c.processMessage(a,b)};this.getStats=function(a,b){c.getStats(a,
b)};this.init=function(){var e=a.sessionInfo.iceServers.map(function(b){b=OT.$.clone(b);"turn:"===b.url.trim().substr(0,5)&&(b.username=a.id+"."+a.connection.id+"."+g);return b});c=OT.PeerConnections.add(d,g,{iceServers:e});c.on({close:k,error:h},this);c.registerMessageDelegate(l);c.addLocalStream(f);Object.defineProperty(this,"remoteConnection",{value:d});Object.defineProperty(this,"hasRelayCandidates",{get:function(){return b}})}}}(window);
!function(){OT.SubscriberPeerConnection=function(d,a,g,f,c){var b,e=!1,k,h,l,n,m,q;k=function(){this.destroy();this.trigger("disconnected",this)};h=function(a){this.trigger("remoteStreamAdded",a,this)};l=function(a){this.trigger("remoteStreamRemoved",a,this)};n=function(a,b){this.trigger("error",null,a,this,b)};m=function(b,c){if(!e&&(b===OT.Raptor.Actions.CANDIDATE||b===OT.Raptor.Actions.OFFER||b===OT.Raptor.Actions.ANSWER||b===OT.Raptor.Actions.PRANSWER))e=-1!==(b===OT.Raptor.Actions.CANDIDATE?
c.candidate:c.sdp).indexOf("typ relay");switch(b){case OT.Raptor.Actions.ANSWER:case OT.Raptor.Actions.PRANSWER:this.trigger("connected");a._.jsepAnswerP2p(g.id,f.widgetId,c.sdp);break;case OT.Raptor.Actions.OFFER:a._.jsepOfferP2p(g.id,f.widgetId,c.sdp);break;case OT.Raptor.Actions.CANDIDATE:a._.jsepCandidateP2p(g.id,f.widgetId,c)}}.bind(this);q=function(a){var c="get"+(a?"Video":"Audio")+"Tracks";return function(a){var e=b.remoteStreams,d;if(0!==e.length&&e[0][c])for(var f=0,h=e.length;f<h;++f){d=
e[f];d=d[c]();for(var g=0,k=d.length;g<k;++g)d[g].enabled=a}}};OT.$.eventing(this);this.destroy=function(){b&&(0===b.unregisterMessageDelegate(m)&&(a&&(a.connected&&g&&!g.destroyed)&&a._.subscriberDestroy(g,f),this.subscribeToAudio(!1)),OT.PeerConnections.remove(d,g.streamId));b=null;this.off()};this.processMessage=function(a,c){b.processMessage(a,c)};this.getAudioOutputLevel=function(a){b.getAudioOutputLevel(a)};this.getStats=function(a,c){b.getStats(a,c)};this.subscribeToAudio=q(!1);this.subscribeToVideo=
q(!0);Object.defineProperty(this,"hasRelayCandidates",{get:function(){return e}});this.init=function(){var e=a.sessionInfo.iceServers.map(function(b){b=OT.$.clone(b);"turn:"===b.url.trim().substr(0,5)&&(b.username=a.id+"."+a.connection.id+"."+g.id);return b});b=OT.PeerConnections.add(d,g.streamId,{iceServers:e});b.on({close:k,streamAdded:h,streamRemoved:l,error:n},this);e=b.registerMessageDelegate(m);if(0<b.remoteStreams.length)b.remoteStreams.forEach(h,this);else if(1===e){var q;if(c.subscribeToVideo||
c.subscribeToAudio)q=g.getChannelsOfType("audio"),e=g.getChannelsOfType("video"),q=q.map(function(a){return{id:a.id,type:a.type,active:c.subscribeToAudio}}).concat(e.map(function(a){return{id:a.id,type:a.type,active:c.subscribeToVideo,restrictFrameRate:void 0!==c.restrictFrameRate?c.restrictFrameRate:!1}}));a._.subscriberCreate(g,f,q,function(a){a&&this.trigger("error",null,a.message,this,"Subscribe")}.bind(this))}}}}(window);
!function(){OT.Chrome=function(d){var a={},g=function(f,c){c.parent=this;c.appendTo(d.parent);a[f]=c;Object.defineProperty(this,f,{get:function(){return a[f]}})};d.parent&&(OT.$.eventing(this),this.destroy=function(){this.off();this.hide();for(var d in a)a[d].destroy()},this.show=function(){for(var d in a)a[d].show()},this.hide=function(){for(var d in a)a[d].hide()},this.set=function(a,c){if("string"===typeof a&&c)g.call(this,a,c);else for(var b in a)a.hasOwnProperty(b)&&g.call(this,b,a[b]);return this})}}(window);
!function(){OT.Chrome.Behaviour||(OT.Chrome.Behaviour={});OT.Chrome.Behaviour.Widget=function(d,a){var g=a||{},f,c;d.setDisplayMode=function(a){a=a||"auto";f!==a&&(OT.$.removeClass(this.domElement,"OT_mode-"+f),OT.$.addClass(this.domElement,"OT_mode-"+a),c=f,f=a)};d.show=function(){this.setDisplayMode(c);if(g.onShow)g.onShow();return this};d.hide=function(){this.setDisplayMode("off");if(g.onHide)g.onHide();return this};d.destroy=function(){if(g.onDestroy)g.onDestroy(this.domElement);this.domElement&&
OT.$.removeElement(this.domElement);return d};d.appendTo=function(a){this.domElement=OT.$.createElement(g.nodeName||"div",g.htmlAttributes,g.htmlContent);if(g.onCreate)g.onCreate(this.domElement);"auto"!==g.mode?d.setDisplayMode(g.mode):(d.setDisplayMode("on"),setTimeout(function(){d.setDisplayMode(g.mode)},2E3));a.appendChild(this.domElement);return d}}}(window);
!function(){OT.Chrome.BackingBar=function(d){function a(){return"on"===g||"on"===f?"on":"mini"===g||"mini"===f?"mini":"mini-auto"===g||"mini-auto"===f?"mini-auto":"auto"===g||"auto"===f?"auto":"off"}var g=d.nameMode,f=d.muteMode,c;Object.defineProperty(this,"domElement",{get:function(){return c},set:function(a){c=a}});OT.Chrome.Behaviour.Widget(this,{mode:a(),nodeName:"div",htmlContent:"",htmlAttributes:{className:"OT_bar OT_edge-bar-item"}});this.setNameMode=function(b){g=b;this.setDisplayMode(a())};
this.setMuteMode=function(b){f=b;this.setDisplayMode(a())}}}(window);
!function(){OT.Chrome.NamePanel=function(d){var a=d.name,g=d.bugMode,f;if(!a||""===a.trim().length)a=null,d.mode="off";Object.defineProperty(this,"domElement",{get:function(){return f},set:function(a){f=a}});Object.defineProperty(this,"name",{set:function(c){a||this.setDisplayMode("auto");a=c;f.innerHTML=a}.bind(this)});this.setBugMode=function(a){g=a;"off"===a?OT.$.addClass(f,"OT_name-no-bug"):OT.$.removeClass(f,"OT_name-no-bug")};OT.Chrome.Behaviour.Widget(this,{mode:d.mode,nodeName:"h1",htmlContent:a,
htmlAttributes:{className:"OT_name OT_edge-bar-item"},onCreate:function(){this.setBugMode(g)}.bind(this)})}}(window);
!function(){OT.Chrome.MuteButton=function(d){var a,g=d.muted||!1,f,c,b;Object.defineProperty(this,"domElement",{get:function(){return f},set:function(a){f=a}});c=function(){g?OT.$.addClass(f,"OT_active"):OT.$.removeClass(f,"OT_active ")};b=function(){g=!g;c();g?this.parent.trigger("muted",this):this.parent.trigger("unmuted",this);return!1};Object.defineProperty(this,"muted",{get:function(){return g},set:function(a){g=a;c()}});OT.Chrome.Behaviour.Widget(this,{mode:d.mode,nodeName:"button",htmlContent:"Mute",
htmlAttributes:{className:g?"OT_edge-bar-item OT_mute OT_active":"OT_edge-bar-item OT_mute"},onCreate:function(c){a=b.bind(this);c.addEventListener("click",a,!1)}.bind(this),onDestroy:function(b){a=null;b.removeEventListener("click",a,!1)}.bind(this)})}}(window);!function(){OT.Chrome.OpenTokButton=function(d){var a;Object.defineProperty(this,"domElement",{get:function(){return a},set:function(d){a=d}});OT.Chrome.Behaviour.Widget(this,{mode:d?d.mode:null,nodeName:"span",htmlContent:"OpenTok",htmlAttributes:{className:"OT_opentok OT_edge-bar-item"}})}}(window);
!function(){OT.Chrome.Archiving=function(d){var a=d.archiving,g=d.archivingStarted||"Archiving on",f=d.archivingEnded||"Archiving off",c=!0,b,e,k,h,l,n,m;Object.defineProperty(this,"domElement",{get:function(){return h},set:function(a){h=a}});n=function(a){k.innerText=a;b.setAttribute("title",a)};m=function(){l&&(clearTimeout(l),l=null);a?OT.$.addClass(e,"OT_active"):OT.$.removeClass(e,"OT_active");OT.$.removeClass(h,"OT_archiving-"+(!a?"on":"off"));OT.$.addClass(h,"OT_archiving-"+(a?"on":"off"));
d.show&&a?(n(g),OT.$.addClass(k,"OT_mode-on"),OT.$.removeClass(k,"OT_mode-auto"),this.setDisplayMode("on"),l=setTimeout(function(){OT.$.addClass(k,"OT_mode-auto");OT.$.removeClass(k,"OT_mode-on")}.bind(this),5E3)):d.show&&!c?(OT.$.addClass(k,"OT_mode-on"),OT.$.removeClass(k,"OT_mode-auto"),this.setDisplayMode("on"),n(f),l=setTimeout(function(){this.setDisplayMode("off")}.bind(this),5E3)):this.setDisplayMode("off")}.bind(this);OT.Chrome.Behaviour.Widget(this,{mode:a&&d.show&&"on"||"off",nodeName:"h1",
htmlAttributes:{className:"OT_archiving OT_edge-bar-item OT_edge-bottom"},onCreate:function(){b=OT.$.createElement("div",{className:"OT_archiving-light-box"},"");e=OT.$.createElement("div",{className:"OT_archiving-light"},"");b.appendChild(e);k=OT.$.createElement("div",{className:"OT_archiving-status OT_mode-on OT_edge-bar-item OT_edge-bottom"},"");h.appendChild(b);h.appendChild(k);m()}});this.setShowArchiveStatus=function(a){d.show=a;h&&m.call(this)};this.setArchiving=function(b){a=b;c=!1;h&&m.call(this)}}}(window);
!function(){OT.Chrome.Meter=function(){var d=function(){},a;Object.defineProperty(this,"domElement",{get:function(){return a},set:function(d){a=d}});var g;Object.defineProperty(this,"value",{get:function(){return g},set:function(a){g=a;window.requestAnimationFrame(function(){d()})}});OT.Chrome.Behaviour.Widget(this,{nodeName:"div",htmlContent:'\x3cdiv class\x3d"OT_meter-bar"\x3e\x3c/div\x3e',htmlAttributes:{className:"OT_meter"},onCreate:function(){var f=a.querySelector(".OT_meter-bar");d=function(){f.style.width=
100*g+"%"}}})}}(window);
(function(){OT.StylableComponent=function(a,g){if(!a.trigger)throw Error("OT.StylableComponent is dependent on the mixin OT.$.eventing. Ensure that this is included in the object before StylableComponent.");var f=new d(g,function(c,b,e){e?a.trigger("styleValueChanged",c,b,e):a.trigger("styleValueChanged",c,b)});a.getStyle=function(a){return f.get(a)};a.setStyle=function(a,b,e){"string"!==typeof a?f.setAll(a,e):f.set(a,b);return this}};var d=function(a,d){var f={},c,b,e,k;c="showMicButton showSpeakerButton nameDisplayMode buttonDisplayMode backgroundImageURI bugDisplayMode".split(" ");
b={buttonDisplayMode:["auto","mini","mini-auto","off","on"],nameDisplayMode:["auto","off","on"],bugDisplayMode:["auto","off","on"],showSettingsButton:[!0,!1],showMicButton:[!0,!1],backgroundImageURI:null,showControlBar:[!0,!1],showArchiveStatus:[!0,!1]};e=function(a,c){return"backgroundImageURI"===a||b.hasOwnProperty(a)&&-1!==b[a].indexOf(c)};k=function(a){switch(a){case "true":return!0;case "false":return!1;default:return a}};this.getAll=function(){var a=OT.$.clone(f),b;for(b in a)a.hasOwnProperty(b)&&
0>c.indexOf(b)&&delete a[b];return a};this.get=function(a){return a?f[a]:this.getAll()};this.setAll=function(a,b){var c,m,q;for(q in a)a.hasOwnProperty(q)&&(m=k(a[q]),e(q,m)?(c=f[q],m!==c&&(f[q]=m,b||d(q,m,c))):OT.warn("Style.setAll::Invalid style property passed "+q+" : "+m));return this};this.set=function(a,b){OT.debug("Publisher.setStyle: "+a.toString());var c=k(b),m;if(!e(a,c))return OT.warn("Style.set::Invalid style property passed "+a+" : "+c),this;m=f[a];c!==m&&(f[a]=c,d(a,b,m));return this};
a&&this.setAll(a,!0)}})(window);!function(){OT.Microphone=function(d,a){var g,f=50;Object.defineProperty(this,"muted",{get:function(){return g},set:function(a){if(g!==a){g=a;a=d.getAudioTracks();for(var b=0,e=a.length;b<e;++b)a[b].enabled=!g}}});Object.defineProperty(this,"gain",{get:function(){return f},set:function(a){OT.warn("OT.Microphone.gain IS NOT YET IMPLEMENTED");f=a}});void 0!==a?this.muted=!0===a:d.getAudioTracks().length?this.muted=!d.getAudioTracks()[0].enabled:this.muted=!1}}(window);
!function(){OT.generateSimpleStateMachine=function(d,a,g){var f=a.slice(),c=OT.$.clone(g);return function(a){function e(c,d){a({message:c,newState:d,currentState:g,previousState:h})}var g=d,h=null;this.set=function(a){var b;-1!==f.indexOf(a)?c[g]&&-1!==c[g].indexOf(a)?b=!0:(e("'"+g+"' cannot transition to '"+a+"'",a),b=!1):(e("'"+a+"' is not a valid state",a),b=!1);b&&(h=g,g=a)};Object.defineProperties(this,{current:{get:function(){return g}},subscribing:{get:function(){return"Subscribing"===g}}})}}}(window);
!function(){OT.SubscribingState=OT.generateSimpleStateMachine("NotSubscribing","NotSubscribing Init ConnectingToPeer BindingRemoteStream Subscribing Failed".split(" "),{NotSubscribing:["NotSubscribing","Init"],Init:["NotSubscribing","ConnectingToPeer","BindingRemoteStream"],ConnectingToPeer:["NotSubscribing","BindingRemoteStream","Failed"],BindingRemoteStream:["NotSubscribing","Subscribing","Failed"],Subscribing:["NotSubscribing","Failed"],Failed:[]});Object.defineProperty(OT.SubscribingState.prototype,
"attemptingToSubscribe",{get:function(){return-1!==["Init","ConnectingToPeer","BindingRemoteStream"].indexOf(this.current)}})}(window);
!function(){OT.PublishingState=OT.generateSimpleStateMachine("NotPublishing","NotPublishing GetUserMedia BindingMedia MediaBound PublishingToSession Publishing Failed".split(" "),{NotPublishing:["NotPublishing","GetUserMedia"],GetUserMedia:["BindingMedia","Failed","NotPublishing"],BindingMedia:["MediaBound","Failed","NotPublishing"],MediaBound:["NotPublishing","PublishingToSession","Failed"],PublishingToSession:["NotPublishing","Publishing","Failed"],Publishing:["NotPublishing","MediaBound","Failed"],
Failed:[]});Object.defineProperties(OT.PublishingState.prototype,{attemptingToPublish:{get:function(){return-1!==["GetUserMedia","BindingMedia","MediaBound","PublishingToSession"].indexOf(this.current)}},publishing:{get:function(){return"Publishing"===this.current}}})}(window);
!function(){var d={audio:!0,video:!0};OT.Publisher=function(){if(OT.checkSystemRequirements()){var a=OT.Publisher.nextId(),g,f,c,b,e,k,h,l={},n=!1,m,q,r,s,p=new OT.Analytics,t,v=[1,7,15,30],u={},C,w;t={"320x240":{width:320,height:240},"640x480":{width:640,height:480},"1280x720":{width:1280,height:720}};C={timeStamp:OT.$.now()};OT.$.eventing(this);OT.StylableComponent(this,{showMicButton:!0,showArchiveStatus:!0,nameDisplayMode:"auto",buttonDisplayMode:"auto",bugDisplayMode:"auto",backgroundImageURI:null});
var x=function(c,d,e,f){p.logEvent({action:c,variation:d,payload_type:e,payload:f,session_id:h?h.sessionId:null,connection_id:h&&h.connected?h.connection.connectionId:null,partner_id:h?h.apiKey:OT.APIKEY,streamId:b?b.id:null,widget_id:a,widget_type:"Publisher"})},F=function(c){var d={widget_type:"Publisher",stream_type:"WebRTC",sessionId:h?h.sessionId:null,connectionId:h&&h.connected?h.connection.connectionId:null,partnerId:h?h.apiKey:OT.APIKEY,streamId:b?b.id:null,widgetId:a,version:OT.properties.version,
media_server_name:h?h.sessionInfo.messagingServer:null,p2pFlag:h?h.sessionInfo.p2pEnabled:!1,duration:q?(new Date).getTime()-q.getTime():0,remote_connection_id:c};l[c].getStats(C,function(a){var b;if(a)for(b in a)d[b]=a[b];p.logQOS(d)})},z=function(){OT.debug("OT.Publisher.onLoaded");w.set("MediaBound");f.loading=!1;n=!0;"off"===this.getStyle("bugDisplayMode")&&x("bugDisplayMode","createChrome","mode","off");this.getStyle("showArchiveStatus")||x("showArchiveStatus","createChrome","mode","off");s=
(new OT.Chrome({parent:f.domElement})).set({backingBar:new OT.Chrome.BackingBar({nameMode:this.getStyle("nameDisplayMode"),muteMode:O.call(this,this.getStyle("showMicButton"))}),name:new OT.Chrome.NamePanel({name:m.name,mode:this.getStyle("nameDisplayMode"),bugMode:this.getStyle("bugDisplayMode")}),muteButton:new OT.Chrome.MuteButton({muted:!1===m.publishAudio,mode:O.call(this,this.getStyle("showMicButton"))}),opentokButton:new OT.Chrome.OpenTokButton({mode:this.getStyle("bugDisplayMode")}),archive:new OT.Chrome.Archiving({show:this.getStyle("showArchiveStatus"),
archiving:!1})}).on({muted:this.publishAudio.bind(this,!1),unmuted:this.publishAudio.bind(this,!0)});this.trigger("initSuccess");this.trigger("loaded",this)},G=function(a){x("publish","Failure","reason","Publisher PeerConnection Error: "+a);w.set("Failed");this.trigger("publishComplete",new OT.Error(OT.ExceptionCodes.P2P_CONNECTION_FAILED,"Publisher PeerConnection Error: "+a));OT.handleJsException("Publisher PeerConnection Error: "+a,OT.ExceptionCodes.P2P_CONNECTION_FAILED,{session:h,target:this})},
L=function(a){OT.debug("OT.Publisher.onStreamAvailable");w.set("BindingMedia");k&&(k.stop(),k=null);k=a;r=new OT.Microphone(k,!m.publishAudio);this.publishVideo(m.publishVideo&&0<k.getVideoTracks().length);this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_ALLOWED,!1));c=new OT.VideoElement({attributes:{muted:!0}});c.on({streamBound:z,loadError:G,error:M},this).bindToStream(k);f.video=c},K=function(a){OT.error("OT.Publisher.onStreamAvailableError "+a.name+": "+a.message);w.set("Failed");this.trigger("publishComplete",
new OT.Error(OT.ExceptionCodes.UNABLE_TO_PUBLISH,a.message));f&&f.destroy();x("publish","Failure","reason","GetUserMedia:Publisher failed to access camera/mic: "+a.message);OT.handleJsException("Publisher failed to access camera/mic: "+a.message,OT.ExceptionCodes.UNABLE_TO_PUBLISH,{session:h,target:this})},H=function(a){OT.error("OT.Publisher.onStreamAvailableError Permission Denied");w.set("Failed");this.trigger("publishComplete",new OT.Error(OT.ExceptionCodes.UNABLE_TO_PUBLISH,"Publisher Access Denied: Permission Denied"+
(a.message?": "+a.message:"")));x("publish","Failure","reason","GetUserMedia:Publisher Access Denied: Permission Denied");var b=OT.$.browserVersion(),c=new OT.Event(OT.Event.names.ACCESS_DENIED);this.dispatchEvent(c,function(){c.isDefaultPrevented()||("Chrome"===b.browser?(f&&f.addError("",null,"OT_publisher-denied-chrome"),I?OT.Dialogs.AllowDeny.Chrome.deniedNow():OT.Dialogs.AllowDeny.Chrome.previouslyDenied(window.location.hostname)):"Firefox"===b.browser&&(f&&f.addError("","Click the reload button in the URL bar to change camera \x26 mic settings.",
"OT_publisher-denied-firefox"),OT.Dialogs.AllowDeny.Firefox.denied().on({refresh:function(){window.location.reload()}})))})},D,A,I=!1,J=function(){I=!0;x("accessDialog","Opened","","");var a=OT.$.browserVersion();this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_DIALOG_OPENED,!0),function(b){b.isDefaultPrevented()||("Chrome"===a.browser?D=OT.Dialogs.AllowDeny.Chrome.initialPrompt():"Firefox"===a.browser&&(A=setTimeout(function(){D=OT.Dialogs.AllowDeny.Firefox.maybeDenied()},7E3)))})},E=function(){x("accessDialog",
"Closed","","");A&&(clearTimeout(A),A=null);D&&(D.close(),D=null);this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_DIALOG_CLOSED,!1))},M=function(a,b){OT.error("OT.Publisher.onVideoError");var c=b+(a?" ("+a+")":"");x("stream",null,"reason","Publisher while playing stream: "+c);w.set("Failed");w.attemptingToPublish?this.trigger("publishComplete",new OT.Error(OT.ExceptionCodes.UNABLE_TO_PUBLISH,c)):this.trigger("error",c);OT.handleJsException("Publisher error playing stream: "+c,OT.ExceptionCodes.UNABLE_TO_PUBLISH,
{session:h,target:this})},P=function(a){OT.debug("OT.Subscriber has been disconnected from the Publisher's PeerConnection");this.cleanupSubscriber(a.remoteConnection.id)},N=function(a,b,c,d){x("publish","Failure","reason|hasRelayCandidates",(d?d:"")+[":Publisher PeerConnection with connection "+(c&&c.remoteConnection&&c.remoteConnection.id)+" failed: "+b,c.hasRelayCandidates].join("|"));OT.handleJsException("Publisher PeerConnection Error: "+b,OT.ExceptionCodes.UNABLE_TO_PUBLISH,{session:h,target:this});
clearInterval(u[c.remoteConnection.id]);delete u[c.remoteConnection.id];delete l[c.remoteConnection.id]},Q=function(a){b=a;b.on("destroyed",this.disconnect,this);w.set("Publishing");q=new Date;this.trigger("publishComplete",null,this);this.dispatchEvent(new OT.StreamEvent("streamCreated",a,null,!1));x("publish","Success","streamType:streamId","WebRTC:"+e)}.bind(this),y=function(a){var b=l[a.id];if(!b){var c=OT.$.now();x("createPeerConnection","Attempt","","");a.on("destroyed",this.cleanupSubscriber.bind(this,
a.id));b=l[a.id]=new OT.PublisherPeerConnection(a,h,e,k);b.on({connected:function(){x("createPeerConnection","Success","pcc|hasRelayCandidates",[parseInt(OT.$.now()-c,10),b.hasRelayCandidates].join("|"));u[a.id]=setInterval(function(){F(a.id)},3E4)},disconnected:P,error:N},this);b.init()}return b},O=function(a){if(!1===a)return"off";a=this.getStyle("buttonDisplayMode");return!1===a?"on":a},B=function(){s&&(s.destroy(),s=null);this.disconnect();r=null;c&&(c.destroy(),c=null);k&&(k.stop(),k=null);f&&
(f.destroy(),f=null);this.session&&this._.unpublishFromSession(this.session,"reset");for(var a in u)clearInterval(u[a]),delete u[a];b=g=null;n=!1;h=null;w.set("NotPublishing")}.bind(this);this.publish=function(a,b){OT.debug("OT.Publisher: publish");(w.attemptingToPublish||w.publishing)&&B();w.set("GetUserMedia");m=OT.$.defaults(b||{},{publishAudio:!0,publishVideo:!0,mirror:!0});m.constraints?OT.warn("You have passed your own constraints not using ours"):(m.constraints=OT.$.clone(d),m.resolution&&
(void 0!==m.resolution&&!t.hasOwnProperty(m.resolution)?OT.warn("Invalid resolution passed to the Publisher. Got: "+m.resolution+' expecting one of "'+Object.keys(t).join('","')+'"'):(m.videoDimensions=t[m.resolution],m.constraints.video={mandatory:{},optional:[{minWidth:m.videoDimensions.width},{maxWidth:m.videoDimensions.width},{minHeight:m.videoDimensions.height},{maxHeight:m.videoDimensions.height}]})),void 0!==m.frameRate&&-1===v.indexOf(m.frameRate)?(OT.warn("Invalid frameRate passed to the publisher got: "+
m.frameRate+" expecting one of "+v.join(",")),delete m.frameRate):m.frameRate&&(m.constraints.video.optional||("object"!==typeof m.constraints.video&&(m.constraints.video={}),m.constraints.video.optional=[]),m.constraints.video.optional.push({minFrameRate:m.frameRate}),m.constraints.video.optional.push({maxFrameRate:m.frameRate})));m.style&&this.setStyle(m.style,null,!0);m.name&&(m.name=m.name.toString());m.classNames="OT_root OT_publisher";OT.onLoad(function(){f=new OT.WidgetView(a,m);g=f.domId;
OT.$.getUserMedia(m.constraints,L.bind(this),K.bind(this),J.bind(this),E.bind(this),H.bind(this))},this);return this};this.publishAudio=function(a){m.publishAudio=a;r&&(r.muted=!a);s&&(s.muteButton.muted=!a);h&&b&&b.setChannelActiveState("audio",a);return this};this.publishVideo=function(a){var c=m.publishVideo;m.publishVideo=a;h&&(b&&m.publishVideo!==c)&&b.setChannelActiveState("video",a);if(k)for(var c=k.getVideoTracks(),d=0,e=c.length;d<e;++d)c[d].enabled=a;f&&(f.showPoster=!a);return this};this.recordQOS=
function(){for(var a in l)F(a)};this.destroy=function(a,b){B();!0!==b&&this.dispatchEvent(new OT.DestroyedEvent(OT.Event.names.PUBLISHER_DESTROYED,this,a),this.off.bind(this));return this};this.disconnect=function(){for(var a in l)this.cleanupSubscriber(a)};this.cleanupSubscriber=function(a){var b=l[a];clearInterval(u[a]);delete u[a];b&&(b.destroy(),delete l[a],x("disconnect","PeerConnection","subscriberConnection",a))};this.processMessage=function(a,b,c){OT.debug("OT.Publisher.processMessage: Received "+
a+" from "+b.id);OT.debug(c);switch(a){case "unsubscribe":this.cleanupSubscriber(c.content.connection.id);break;default:y.call(this,b).processMessage(a,c)}};this.getImgData=function(){return!n?(OT.error("OT.Publisher.getImgData: Cannot getImgData before the Publisher is publishing."),null):c.imgData};this._={publishToSession:function(a){this.session=a;var b=function(){var b,d;if(this.session){w.set("PublishingToSession");var f=function(a,b){a?(x("publish","Failure","reason","Publish:"+OT.ExceptionCodes.UNABLE_TO_PUBLISH+
":"+a.message),w.attemptingToPublish&&this.trigger("publishComplete",new OT.Error(OT.ExceptionCodes.UNABLE_TO_PUBLISH,a.message))):e=b}.bind(this);m.videoDimensions?(b=Math.min(m.videoDimensions.width,c.videoWidth||640),d=Math.min(m.videoDimensions.height,c.videoHeight||480)):(b=c.videoWidth||640,d=c.videoHeight||480);a._.streamCreate(m&&m.name?m.name:"",OT.VideoOrientation.ROTATED_NORMAL,b,d,m.publishAudio,m.publishVideo,m.frameRate,f)}};if(n)b.call(this);else this.on("initSuccess",b,this);x("publish",
"Attempt","streamType","WebRTC");return this}.bind(this),unpublishFromSession:function(a,b){if(!this.session||a.id!==this.session.id)return OT.warn("The publisher "+this.guid+" is trying to unpublish from a session "+a.id+" it is not attached to ("+(this.session&&this.session.id||"no this.session")+")"),this;a.connected&&this.stream&&a._.streamDestroy(this.stream.id);this.disconnect();this.session=null;w.set("MediaBound");x("unpublish","Success","sessionId",a.id);this._.streamDestroyed(b);return this}.bind(this),
streamDestroyed:function(a){if(0>["reset"].indexOf(a)){var c=new OT.StreamEvent("streamDestroyed",b,a,!0);a=function(){c.isDefaultPrevented()||this.destroy()}.bind(this);this.dispatchEvent(c,a)}}.bind(this),archivingStatus:function(a){s&&s.archive.setArchiving(a);return a}.bind(this)};this.detectDevices=function(){OT.warn("Fixme: Haven't implemented detectDevices")};this.detectMicActivity=function(){OT.warn("Fixme: Haven't implemented detectMicActivity")};this.getEchoCancellationMode=function(){OT.warn("Fixme: Haven't implemented getEchoCancellationMode");
return"fullDuplex"};this.setMicrophoneGain=function(){OT.warn("Fixme: Haven't implemented setMicrophoneGain")};this.getMicrophoneGain=function(){OT.warn("Fixme: Haven't implemented getMicrophoneGain");return 0.5};this.setCamera=function(){OT.warn("Fixme: Haven't implemented setCamera")};this.setMicrophone=function(){OT.warn("Fixme: Haven't implemented setMicrophone")};Object.defineProperties(this,{id:{get:function(){return g},enumerable:!0},element:{get:function(){return f.domElement},enumerable:!0},
guid:{get:function(){return a},enumerable:!0},stream:{get:function(){return b},set:function(a){Q(a)},enumerable:!0},streamId:{get:function(){return e},enumerable:!0},targetElement:{get:function(){return c.domElement}},domId:{get:function(){return g}},session:{get:function(){return h},set:function(a){h=a},enumerable:!0},isWebRTC:{get:function(){return!0}},loading:{get:function(){return f&&f.loading}},videoWidth:{get:function(){return c.videoWidth},enumerable:!0},videoHeight:{get:function(){return c.videoHeight},
enumerable:!0}});Object.defineProperty(this._,"webRtcStream",{get:function(){return k}});this.on("styleValueChanged",function(a,b){if(s)switch(a){case "nameDisplayMode":s.name.setDisplayMode(b);s.backingBar.nameMode=b;break;case "showArchiveStatus":x("showArchiveStatus","styleChange","mode",b?"on":"off"),s.archive.setShowArchiveStatus(b)}},this);w=new OT.PublishingState(function(a){OT.error("Publisher State Change Failed: ",a.message);OT.debug(a)})}else OT.upgradeSystemRequirements()};OT.Publisher.nextId=
OT.$.uuid}(window);
!function(d){OT.Subscriber=function(a,g){var f=OT.$.uuid(),c=a||f,b,e,k,h,l,n,m=g.session,q,r,s,p=OT.$.clone(g),t=new OT.Analytics,v=50,u,C,w,x,F=0;w={timeStamp:OT.$.now()};if(m){OT.$.eventing(this);OT.StylableComponent(this,{nameDisplayMode:"auto",buttonDisplayMode:"auto",backgroundImageURI:null,showArchiveStatus:!0,showMicButton:!0});var z=function(a,b,c,d){t.logEvent({action:a,variation:b,payload_type:c,payload:d,stream_id:h?h.id:null,session_id:m?m.sessionId:null,connection_id:m&&m.connected?
m.connection.connectionId:null,partner_id:m&&m.connected?m.sessionInfo.partnerId:null,widget_id:f,widget_type:"Subscriber"})},G=function(){if(u.subscribing&&m&&m.connected){var a={widget_type:"Subscriber",stream_type:"WebRTC",session_id:m?m.sessionId:null,connectionId:m?m.connection.connectionId:null,media_server_name:m?m.sessionInfo.messagingServer:null,p2pFlag:m?m.sessionInfo.p2pEnabled:!1,partner_id:m?m.apiKey:null,stream_id:h.id,widget_id:f,version:OT.properties.version,duration:parseInt(OT.$.now()-
q,10),remote_connection_id:h.connection.connectionId};n.getStats(w,function(b){var c;if(b)for(c in b)a[c]=b[c];t.logQOS(a)})}},L=function(){!u.subscribing&&e&&(OT.debug("OT.Subscriber.onLoaded"),u.set("Subscribing"),q=OT.$.now(),z("createPeerConnection","Success","pcc|hasRelayCandidates",[parseInt(q-r,10),n&&n.hasRelayCandidates].join("|")),s=setInterval(G,3E4),C&&(C=null,this.subscribeToVideo(!1)),b.loading=!1,M.call(this),this.trigger("subscribeComplete",null,this),this.trigger("loaded",this),z("subscribe",
"Success","streamId",h.id))},K=function(){OT.debug("OT.Subscriber has been disconnected from the Publisher's PeerConnection");u.attemptingToSubscribe?(u.set("Failed"),this.trigger("subscribeComplete",new OT.Error(null,"ClientDisconnected"))):u.subscribing&&u.set("Failed");this.disconnect()},H=function(a,c,d,e){u.attemptingToSubscribe?(z("createPeerConnection","Failure","reason|hasRelayCandidates",["Subscriber PeerConnection Error: "+c,n&&n.hasRelayCandidates].join("|")),u.set("Failed"),this.trigger("subscribeComplete",
new OT.Error(null,c))):u.subscribing&&(u.set("Failed"),this.trigger("error",c));this.disconnect();z("subscribe","Failure","reason",(e?e:"")+":Subscriber PeerConnection Error: "+c);OT.handleJsException("Subscriber PeerConnection Error: "+c,OT.ExceptionCodes.P2P_CONNECTION_FAILED,{session:m,target:this});b&&b.addError("The stream was unable to connect due to a network error.","Make sure your connection isn't blocked by a firewall.")},D=function(a){OT.debug("OT.Subscriber.onRemoteStreamAdded");u.set("BindingRemoteStream");
this.subscribeToAudio(p.subscribeToAudio);var c=C;this.subscribeToVideo(p.subscribeToVideo);C=c;c=new OT.VideoElement;c.setAudioVolume(v);c.on({streamBound:L,loadError:H,error:H},this);c.bindToStream(a);e=b.video=c;e.orientation={width:h.videoDimensions.width,height:h.videoDimensions.height,videoOrientation:h.videoDimensions.orientation};z("createPeerConnection","StreamAdded","","");this.trigger("streamAdded",this)},A=function(a){OT.debug("OT.Subscriber.onStreamRemoved");e.stream===a&&(e.destroy(),
e=null);this.trigger("streamRemoved",this)},I=function(){this.disconnect()},J=function(a){switch(a.changedProperty){case "videoDimensions":e.orientation={width:a.newValue.width,height:a.newValue.height,videoOrientation:a.newValue.orientation};break;case "hasVideo":b&&(b.showPoster=!(h.hasVideo&&p.subscribeToVideo))}},E=function(a){if(!1===a)return"off";a=this.getStyle("buttonDisplayMode");return!1===a?"on":a},M=function(){"off"===this.getStyle("bugDisplayMode")&&z("bugDisplayMode","createChrome",
"mode","off");var a=null;(function(){var b=null;(function O(){n.getAudioOutputLevel(function(c){F=c;a&&(b=null===b?c:0.1*c+0.9*b,a.value=700>b?0:Math.log(b/OT.PeerConnection.AUDIO_OUTPUT_LEVEL_MAX_VALUE)/Math.LN10/1.5+1)});setTimeout(O,20)})()})();a=new OT.Chrome.Meter({});(new OT.Chrome({parent:b.domElement})).set({backingBar:new OT.Chrome.BackingBar({nameMode:this.getStyle("nameDisplayMode"),muteMode:E.call(this,this.getStyle("showMuteButton"))}),name:new OT.Chrome.NamePanel({name:p.name,mode:this.getStyle("nameDisplayMode"),
bugMode:this.getStyle("bugDisplayMode")}),muteButton:new OT.Chrome.MuteButton({muted:p.muted,mode:E.call(this,this.getStyle("showMuteButton"))}),opentokButton:new OT.Chrome.OpenTokButton({mode:this.getStyle("bugDisplayMode")}),archive:new OT.Chrome.Archiving({show:this.getStyle("showArchiveStatus"),archiving:!1}),audioMeter:a}).on({muted:function(){P.call(this,!0)},unmuted:function(){P.call(this,!1)}},this)};this.recordQOS=function(){G()};this.subscribe=function(d){OT.debug("OT.Subscriber: subscribe to "+
d.id);if(u.subscribing)return OT.error("OT.Subscriber.Subscribe: Cannot subscribe, already subscribing."),!1;u.set("Init");if(!d)return OT.error("OT.Subscriber: No stream parameter."),!1;if(h)return OT.error("OT.Subscriber: Already subscribed"),!1;h=d;h.on({updated:J,destroyed:I},this);l=d.connection.id;p.name=p.name||h.name;p.classNames="OT_root OT_subscriber";p.style&&this.setStyle(p.style,null,!0);p.audioVolume&&this.setAudioVolume(p.audioVolume);p.subscribeToAudio=OT.$.castToBoolean(p.subscribeToAudio,
!0);p.subscribeToVideo=OT.$.castToBoolean(p.subscribeToVideo,!0);b=new OT.WidgetView(a,p);c=b.domId;!p.subscribeToVideo&&"Chrome"===OT.$.browser()&&(C=!0,p.subscribeToVideo=!0);r=OT.$.now();if(h.connection.id!==m.connection.id)z("createPeerConnection","Attempt","",""),u.set("ConnectingToPeer"),n=new OT.SubscriberPeerConnection(h.connection,m,h,this,p),n.on({disconnected:K,error:H,remoteStreamAdded:D,remoteStreamRemoved:A},this),n.init();else{z("createPeerConnection","Attempt","","");d=m.getPublisherForStream(h);
if(!d||!d._.webRtcStream)return this.trigger("subscribeComplete",new OT.Error(null,"InvalidStreamID")),this;D.call(this,m.getPublisherForStream(h)._.webRtcStream)}z("subscribe","Attempt","streamId",h.id);return this};this.destroy=function(a,d){"streamDestroyed"===a&&u.attemptingToSubscribe&&this.trigger("subscribeComplete",new OT.Error(null,"InvalidStreamID"));clearInterval(s);s=null;this.disconnect();k&&(k.destroy(),k=null);b&&(b.destroy(),b=null);h&&!h.destroyed&&z("unsubscribe",null,"streamId",
h.id);p=m=h=c=null;!0!==d&&this.dispatchEvent(new OT.DestroyedEvent(OT.Event.names.SUBSCRIBER_DESTROYED,this,a),this.off.bind(this));return this};this.disconnect=function(){u.set("NotSubscribing");e&&(e.destroy(),e=null);n&&(n.destroy(),n=null,z("disconnect","PeerConnection","streamId",h.id))};this.processMessage=function(a,b,c){OT.debug("OT.Subscriber.processMessage: Received "+a+" message from "+b.id);OT.debug(c);l!==b.id&&(l=b.id);n&&n.processMessage(a,c)};this.disableVideo=function(a){if(a)if("auto"===
x)OT.info("Video has been re-enabled");else{OT.info("Video was not re-enabled because it was manually disabled");return}else OT.warn("Due to high packet loss and low bandwidth, video has been disabled");this.subscribeToVideo(a,"auto");this.dispatchEvent(new OT.Event(a?"videoEnabled":"videoDisabled"));z("updateQuality","video",a?"videoEnabled":"videoDisabled",!0)};this.getImgData=function(){return!this.subscribing?(OT.error("OT.Subscriber.getImgData: Cannot getImgData before the Subscriber is subscribing."),
null):e.imgData};this.setAudioVolume=function(a){a=parseInt(a,10);if(isNaN(a))return OT.error("OT.Subscriber.setAudioVolume: value should be an integer between 0 and 100"),this;v=Math.max(0,Math.min(100,a));v!==a&&OT.warn("OT.Subscriber.setAudioVolume: value should be an integer between 0 and 100");p.muted&&0<v&&(p.premuteVolume=a,P.call(this,!1));e&&e.setAudioVolume(v);return this};this.getAudioVolume=function(){return p.muted?0:e?e.getAudioVolume():v};this.subscribeToAudio=function(a){a=OT.$.castToBoolean(a,
!0);n&&(n.subscribeToAudio(a&&!p.subscribeMute),m&&(h&&a!==p.subscribeToAudio)&&h.setChannelActiveState("audio",a&&!p.subscribeMute));p.subscribeToAudio=a;return this};var P=function(a){k.muteButton.muted=a;if(a!==p.mute){if(0<=d.navigator.userAgent.toLowerCase().indexOf("chrome"))p.subscribeMute=p.muted=a,this.subscribeToAudio(p.subscribeToAudio);else if(a)p.premuteVolume=this.getAudioVolume(),p.muted=!0,this.setAudioVolume(0);else if(p.premuteVolume||p.audioVolume)p.muted=!1,this.setAudioVolume(p.premuteVolume||
p.audioVolume);p.mute=p.mute}};this.subscribeToVideo=function(a,c){if(C&&!0===a)C=!1;else{var d=OT.$.castToBoolean(a,!0);b&&(b.showPoster=!(d&&h.hasVideo),d&&b.video&&(b.loading=d,b.video.whenTimeIncrements(function(){b.loading=!1},this)));n&&(n.subscribeToVideo(d),m&&(h&&(d!==p.subscribeToVideo||c!==x))&&h.setChannelActiveState("video",d,c));p.subscribeToVideo=d;x=c;return this}};Object.defineProperties(this,{id:{get:function(){return c},enumerable:!0},element:{get:function(){return b.domElement},
enumerable:!0},widgetId:{get:function(){return f}},stream:{get:function(){return h},enumerable:!0},streamId:{get:function(){return!h?null:h.id},enumerable:!0},targetElement:{get:function(){return e?e.domElement:null}},subscribing:{get:function(){return u.subscribing},enumerable:!0},isWebRTC:{get:function(){return!0}},loading:{get:function(){return b&&b.loading}},session:{get:function(){return m}},videoWidth:{get:function(){return e.videoWidth},enumerable:!0},videoHeight:{get:function(){return e.videoHeight},
enumerable:!0},audioOutputLevel:{get:function(){return F},enumerable:!0}});this.restrictFrameRate=function(a){OT.debug("OT.Subscriber.restrictFrameRate("+a+")");z("restrictFrameRate",a.toString(),"streamId",h.id);m.sessionInfo.p2pEnabled&&OT.warn("OT.Subscriber.restrictFrameRate: Cannot restrictFrameRate on a P2P session");"boolean"!==typeof a?OT.error("OT.Subscriber.restrictFrameRate: expected a boolean value got a "+typeof a):h.setRestrictFrameRate(a);return this};this.on("styleValueChanged",function(a,
b){if(k)switch(a){case "nameDisplayMode":k.name.setDisplayMode(b);break;case "showArchiveStatus":k.archive.setShowArchiveStatus(b)}},this);this._={archivingStatus:function(a){k&&k.archive.setArchiving(a)}};u=new OT.SubscribingState(function(a){OT.error("Subscriber State Change Failed: ",a.message);OT.debug(a)})}else OT.handleJsException("Subscriber must be passed a session option",2E3,{session:m,target:this})}}(window);
!function(){var d,a,g,f;OT.SessionInfo=function(a){var c=a[0];OT.log("SessionInfo Response:");OT.log(a);this.sessionId=c.session_id;this.partnerId=c.partner_id;this.sessionStatus=c.session_status;this.messagingServer=c.messaging_server_url;this.messagingURL=c.messaging_url;this.symphonyAddress=c.symphony_address;this.p2pEnabled=c.properties&&c.properties.p2p&&c.properties.p2p.preference&&"enabled"===c.properties.p2p.preference.value;this.iceServers=c.ice_servers?f(c.ice_servers):[];0===this.iceServers.length&&
(OT.warn("SessionInfo contained not ICE Servers, using the default"),this.iceServers=[{url:"stun:stun.l.google.com:19302"}])};OT.SessionInfo.get=function(b,c,f){var h=OT.properties.apiURLSSL+"/session/"+b.id+"?extended\x3dtrue",l=OT.$.now();b.logEvent("getSessionInfo","Attempt","api_url",OT.properties.apiURLSSL);OT.$.getJSON(h,{headers:{"X-TB-TOKEN-AUTH":b.token,"X-TB-VERSION":1}},function(h,m){if(h)console.log("getJSON said error:",h),g(b,f,new OT.Error(h.target&&h.target.status||h.code,h.message||
"Could not connect to the OpenTok API Server."),m);else{b.logEvent("Instrumentation",null,"gsi",OT.$.now()-l);var q=d(m);!1===q?a(b,c,m):g(b,f,q,JSON.stringify(m))}})};var c={};c["404"]=OT.ExceptionCodes.INVALID_SESSION_ID;c["409"]=OT.ExceptionCodes.INVALID_SESSION_ID;c["400"]=OT.ExceptionCodes.INVALID_SESSION_ID;c["403"]=OT.ExceptionCodes.AUTHENTICATION_ERROR;d=function(a){if(Array.isArray(a)){a=a.filter(function(a){return null!=a.error});if(0===a.length)return!1;var d=a[0].error.code;c[d.toString()]&&
(d=c[d]);return{code:d,message:a[0].error.errorMessage&&a[0].error.errorMessage.message}}return{code:null,message:"Unknown error: getSessionInfo JSON response was badly formed"}};a=function(a,c,d){a.logEvent("getSessionInfo","Success","api_url",OT.properties.apiURLSSL);c(new OT.SessionInfo(d))};g=function(a,c,d,f){a.logEvent("Connect","Failure","errorMessage","GetSessionInfo:"+d.code+":"+d.message+":"+f);c(d,a)};f=function(a){if(!a)return[];var c="undefined"!==typeof navigator&&navigator.userAgent.match(/(Firefox)\/([0-9]+\.[0-9]+)/),
d=c?parseFloat(c[2],10):void 0,f;return a.map(function(a){if("turn:"!==a.url.trim().substr(0,5))return a;if(null!==c){if(25>d)return{url:a.url.replace("turn:","stun:")};27>d&&-1!==a.url.indexOf("?")&&(a.url=a.url.trim().split("?")[0])}f=a.url.trim().split(/[:@]/);return{username:f[1],credential:a.credential,url:f[0]+":"+f[2]}})}}(window);
!function(){OT.Capabilities=function(d){this.publish=-1!==d.indexOf("publish")?1:0;this.subscribe=-1!==d.indexOf("subscribe")?1:0;this.forceUnpublish=-1!==d.indexOf("forceunpublish")?1:0;this.forceDisconnect=-1!==d.indexOf("forcedisconnect")?1:0;this.supportsWebRTC=OT.$.supportsWebRTC()?1:0;this.permittedTo=function(a){return this.hasOwnProperty(a)&&1===this[a]}}}(window);
!function(d){OT.Session=function(a,g){if(OT.checkSystemRequirements()){null==g&&(g=a,a=null);var f=!0,c=a,b,e=g,k,h=OT.$.uuid(),l,n=new OT.Analytics,m,q,r,s,p,t,v,u,C,w,x,F,z,G,L,K,H,D,A;OT.$.eventing(this);var I=OT.$.statable(this,["disconnected","connecting","connected","disconnecting"],"disconnected");this.connections=new OT.Collection;this.streams=new OT.Collection;this.archives=new OT.Collection;var J=this,E={};d.setInterval(function(){for(var a=OT.subscribers.where(function(){return!0}),b=[],
c=[],d=0;d<a.length;d++){var e=a[d],f=e.stream.id;e.audioOutputLevel>0.2*OT.PeerConnection.AUDIO_OUTPUT_LEVEL_MAX_VALUE?f in E?E[f].talking?E[f].timestamp=Date.now():2500<Date.now()-E[f].timestamp&&(E[f].talking=!0,b.push(E[f].subscriber)):E[f]={subscriber:e,timestamp:Date.now(),talking:!1}:f in E&&(e=E[f],5E3<Date.now()-e.timestamp&&(c.push(e.subscriber),delete E[f]));b.length&&J.trigger("startedToTalk",{subscribers:b});c.length&&J.trigger("stoppedToTalk",{subscribers:c})}},100);m=function(a,b){I("disconnected");
OT.error(a);this.trigger("sessionConnectFailed",new OT.Error(b||OT.ExceptionCodes.CONNECT_FAILED,a));OT.handleJsException(a,b||OT.ExceptionCodes.CONNECT_FAILED,{session:this})};q=function(a){var b=a.reason;"networkTimedout"===b?(b="networkDisconnected",this.logEvent("Connect","TimeOutDisconnect","reason",a.reason)):this.logEvent("Connect","Disconnected","reason",a.reason);var c=new OT.SessionDisconnectEvent("sessionDisconnected",b);x.call(this);F.call(this,b);a=function(){z.call(this,c.reason);c.isDefaultPrevented()||
G.call(this,c.reason)}.bind(this);this.dispatchEvent(c,a)};r=function(a){a.id.match(/^symphony\./)||this.dispatchEvent(new OT.ConnectionEvent(OT.Event.names.CONNECTION_CREATED,a))};s=function(a,b){a.id.match(/^symphony\./)||a.id!==k.id&&this.dispatchEvent(new OT.ConnectionEvent(OT.Event.names.CONNECTION_DESTROYED,a,b))};p=function(a){a.connection.id!==this.connection.id&&this.dispatchEvent(new OT.StreamEvent(OT.Event.names.STREAM_CREATED,a,null,!1))};t=function(a){var b=a.target,c=a.changedProperty,
d=a.newValue;"orientation"===c&&(c="videoDimensions",d={width:d.width,height:d.height});this.dispatchEvent(new OT.StreamPropertyChangedEvent(OT.Event.names.STREAM_PROPERTY_CHANGED,b,c,a.oldValue,d))};v=function(a,b){if(a.connection.id===this.connection.id)OT.publishers.where({streamId:a.id}).forEach(function(a){a._.unpublishFromSession(this,b)}.bind(this));else{var c=new OT.StreamEvent("streamDestroyed",a,b,!0),d=function(){c.isDefaultPrevented()||OT.subscribers.where({streamId:a.id}).forEach(function(a){a.session.id===
this.id&&a.stream&&a.destroy("streamDestroyed")},this)}.bind(this);this.dispatchEvent(c,d)}};u=function(a){this.dispatchEvent(new OT.ArchiveEvent("archiveStarted",a))};C=function(a){this.dispatchEvent(new OT.ArchiveEvent("archiveDestroyed",a))};w=function(a){var b=a.target,c=a.newValue;"status"===a.changedProperty&&"stopped"===c?this.dispatchEvent(new OT.ArchiveEvent("archiveStopped",b)):this.dispatchEvent(new OT.ArchiveEvent("archiveUpdated",b))};x=function(){b=null;I("disconnected");this.connections.destroy();
this.streams.destroy();this.archives.destroy()};F=function(a){OT.publishers.where({session:this}).forEach(function(b){b.disconnect(a)});OT.subscribers.where({session:this}).forEach(function(a){a.disconnect()})};z=function(a){OT.publishers.where({session:this}).forEach(function(b){b._.streamDestroyed(a)})};G=function(a){OT.subscribers.where({session:this}).forEach(function(b){b.destroy(a)})};L=function(){OT.debug("OT.Session: connecting to Raptor");var a=OT.properties.messagingProtocol+"://"+this.sessionInfo.messagingServer+
":"+OT.properties.messagingPort+"/rumorwebsocketsv2";k=new OT.Raptor.Socket(h,a,OT.properties.symphonyAddresss||"symphony."+this.sessionInfo.messagingServer,OT.SessionDispatcher(this));var c=[a,navigator.userAgent,OT.properties.version,d.externalHost?"yes":"no"];k.connect(b,this.sessionInfo,function(a,b){a?(c.splice(0,0,a.message),this.logEvent("Connect","Failure","reason|webSocketServerUrl|userAgent|sdkVersion|chromeFrame",c.map(function(a){return a.replace("|","\\|")}).join("|")),m.call(this,a.message,
a.code)):(OT.debug("OT.Session: Received session state from Raptor",b),I("connected"),this.logEvent("Connect","Success","webSocketServerUrl|userAgent|sdkVersion|chromeFrame",c.map(function(a){return a.replace("|","\\|")}).join("|"),{connectionId:this.connection.id}),this.connection.on("destroyed",q,this),this.connections.on({add:r,remove:s},this),this.streams.on({add:p,remove:v,update:t},this),this.archives.on({add:u,remove:C,update:w},this),this.dispatchEvent(new OT.SessionConnectEvent(OT.Event.names.SESSION_CONNECTED),
function(){this.connections._triggerAddEvents();this.streams._triggerAddEvents();this.archives._triggerAddEvents()}.bind(this)))}.bind(this))};K=function(){this.is("connecting")&&OT.SessionInfo.get(this,H.bind(this),function(a){m.call(this,a.message+(a.code?" ("+a.code+")":""),a.code)}.bind(this))};H=function(a){this.is("connecting")&&(this.sessionInfo=a,this.sessionInfo.partnerId&&this.sessionInfo.partnerId!==c?(c=this.sessionInfo.partnerId,this.logEvent("Connect","Failure","reason","GetSessionInfo:"+
OT.ExceptionCodes.AUTHENTICATION_ERROR+":Authentication Error: The API key does not match the token or session."),m.call(this,"Authentication Error: The API key does not match the token or session.",OT.ExceptionCodes.AUTHENTICATION_ERROR)):L.call(this))};D=function(a){return this.capabilities.permittedTo(a)}.bind(this);A=function(a,b,c){OT.dispatchError(a,b,c,this)}.bind(this);this.logEvent=function(a,b,d,f,g){a={action:a,variation:b,payload_type:d,payload:f,session_id:e,partner_id:c,widget_id:h,
widget_type:"Controller"};this.connection&&this.connection.id?l=a.connection_id=this.connection.id:l&&(a.connection_id=l);g&&(a=OT.$.extend(g,a));n.logEvent(a)};this.connect=function(g){if(null==a&&1<arguments.length&&("string"===typeof arguments[0]||"number"===typeof arguments[0])&&"string"===typeof arguments[1])c=g.toString(),g=arguments[1];var k=arguments[arguments.length-1];if(this.is("connecting","connected"))return OT.warn("OT.Session: Cannot connect, the session is already "+this.state),this;
x.call(this);I("connecting");b=!OT.$.isFunction(g)&&g;f?f=!1:h=OT.$.uuid();k&&OT.$.isFunction(k)&&(this.once("sessionConnected",k.bind(null,null)),this.once("sessionConnectFailed",k));if(null==c||OT.$.isFunction(c))return setTimeout(m.bind(this,"API Key is undefined. You must pass an API Key to initSession.",OT.ExceptionCodes.AUTHENTICATION_ERROR)),this;if(!e)return setTimeout(m.bind(this,"SessionID is undefined. You must pass a sessionID to initSession.",OT.ExceptionCodes.INVALID_SESSION_ID)),this;
c=c.toString();0===OT.APIKEY.length&&(OT.APIKEY=c);this.logEvent("Connect","Attempt","userAgent|sdkVersion|chromeFrame",[navigator.userAgent,OT.properties.version,d.externalHost?"yes":"no"].map(function(a){return a.replace("|","\\|")}).join("|"));K.call(this);return this};this.disconnect=function(){k&&k.isNot("disconnected")?(I("disconnecting"),k.disconnect()):x.call(this)};this.destroy=function(){this.streams.destroy();this.connections.destroy();this.archives.destroy();this.disconnect()};this.publish=
function(a,b,d){"function"===typeof a&&(d=a,a=void 0);"function"===typeof b&&(d=b,b=void 0);if(this.isNot("connected"))return n.logError(1010,"OT.exception","We need to be connected before you can publish",null,{action:"publish",variation:"Failure",payload_type:"reason",payload:"We need to be connected before you can publish",session_id:e,partner_id:c,widgetId:h,widget_type:"Controller"}),d&&OT.$.isFunction(d)&&A(OT.ExceptionCodes.NOT_CONNECTED,"We need to be connected before you can publish",d),
null;if(!D("publish"))return this.logEvent("publish","Failure","reason","This token does not allow publishing. The role must be at least `publisher` to enable this functionality"),A(OT.ExceptionCodes.UNABLE_TO_PUBLISH,"This token does not allow publishing. The role must be at least `publisher` to enable this functionality",d),null;if(!a||"string"===typeof a||a.nodeType===Node.ELEMENT_NODE)a=OT.initPublisher(a,b);else if(a instanceof OT.Publisher)"session"in a&&(a.session&&"sessionId"in a.session)&&
(a.session.sessionId===this.sessionId?OT.warn("Cannot publish "+a.guid+" again to "+this.sessionId+". Please call session.unpublish(publisher) first."):OT.warn("Cannot publish "+a.guid+" publisher already attached to "+a.session.sessionId+". Please call session.unpublish(publisher) first."));else{A(OT.ExceptionCodes.UNABLE_TO_PUBLISH,"Session.publish :: First parameter passed in is neither a string nor an instance of the Publisher",d);return}a.once("publishComplete",function(a){a?A(OT.ExceptionCodes.UNABLE_TO_PUBLISH,
"Session.publish :: "+a.message,d):d&&OT.$.isFunction(d)&&d.apply(null,arguments)});a._.publishToSession(this);return a};this.unpublish=function(a){a?a._.unpublishFromSession(this,"unpublished"):OT.error("OT.Session.unpublish: publisher parameter missing.")};this.subscribe=function(a,b,c,d){if(!this.connection||!this.connection.connectionId)A(OT.ExceptionCodes.UNABLE_TO_SUBSCRIBE,"Session.subscribe :: Connection required to subscribe",d);else if(a){if(a.hasOwnProperty("streamId"))return"function"===
typeof b&&(d=b,b=void 0),"function"===typeof c&&(d=c,c=void 0),b=new OT.Subscriber(b,OT.$.extend(c||{},{session:this})),b.once("subscribeComplete",function(a){a?A(OT.ExceptionCodes.UNABLE_TO_SUBSCRIBE,"Session.subscribe :: "+a.message,d):d&&OT.$.isFunction(d)&&d.apply(null,arguments)}),OT.subscribers.add(b),b.subscribe(a),b;A(OT.ExceptionCodes.UNABLE_TO_SUBSCRIBE,"Session.subscribe :: invalid stream object",d)}else A(OT.ExceptionCodes.UNABLE_TO_SUBSCRIBE,"Session.subscribe :: stream cannot be null",
d)};this.unsubscribe=function(a){if(!a)throw OT.error("OT.Session.unsubscribe: subscriber cannot be null"),Error("OT.Session.unsubscribe: subscriber cannot be null");if(!a.stream)return OT.warn("OT.Session.unsubscribe:: tried to unsubscribe a subscriber that had no stream"),!1;OT.debug("OT.Session.unsubscribe: subscriber "+a.id);a.destroy();return!0};this.getSubscribersForStream=function(a){return OT.subscribers.where({streamId:a.id})};this.getPublisherForStream=function(a){if("string"!==typeof a)if("object"===
typeof a&&a&&a.hasOwnProperty("id"))a=a.id;else throw OT.error("Session.getPublisherForStream :: Invalid stream type"),Error("Session.getPublisherForStream :: Invalid stream type");return OT.publishers.where({streamId:a})[0]};this._={jsepCandidateP2p:function(a,b,c){return k.jsepCandidateP2p(a,b,c)}.bind(this),jsepCandidate:function(a,b){return k.jsepCandidate(a,b)}.bind(this),jsepOffer:function(a,b){return k.jsepOffer(a,b)}.bind(this),jsepOfferP2p:function(a,b,c){return k.jsepOfferP2p(a,b,c)}.bind(this),
jsepAnswer:function(a,b){return k.jsepAnswer(a,b)}.bind(this),jsepAnswerP2p:function(a,b,c){return k.jsepAnswerP2p(a,b,c)}.bind(this),dispatchSignal:function(a,b,c){a=new OT.SignalEvent(b,c,a);a.target=this;this.trigger(OT.Event.names.SIGNAL,a);b&&this.dispatchEvent(a)}.bind(this),subscriberCreate:function(a,b,c,d){return k.subscriberCreate(a.id,b.widgetId,c,d)}.bind(this),subscriberDestroy:function(a,b){return k.subscriberDestroy(a.id,b.widgetId)}.bind(this),subscriberUpdate:function(a,b,c){return k.subscriberUpdate(a.id,
b.widgetId,c)}.bind(this),subscriberChannelUpdate:function(a,b,c,d){return k.subscriberChannelUpdate(a.id,b.widgetId,c.id,d)}.bind(this),streamCreate:function(a,b,c,d,e,f,g,h){k.streamCreate(a,b,c,d,e,f,g,OT.Config.get("bitrates","min",OT.APIKEY),OT.Config.get("bitrates","max",OT.APIKEY),h)}.bind(this),streamDestroy:function(a){k.streamDestroy(a)}.bind(this),streamChannelUpdate:function(a,b,c){k.streamChannelUpdate(a.id,b.id,c)}.bind(this)};this.signal=function(a,b){var c=a,d=b;OT.$.isFunction(c)&&
(d=c,c=null);this.isNot("connected")?A(500,"Unable to send signal - you are not connected to the session.",d):(k.signal(c,d),a&&(a.data&&"string"!==typeof a.data)&&OT.warn("Signaling of anything other than Strings is deprecated. Please update the data property to be a string."),this.logEvent("signal","send","type",a&&a.data?typeof a.data:"null"))};this.forceDisconnect=function(a,b){this.isNot("connected")?A(OT.ExceptionCodes.NOT_CONNECTED,"Cannot call forceDisconnect(). You are not connected to the session.",
b):D("forceDisconnect")?k.forceDisconnect("string"===typeof a?a:a.id,function(a){a?A(OT.ExceptionCodes.UNABLE_TO_FORCE_DISCONNECT,"This token does not allow forceDisconnect. The role must be at least `moderator` to enable this functionality",b):b&&OT.$.isFunction(b)&&b.apply(null,arguments)}):A(OT.ExceptionCodes.UNABLE_TO_FORCE_DISCONNECT,"This token does not allow forceDisconnect. The role must be at least `moderator` to enable this functionality",b)};this.forceUnpublish=function(a,b){if(this.isNot("connected"))A(OT.ExceptionCodes.NOT_CONNECTED,
"Cannot call forceUnpublish(). You are not connected to the session.",b);else if(D("forceUnpublish")){var c="string"===typeof a?this.streams.get(a):a;k.forceUnpublish(c.id,function(a){a?A(OT.ExceptionCodes.UNABLE_TO_FORCE_UNPUBLISH,"This token does not allow forceUnpublish. The role must be at least `moderator` to enable this functionality",b):b&&OT.$.isFunction(b)&&b.apply(null,arguments)})}else A(OT.ExceptionCodes.UNABLE_TO_FORCE_UNPUBLISH,"This token does not allow forceUnpublish. The role must be at least `moderator` to enable this functionality",
b)};this.getStateManager=function(){OT.warn("Fixme: Have not implemented session.getStateManager")};OT.$.defineGetters(this,{apiKey:function(){return c},token:function(){return b},connected:function(){return this.is("connected")},connection:function(){return k&&k.id?this.connections.get(k.id):null},sessionId:function(){return e},id:function(){return e},capabilities:function(){var a=this.connection;return a?a.permissions:new OT.Capabilities([])}.bind(this)},!0)}else OT.upgradeSystemRequirements()}}(window);
!function(){var d=document.createElement("link");d.type="text/css";d.media="screen";d.rel="stylesheet";d.href=OT.properties.cssURL;(document.head||document.getElementsByTagName("head")[0]).appendChild(d)}(window);!function(){"function"===typeof define&&define.amd&&define("TB",[],function(){return TB})}(window);